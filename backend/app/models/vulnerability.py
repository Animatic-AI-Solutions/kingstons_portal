"""
Pydantic models for Vulnerabilities Product Owners API.

This module defines the data models for managing vulnerability records associated with product owners
in the Kingston's Portal wealth management system.

Models:
- VulnerabilityProductOwnerBase: Base model with common fields and validation
- VulnerabilityProductOwnerCreate: Model for creating new vulnerability records
- VulnerabilityProductOwnerUpdate: Model for updating existing records (all fields optional)
- VulnerabilityProductOwner: Complete model returned from the API with database fields

Validation Rules:
- product_owner_id: Must be positive integer (> 0)
- description: Required, 1-500 characters, cannot be empty/whitespace
- adjustments: Optional, max 1000 characters
- diagnosed: Boolean field (default False)
- status: Must be one of "Active", "Resolved", "Monitoring", "Inactive"
- notes: Optional, max 2000 characters
"""

from pydantic import BaseModel, ConfigDict, Field, field_validator
from typing import Optional
from datetime import datetime


# Valid status values for vulnerabilities
VALID_VULNERABILITY_STATUSES = ["Active", "Resolved", "Monitoring", "Inactive"]


# =============================================================================
# Shared Validator Functions
# =============================================================================


def sanitize_string(v: str) -> str:
    """
    Sanitize a string by removing null bytes.

    PostgreSQL doesn't support null bytes (0x00) in text fields,
    so we strip them to prevent database errors.

    Args:
        v: The string value to sanitize

    Returns:
        The sanitized string with null bytes removed
    """
    if v is None:
        return None
    if isinstance(v, str):
        return v.replace('\x00', '')
    return v


def validate_description_field(v: str, required: bool = True) -> str:
    """
    Shared validator for description field.

    Args:
        v: The description value to validate
        required: Whether the field is required (True for create, False for update)

    Returns:
        The trimmed and sanitized description string, or None for optional empty values

    Raises:
        ValueError: If description is empty/whitespace when required, or exceeds max length
    """
    if v is None:
        if required:
            raise ValueError('Description is required')
        return None
    if isinstance(v, str):
        # Check length BEFORE sanitization to prevent bypass via null bytes
        if len(v) > 500:
            raise ValueError('Description must be 500 characters or less')
        v = sanitize_string(v)
        stripped = v.strip()
        if not stripped:
            if required:
                raise ValueError('Description cannot be empty or whitespace')
            return None
        return stripped
    return v


def validate_vulnerability_status_field(v: str, required: bool = True) -> str:
    """
    Shared validator for status field.

    Args:
        v: The status value to validate
        required: Whether the field is required

    Returns:
        The validated status string

    Raises:
        ValueError: If status is not in VALID_VULNERABILITY_STATUSES
    """
    if v is None:
        return None
    if v not in VALID_VULNERABILITY_STATUSES:
        raise ValueError(f'Status must be one of: {", ".join(VALID_VULNERABILITY_STATUSES)}')
    return v


def sanitize_text_field(v: str) -> Optional[str]:
    """
    Shared sanitizer for optional text fields.

    Removes null bytes which PostgreSQL doesn't support.

    Args:
        v: The text value to sanitize

    Returns:
        The sanitized text or None
    """
    if v is None:
        return None
    if isinstance(v, str):
        return sanitize_string(v)
    return v


class VulnerabilityProductOwnerBase(BaseModel):
    """
    Base model for vulnerability product owner data with validation.

    Attributes:
        product_owner_id: Foreign key reference to product_owners table (required, must be > 0)
        description: Description of the vulnerability (required, 1-500 chars)
        adjustments: Adjustments made to accommodate the vulnerability (optional, max 1000 chars)
        diagnosed: Whether the vulnerability has been officially diagnosed (default False)
        status: Current status of the vulnerability (default: "Active")
        notes: Additional notes about the vulnerability (optional, max 2000 chars)
    """
    product_owner_id: int = Field(
        ...,
        gt=0,
        description="Foreign key to product_owners table (must be positive)"
    )
    description: str = Field(
        ...,
        min_length=1,
        max_length=500,
        description="Description of the vulnerability (required, 1-500 chars)"
    )
    adjustments: Optional[str] = Field(
        default=None,
        max_length=1000,
        description="Adjustments made to accommodate the vulnerability"
    )
    diagnosed: bool = Field(
        default=False,
        description="Whether the vulnerability has been officially diagnosed"
    )
    status: str = Field(
        default="Active",
        description="Status: Active, Resolved, Monitoring, or Inactive"
    )
    notes: Optional[str] = Field(
        default=None,
        max_length=2000,
        description="Additional notes about the vulnerability"
    )

    model_config = ConfigDict(
        from_attributes=True
    )

    @field_validator('description', mode='before')
    @classmethod
    def validate_description(cls, v):
        """Validate that description is not empty or whitespace-only."""
        return validate_description_field(v, required=True)

    @field_validator('status')
    @classmethod
    def validate_status(cls, v):
        """Validate that status is one of the allowed values."""
        return validate_vulnerability_status_field(v, required=True)

    @field_validator('adjustments', 'notes', mode='before')
    @classmethod
    def sanitize_text_fields(cls, v):
        """Sanitize optional text fields by removing null bytes."""
        return sanitize_text_field(v)


class VulnerabilityProductOwnerCreate(VulnerabilityProductOwnerBase):
    """
    Model for creating a new vulnerability record.

    Inherits all fields and validation from VulnerabilityProductOwnerBase.
    Used for POST requests to create new vulnerability records.
    """
    pass


class VulnerabilityProductOwnerUpdate(BaseModel):
    """
    Model for updating an existing vulnerability record.

    All fields are optional to support partial updates (PATCH-like behavior).
    Only fields provided in the request will be updated.

    Attributes:
        description: Description of the vulnerability (1-500 chars if provided)
        adjustments: Adjustments made to accommodate the vulnerability
        diagnosed: Whether the vulnerability has been officially diagnosed
        status: Current status (must be valid enum value if provided)
        notes: Additional notes about the vulnerability
    """
    description: Optional[str] = Field(
        default=None,
        min_length=1,
        max_length=500,
        description="Description of the vulnerability"
    )
    adjustments: Optional[str] = Field(
        default=None,
        max_length=1000,
        description="Adjustments made to accommodate the vulnerability"
    )
    diagnosed: Optional[bool] = Field(
        default=None,
        description="Whether the vulnerability has been officially diagnosed"
    )
    status: Optional[str] = Field(
        default=None,
        description="Status: Active, Resolved, Monitoring, or Inactive"
    )
    notes: Optional[str] = Field(
        default=None,
        max_length=2000,
        description="Additional notes about the vulnerability"
    )

    model_config = ConfigDict(
        from_attributes=True
    )

    @field_validator('description', mode='before')
    @classmethod
    def validate_description(cls, v):
        """Validate description if provided - cannot be empty/whitespace."""
        return validate_description_field(v, required=False)

    @field_validator('status')
    @classmethod
    def validate_status(cls, v):
        """Validate status if provided - must be valid enum value."""
        return validate_vulnerability_status_field(v, required=False)

    @field_validator('adjustments', 'notes', mode='before')
    @classmethod
    def sanitize_text_fields(cls, v):
        """Sanitize optional text fields by removing null bytes."""
        return sanitize_text_field(v)


class VulnerabilityProductOwnerInDBBase(BaseModel):
    """
    Model representing vulnerability record as stored in database.

    Includes auto-generated fields like id and created_at.
    """
    id: int
    product_owner_id: int
    description: Optional[str] = None
    adjustments: Optional[str] = None
    diagnosed: bool = False
    status: Optional[str] = "Active"
    notes: Optional[str] = None
    created_at: datetime
    date_recorded: Optional[datetime] = None

    model_config = ConfigDict(
        from_attributes=True
    )


class VulnerabilityProductOwner(VulnerabilityProductOwnerInDBBase):
    """
    Complete vulnerability product owner model returned to frontend.

    Includes all database fields plus any computed fields.
    Used as the response model for API endpoints.
    """
    pass


# =============================================================================
# Vulnerability Special Relationships Models
# =============================================================================


class VulnerabilitySpecialRelationshipBase(BaseModel):
    """
    Base model for vulnerability special relationship data with validation.

    Attributes:
        special_relationship_id: Foreign key reference to special_relationships table (required, must be > 0)
        description: Description of the vulnerability (required, 1-500 chars)
        adjustments: Adjustments made to accommodate the vulnerability (optional, max 1000 chars)
        diagnosed: Whether the vulnerability has been officially diagnosed (default False)
        status: Current status of the vulnerability (default: "Active")
        notes: Additional notes about the vulnerability (optional, max 2000 chars)
    """
    special_relationship_id: int = Field(
        ...,
        gt=0,
        description="Foreign key to special_relationships table (must be positive)"
    )
    description: str = Field(
        ...,
        min_length=1,
        max_length=500,
        description="Description of the vulnerability (required, 1-500 chars)"
    )
    adjustments: Optional[str] = Field(
        default=None,
        max_length=1000,
        description="Adjustments made to accommodate the vulnerability"
    )
    diagnosed: bool = Field(
        default=False,
        description="Whether the vulnerability has been officially diagnosed"
    )
    status: str = Field(
        default="Active",
        description="Status: Active, Resolved, Monitoring, or Inactive"
    )
    notes: Optional[str] = Field(
        default=None,
        max_length=2000,
        description="Additional notes about the vulnerability"
    )

    model_config = ConfigDict(
        from_attributes=True
    )

    @field_validator('description', mode='before')
    @classmethod
    def validate_description(cls, v):
        """Validate that description is not empty or whitespace-only."""
        return validate_description_field(v, required=True)

    @field_validator('status')
    @classmethod
    def validate_status(cls, v):
        """Validate that status is one of the allowed values."""
        return validate_vulnerability_status_field(v, required=True)

    @field_validator('adjustments', 'notes', mode='before')
    @classmethod
    def sanitize_text_fields(cls, v):
        """Sanitize optional text fields by removing null bytes."""
        return sanitize_text_field(v)


class VulnerabilitySpecialRelationshipCreate(VulnerabilitySpecialRelationshipBase):
    """
    Model for creating a new vulnerability record for a special relationship.

    Inherits all fields and validation from VulnerabilitySpecialRelationshipBase.
    Used for POST requests to create new vulnerability records.
    """
    pass


class VulnerabilitySpecialRelationshipUpdate(BaseModel):
    """
    Model for updating an existing vulnerability record for a special relationship.

    All fields are optional to support partial updates (PATCH-like behavior).
    Only fields provided in the request will be updated.

    Attributes:
        description: Description of the vulnerability (1-500 chars if provided)
        adjustments: Adjustments made to accommodate the vulnerability
        diagnosed: Whether the vulnerability has been officially diagnosed
        status: Current status (must be valid enum value if provided)
        notes: Additional notes about the vulnerability
    """
    description: Optional[str] = Field(
        default=None,
        min_length=1,
        max_length=500,
        description="Description of the vulnerability"
    )
    adjustments: Optional[str] = Field(
        default=None,
        max_length=1000,
        description="Adjustments made to accommodate the vulnerability"
    )
    diagnosed: Optional[bool] = Field(
        default=None,
        description="Whether the vulnerability has been officially diagnosed"
    )
    status: Optional[str] = Field(
        default=None,
        description="Status: Active, Resolved, Monitoring, or Inactive"
    )
    notes: Optional[str] = Field(
        default=None,
        max_length=2000,
        description="Additional notes about the vulnerability"
    )

    model_config = ConfigDict(
        from_attributes=True
    )

    @field_validator('description', mode='before')
    @classmethod
    def validate_description(cls, v):
        """Validate description if provided - cannot be empty/whitespace."""
        return validate_description_field(v, required=False)

    @field_validator('status')
    @classmethod
    def validate_status(cls, v):
        """Validate status if provided - must be valid enum value."""
        return validate_vulnerability_status_field(v, required=False)

    @field_validator('adjustments', 'notes', mode='before')
    @classmethod
    def sanitize_text_fields(cls, v):
        """Sanitize optional text fields by removing null bytes."""
        return sanitize_text_field(v)


class VulnerabilitySpecialRelationshipInDBBase(BaseModel):
    """
    Model representing vulnerability record for special relationship as stored in database.

    Includes auto-generated fields like id and created_at.
    """
    id: int
    special_relationship_id: int
    description: Optional[str] = None
    adjustments: Optional[str] = None
    diagnosed: bool = False
    status: Optional[str] = "Active"
    notes: Optional[str] = None
    created_at: datetime
    date_recorded: Optional[datetime] = None

    model_config = ConfigDict(
        from_attributes=True
    )


class VulnerabilitySpecialRelationship(VulnerabilitySpecialRelationshipInDBBase):
    """
    Complete vulnerability special relationship model returned to frontend.

    Includes all database fields plus any computed fields.
    Used as the response model for API endpoints.
    """
    pass
