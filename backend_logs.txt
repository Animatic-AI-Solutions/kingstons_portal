2025-11-25 21:20:10,849 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Fund valuation: ¬£110.0
2025-11-25 21:20:10,852 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Found 1 activities for fund 2164 up to 2024-02-01 (using end-of-day filter: 2024-02-01 23:59:59.999999)
2025-11-25 21:20:10,853 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Added final valuation of ¬£110.0 to next month (2024-03-01) to separate from activities in 2024-02-01
2025-11-25 21:20:10,853 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Aggregated cash flows: 3 flows from 2024-01-01 to 2024-03-01
2025-11-25 21:20:10,854 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Total valuation: ¬£110.0
2025-11-25 21:20:10,854 - app.api.routes.portfolio_funds - INFO - Calculating IRR using numpy_financial.irr...
2025-11-25 21:20:10,855 - app.api.routes.portfolio_funds - INFO - Raw monthly IRR calculation result: 0.04880884817015185
2025-11-25 21:20:10,855 - app.api.routes.portfolio_funds - INFO - Annualized IRR (monthly_irr * 12): 0.5857061780418222
2025-11-25 21:20:10,855 - app.api.routes.portfolio_funds - INFO - Days in period: 60
2025-11-25 21:20:10,855 - app.api.routes.portfolio_funds - INFO -
IRR Results:
2025-11-25 21:20:10,856 - app.api.routes.portfolio_funds - INFO - Monthly IRR: 4.8809%
2025-11-25 21:20:10,856 - app.api.routes.portfolio_funds - INFO - Annualized IRR: 58.5706%
2025-11-25 21:20:10,856 - app.api.routes.portfolio_funds - INFO - Months in period: 3
2025-11-25 21:20:10,856 - app.api.routes.portfolio_funds - INFO - Array size used: 3
2025-11-25 21:20:10,857 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Final IRR calculation - Decimal: 0.5857061780418222, Percentage: 58.6%        
2025-11-25 21:20:10,857 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: IRR calculation completed: 58.6% for fund 2164 on 2024-02-01
2025-11-25 21:20:10,859 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: ‚úÖ IRR calculation completed successfully for fund 2164: {'success': True, 'irr_percentage': 58.6, 'irr_decimal': 0.5857061780418222, 'calculation_date': '2024-02-01', 'portfolio_fund_id': 2164, 'valuation_amount': 110.0, 'cash_flows_count': 3, 'period_start': '2024-01-01', 'period_end': '2024-03-01', 'days_in_period': 60}
2025-11-25 21:20:10,860 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] IRR calculation returned: {'success': True, 'irr_percentage': 58.6, 'irr_decimal': 0.5857061780418222, 'calculation_date': '2024-02-01', 'portfolio_fund_id': 2164, 'valuation_amount': 110.0, 'cash_flows_count': 3, 'period_start': '2024-01-01', 'period_end': '2024-03-01', 'days_in_period': 60}
2025-11-25 21:20:10,860 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Calculated IRR percentage: 58.6%
2025-11-25 21:20:10,860 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Looking for fund valuation with fund_id=2164, date=2024-02-01      
2025-11-25 21:20:10,863 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Fund valuation ID: 8802
2025-11-25 21:20:10,863 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Checking for existing IRR record with fund_id=2164, date=2024-02-01
2025-11-25 21:20:10,865 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Found existing IRR record with ID: 9322
2025-11-25 21:20:10,866 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Updating existing IRR ID 9322 with value 58.6%
2025-11-25 21:20:10,871 - app.services.irr_cascade_service - INFO - üìä ‚úÖ Updated fund IRR for fund 2164 on 2024-02-01: 58.6%
2025-11-25 21:20:10,871 - app.utils.irr_cache - WARNING - ‚ö†Ô∏è [CACHE DEBUG] No cache entries found to invalidate for funds [2164]
2025-11-25 21:20:10,872 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] ‚úÖ Successfully calculated IRR for fund 2164
2025-11-25 21:20:10,872 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] Processing fund 2163 for date 2024-02-01
2025-11-25 21:20:10,872 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] ========== CALCULATING FUND IRR ==========
2025-11-25 21:20:10,872 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Fund ID: 2163, Date: 2024-02-01
2025-11-25 21:20:10,873 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Converted date to date_obj: 2024-02-01
2025-11-25 21:20:10,873 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Calling calculate_single_portfolio_fund_irr with bypass_cache=True 
2025-11-25 21:20:10,873 - app.api.routes.portfolio_funds - INFO - üîç IRR CALC ENTRY: calculate_single_portfolio_fund_irr called for fund 2163, date 2024-02-01  (BYPASSING CACHE)
2025-11-25 21:20:10,873 - app.api.routes.portfolio_funds - INFO - üîÑ Bypassing cache for fresh single fund calculation as requested
2025-11-25 21:20:10,878 - app.api.routes.portfolio_funds - INFO - IRR calculation date: 2024-02-01
2025-11-25 21:20:10,879 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Fund valuation: ¬£110.0
2025-11-25 21:20:10,881 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Found 1 activities for fund 2163 up to 2024-02-01 (using end-of-day filter: 2024-02-01 23:59:59.999999)
2025-11-25 21:20:10,881 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Added final valuation of ¬£110.0 to next month (2024-03-01) to separate from activities in 2024-02-01
2025-11-25 21:20:10,882 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Aggregated cash flows: 3 flows from 2024-01-01 to 2024-03-01
2025-11-25 21:20:10,882 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Total valuation: ¬£110.0
2025-11-25 21:20:10,882 - app.api.routes.portfolio_funds - INFO - Calculating IRR using numpy_financial.irr...
2025-11-25 21:20:10,883 - app.api.routes.portfolio_funds - INFO - Raw monthly IRR calculation result: 0.04880884817015185
2025-11-25 21:20:10,883 - app.api.routes.portfolio_funds - INFO - Annualized IRR (monthly_irr * 12): 0.5857061780418222
2025-11-25 21:20:10,884 - app.api.routes.portfolio_funds - INFO - Days in period: 60
2025-11-25 21:20:10,884 - app.api.routes.portfolio_funds - INFO -
IRR Results:
2025-11-25 21:20:10,884 - app.api.routes.portfolio_funds - INFO - Monthly IRR: 4.8809%
2025-11-25 21:20:10,884 - app.api.routes.portfolio_funds - INFO - Annualized IRR: 58.5706%
2025-11-25 21:20:10,884 - app.api.routes.portfolio_funds - INFO - Months in period: 3
2025-11-25 21:20:10,885 - app.api.routes.portfolio_funds - INFO - Array size used: 3
2025-11-25 21:20:10,885 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Final IRR calculation - Decimal: 0.5857061780418222, Percentage: 58.6%        
2025-11-25 21:20:10,885 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: IRR calculation completed: 58.6% for fund 2163 on 2024-02-01
2025-11-25 21:20:10,886 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: ‚úÖ IRR calculation completed successfully for fund 2163: {'success': True, 'irr_percentage': 58.6, 'irr_decimal': 0.5857061780418222, 'calculation_date': '2024-02-01', 'portfolio_fund_id': 2163, 'valuation_amount': 110.0, 'cash_flows_count': 3, 'period_start': '2024-01-01', 'period_end': '2024-03-01', 'days_in_period': 60}
2025-11-25 21:20:10,886 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] IRR calculation returned: {'success': True, 'irr_percentage': 58.6, 'irr_decimal': 0.5857061780418222, 'calculation_date': '2024-02-01', 'portfolio_fund_id': 2163, 'valuation_amount': 110.0, 'cash_flows_count': 3, 'period_start': '2024-01-01', 'period_end': '2024-03-01', 'days_in_period': 60}
2025-11-25 21:20:10,886 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Calculated IRR percentage: 58.6%
2025-11-25 21:20:10,886 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Looking for fund valuation with fund_id=2163, date=2024-02-01      
2025-11-25 21:20:10,888 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Fund valuation ID: 8803
2025-11-25 21:20:10,889 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Checking for existing IRR record with fund_id=2163, date=2024-02-01
2025-11-25 21:20:10,890 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Found existing IRR record with ID: 9323
2025-11-25 21:20:10,891 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Updating existing IRR ID 9323 with value 58.6%
2025-11-25 21:20:10,897 - app.services.irr_cascade_service - INFO - üìä ‚úÖ Updated fund IRR for fund 2163 on 2024-02-01: 58.6%
2025-11-25 21:20:10,897 - app.utils.irr_cache - WARNING - ‚ö†Ô∏è [CACHE DEBUG] No cache entries found to invalidate for funds [2163]
2025-11-25 21:20:10,897 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] ‚úÖ Successfully calculated IRR for fund 2163
2025-11-25 21:20:10,898 - app.utils.irr_cache - WARNING - ‚ö†Ô∏è [CACHE DEBUG] No cache entries found to invalidate for funds [2164, 2163]
2025-11-25 21:20:10,898 - app.services.irr_cascade_service - INFO - üóëÔ∏è Invalidated 0 IRR cache entries for 2 recalculated funds
2025-11-25 21:20:10,898 - app.services.irr_cascade_service - INFO - üìä Recalculated 2 fund IRRs for portfolio 448 on 2024-02-01
2025-11-25 21:20:10,909 - app.services.irr_cascade_service - INFO - üìä Portfolio 448 completeness for 2024-02-01: 2/2 non-cash funds = True
2025-11-25 21:20:10,911 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG] ==================== CASCADE SERVICE WRITING IRR ====================
2025-11-25 21:20:10,912 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG] Portfolio ID: 448, Date: 2024-02-01
2025-11-25 21:20:10,913 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG] Call stack:
2025-11-25 21:20:10,917 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "<string>", line 1, in <module>
2025-11-25 21:20:10,918 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\multiprocessing\spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
2025-11-25 21:20:10,922 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\multiprocessing\spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
2025-11-25 21:20:10,923 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\multiprocessing\process.py", line 314, in _bootstrap
    self.run()
2025-11-25 21:20:10,924 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\multiprocessing\process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
2025-11-25 21:20:10,925 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\uvicorn\_subprocess.py", line 76, in subprocess_started
    target(sockets=sockets)
2025-11-25 21:20:10,925 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\uvicorn\server.py", line 61, in run
    return asyncio.run(self.serve(sockets=sockets))
2025-11-25 21:20:10,926 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\asyncio\runners.py", line 190, in run
    return runner.run(main)
2025-11-25 21:20:10,926 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\asyncio\runners.py", line 118, in run
    return self._loop.run_until_complete(task)
2025-11-25 21:20:10,927 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\asyncio\base_events.py", line 641, in run_until_complete
    self.run_forever()
2025-11-25 21:20:10,927 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\asyncio\base_events.py", line 608, in run_forever
    self._run_once()
2025-11-25 21:20:10,928 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\asyncio\base_events.py", line 1936, in _run_once
    handle._run()
2025-11-25 21:20:10,928 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\asyncio\events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
2025-11-25 21:20:10,929 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\uvicorn\protocols\http\httptools_impl.py", line 426, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
2025-11-25 21:20:10,929 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\uvicorn\middleware\proxy_headers.py", line 84, in __call__
    return await self.app(scope, receive, send)
2025-11-25 21:20:10,930 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\fastapi\applications.py", line 1106, in __call__
    await super().__call__(scope, receive, send)
2025-11-25 21:20:10,930 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\applications.py", line 122, in __call__
    await self.middleware_stack(scope, receive, send)
2025-11-25 21:20:10,931 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\middleware\errors.py", line 162, in __call__
    await self.app(scope, receive, _send)
2025-11-25 21:20:10,931 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\middleware\cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
2025-11-25 21:20:10,932 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\middleware\cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
2025-11-25 21:20:10,932 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 68, in __call__
    await self.app(scope, receive, sender)
2025-11-25 21:20:10,933 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\fastapi\middleware\asyncexitstack.py", line 17, in __call__
    await self.app(scope, receive, send)
2025-11-25 21:20:10,933 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\routing.py", line 718, in __call__
    await route.handle(scope, receive, send)
2025-11-25 21:20:10,933 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\routing.py", line 276, in handle
    await self.app(scope, receive, send)
2025-11-25 21:20:10,934 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\routing.py", line 66, in app
    response = await func(request)
2025-11-25 21:20:10,934 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\fastapi\routing.py", line 274, in app
    raw_response = await run_endpoint_function(
2025-11-25 21:20:10,935 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\fastapi\routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
2025-11-25 21:20:10,935 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\app\api\routes\holding_activity_logs.py", line 840, in delete_holding_activity_log
    irr_recalc_result = await recalculate_irr_after_activity_change(portfolio_fund_id, db, activity_date)
2025-11-25 21:20:10,936 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\app\api\routes\holding_activity_logs.py", line 153, in recalculate_irr_after_activity_change
    cascade_result = await irr_service.handle_activity_changes_batch(portfolio_id, [activity_date])
2025-11-25 21:20:10,936 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\app\services\irr_cascade_service.py", line 185, in handle_activity_changes_batch
    portfolio_recalc = await self._recalculate_portfolio_irr_for_date(portfolio_id, valuation_date)
2025-11-25 21:20:10,937 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\app\services\irr_cascade_service.py", line 666, in _recalculate_portfolio_irr_for_date
    return await self._calculate_and_store_portfolio_irr(portfolio_id, date)
2025-11-25 21:20:10,937 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG] ============================================================================
2025-11-25 21:20:10,940 - app.utils.irr_cache - WARNING - ‚ö†Ô∏è [CACHE DEBUG] No cache entries found to invalidate for funds [2163, 2162, 2164]
2025-11-25 21:20:10,940 - app.services.irr_cascade_service - WARNING - ‚ö†Ô∏è Targeted cache invalidation found 0 entries, clearing entire cache for portfolioo 448
2025-11-25 21:20:10,941 - app.services.irr_cascade_service - INFO - üóëÔ∏è Pre-calculation: Cleared 0 total cache entries to ensure fresh calculation
2025-11-25 21:20:10,941 - app.api.routes.portfolio_funds - INFO - Calculating aggregated IRR for 3 portfolio funds  (BYPASSING CACHE)
2025-11-25 21:20:10,942 - app.api.routes.portfolio_funds - INFO - üîÑ Bypassing cache for fresh calculation as requested
2025-11-25 21:20:10,942 - app.api.routes.portfolio_funds - INFO - IRR calculation date: 2024-02-01
2025-11-25 21:20:10,943 - app.api.routes.portfolio_funds - INFO - üöÄ Batch fetching valuations for 3 funds (eliminates 3 individual requests)
2025-11-25 21:20:10,946 - app.api.routes.portfolio_funds - WARNING - No valuation found for fund 2162 as of 2024-02-01
2025-11-25 21:20:10,947 - app.api.routes.portfolio_funds - INFO - ‚úÖ Batch valuation optimization complete - Fund valuations: {2163: 110.0, 2164: 110.0, 2162: None}
2025-11-25 21:20:10,947 - app.api.routes.portfolio_funds - WARNING - üí∞ DEBUG: ‚ö†Ô∏è Excluding 1 funds without valuations from IRR calculation: [2162]       
2025-11-25 21:20:10,948 - app.api.routes.portfolio_funds - WARNING - üí∞ DEBUG: ‚úÖ Including 2 funds with valuations: [2163, 2164]
2025-11-25 21:20:10,955 - app.api.routes.portfolio_funds - INFO - üìä Processing 2 activities across 2 funds
2025-11-25 21:20:10,956 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:10,956 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:10,957 - app.api.routes.portfolio_funds - ERROR - üîç IRR CALCULATION DEBUG - Portfolio Funds: [2163, 2164]
2025-11-25 21:20:10,957 - app.api.routes.portfolio_funds - ERROR - üîç Calculation Date: 2024-02-01
2025-11-25 21:20:10,958 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:10,959 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:10,959 - app.api.routes.portfolio_funds - ERROR - üìã ALL TRANSACTIONS INCLUDED IN CALCULATION:
2025-11-25 21:20:10,959 - app.api.routes.portfolio_funds - ERROR -    Total Activities: 2
2025-11-25 21:20:10,960 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:10,960 - app.api.routes.portfolio_funds - ERROR -    üìÅ Fund ID 2163: 1 transactions
2025-11-25 21:20:10,961 - app.api.routes.portfolio_funds - ERROR -         1. 2024-01-01 | ¬£      100.00 | Investment           | NEGATIVE (investment)   
2025-11-25 21:20:10,961 - app.api.routes.portfolio_funds - ERROR -    üìÅ Fund ID 2164: 1 transactions
2025-11-25 21:20:10,962 - app.api.routes.portfolio_funds - ERROR -         1. 2024-01-01 | ¬£      100.00 | Investment           | NEGATIVE (investment)   
2025-11-25 21:20:10,962 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:10,962 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:10,962 - app.api.routes.portfolio_funds - ERROR - üí∞ MONTHLY CASH FLOW TOTALS:
2025-11-25 21:20:10,964 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:10,964 - app.api.routes.portfolio_funds - ERROR -      1. 2024-01-01 (activities)                  | ¬£        -200.00 | OUTFLOW (negative)
2025-11-25 21:20:10,964 - app.api.routes.portfolio_funds - ERROR -      2. 2024-03-01 (FINAL VALUATION)             | ¬£         220.00 | INFLOW (positive)
2025-11-25 21:20:10,965 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:10,965 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:10,965 - app.api.routes.portfolio_funds - ERROR - üìä SUMMARY STATISTICS:
2025-11-25 21:20:10,966 - app.api.routes.portfolio_funds - ERROR - ================================================================================
2025-11-25 21:20:10,966 - app.api.routes.portfolio_funds - ERROR -    Total Cash Flow Periods: 2
2025-11-25 21:20:10,966 - app.api.routes.portfolio_funds - ERROR -    Total Valuation: ¬£220.00
2025-11-25 21:20:10,967 - app.api.routes.portfolio_funds - ERROR -    Fund Valuations: {2163: 110.0, 2164: 110.0, 2162: None}
2025-11-25 21:20:10,967 - app.api.routes.portfolio_funds - ERROR -    Period: 2024-01-01 to 2024-03-01
2025-11-25 21:20:10,967 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:10,968 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:10,968 - app.api.routes.portfolio_funds - INFO - Calculating IRR using numpy_financial.irr...
2025-11-25 21:20:10,969 - app.api.routes.portfolio_funds - INFO - Raw monthly IRR calculation result: 0.04880884817015185
2025-11-25 21:20:10,970 - app.api.routes.portfolio_funds - INFO - Annualized IRR (monthly_irr * 12): 0.5857061780418222
2025-11-25 21:20:10,970 - app.api.routes.portfolio_funds - INFO - Days in period: 60
2025-11-25 21:20:10,971 - app.api.routes.portfolio_funds - INFO -
IRR Results:
2025-11-25 21:20:10,971 - app.api.routes.portfolio_funds - INFO - Monthly IRR: 4.8809%
2025-11-25 21:20:10,971 - app.api.routes.portfolio_funds - INFO - Annualized IRR: 58.5706%
2025-11-25 21:20:10,972 - app.api.routes.portfolio_funds - INFO - Months in period: 3
2025-11-25 21:20:10,972 - app.api.routes.portfolio_funds - INFO - Array size used: 3
2025-11-25 21:20:10,973 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:10,973 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:10,974 - app.api.routes.portfolio_funds - ERROR - ‚úÖ FINAL IRR CALCULATION RESULT:
2025-11-25 21:20:10,974 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:10,974 - app.api.routes.portfolio_funds - ERROR -    IRR (Decimal): 0.5857061780418222
2025-11-25 21:20:10,975 - app.api.routes.portfolio_funds - ERROR -    IRR (Percentage): 58.57%
2025-11-25 21:20:10,975 - app.api.routes.portfolio_funds - ERROR -    Days in Period: 60
2025-11-25 21:20:10,975 - app.api.routes.portfolio_funds - ERROR -    Cash Flow Periods: 2
2025-11-25 21:20:10,976 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:10,977 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:10,977 - app.api.routes.portfolio_funds - INFO - üìä IRR Calculation Complete: 58.6% over 60 days (2 cash flow periods)
2025-11-25 21:20:11,017 - app.services.irr_cascade_service - INFO - üìä Updated portfolio IRR for portfolio 448 on 2024-02-01: 58.6%
2025-11-25 21:20:11,018 - app.services.irr_cascade_service - INFO - üîÑ [IRR CASCADE] Processing valuation date 2024-03-01
2025-11-25 21:20:11,018 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] ========== RECALCULATING ALL FUND IRRs FOR DATE ==========        
2025-11-25 21:20:11,018 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] Portfolio ID: 448, Date: 2024-03-01
2025-11-25 21:20:11,019 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] Converted date to date_obj: 2024-03-01
2025-11-25 21:20:11,020 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] Found 44 funds with valuations on 2024-03-01
2025-11-25 21:20:11,022 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] Portfolio 448 has 3 total funds
2025-11-25 21:20:11,022 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] Funds with valuations on 2024-03-01: [1192, 1193, 1194, 1195, 1196, 1197, 1198, 1199, 1200, 1201, 1202, 1128, 1129, 1130, 1131, 1133, 1134, 1135, 1136, 1137, 1091, 1092, 1094, 1095, 1096, 1097, 1098, 1099, 1100, 1101, 1102, 1103, 1104, 1093, 1112, 1122, 1548, 1549, 1834, 1835, 1842, 1843, 2164, 2163]
2025-11-25 21:20:11,023 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] Portfolio fund IDs: [2163, 2162, 2164]
2025-11-25 21:20:11,023 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] Relevant fund IDs for IRR calculation: [2164, 2163]
2025-11-25 21:20:11,023 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] Expected 8 funds, got 2 funds
2025-11-25 21:20:11,023 - app.services.irr_cascade_service - WARNING - üîç [BATCH IRR CALC] ‚ö†Ô∏è Cash fund (1536) is MISSING from relevant_fund_ids!
2025-11-25 21:20:11,023 - app.services.irr_cascade_service - WARNING - üîç [BATCH IRR CALC] ‚ö†Ô∏è Checking if 1536 has valuation on 2024-03-01...
2025-11-25 21:20:11,026 - app.services.irr_cascade_service - WARNING - üîç [BATCH IRR CALC] ‚ö†Ô∏è Cash valuation check result: []
2025-11-25 21:20:11,027 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] Processing fund 2164 for date 2024-03-01
2025-11-25 21:20:11,027 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] ========== CALCULATING FUND IRR ==========
2025-11-25 21:20:11,027 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Fund ID: 2164, Date: 2024-03-01
2025-11-25 21:20:11,027 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Converted date to date_obj: 2024-03-01
2025-11-25 21:20:11,028 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Calling calculate_single_portfolio_fund_irr with bypass_cache=True 
2025-11-25 21:20:11,028 - app.api.routes.portfolio_funds - INFO - üîç IRR CALC ENTRY: calculate_single_portfolio_fund_irr called for fund 2164, date 2024-03-01  (BYPASSING CACHE)
2025-11-25 21:20:11,028 - app.api.routes.portfolio_funds - INFO - üîÑ Bypassing cache for fresh single fund calculation as requested
2025-11-25 21:20:11,033 - app.api.routes.portfolio_funds - INFO - IRR calculation date: 2024-03-01
2025-11-25 21:20:11,035 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Fund valuation: ¬£120.0
2025-11-25 21:20:11,037 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Found 1 activities for fund 2164 up to 2024-03-01 (using end-of-day filter: 2024-03-01 23:59:59.999999)
2025-11-25 21:20:11,037 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Added final valuation of ¬£120.0 to next month (2024-04-01) to separate from activities in 2024-03-01
2025-11-25 21:20:11,038 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Aggregated cash flows: 3 flows from 2024-01-01 to 2024-04-01
2025-11-25 21:20:11,038 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Total valuation: ¬£120.0
2025-11-25 21:20:11,039 - app.api.routes.portfolio_funds - INFO - Calculating IRR using numpy_financial.irr...
2025-11-25 21:20:11,039 - app.api.routes.portfolio_funds - INFO - Raw monthly IRR calculation result: 0.06265856918261092
2025-11-25 21:20:11,040 - app.api.routes.portfolio_funds - INFO - Annualized IRR (monthly_irr * 12): 0.7519028301913311
2025-11-25 21:20:11,040 - app.api.routes.portfolio_funds - INFO - Days in period: 91
2025-11-25 21:20:11,041 - app.api.routes.portfolio_funds - INFO -
IRR Results:
2025-11-25 21:20:11,041 - app.api.routes.portfolio_funds - INFO - Monthly IRR: 6.2659%
2025-11-25 21:20:11,041 - app.api.routes.portfolio_funds - INFO - Annualized IRR: 75.1903%
2025-11-25 21:20:11,042 - app.api.routes.portfolio_funds - INFO - Months in period: 4
2025-11-25 21:20:11,044 - app.api.routes.portfolio_funds - INFO - Array size used: 4
2025-11-25 21:20:11,044 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Final IRR calculation - Decimal: 0.7519028301913311, Percentage: 75.2%        
2025-11-25 21:20:11,045 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: IRR calculation completed: 75.2% for fund 2164 on 2024-03-01
2025-11-25 21:20:11,047 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: ‚úÖ IRR calculation completed successfully for fund 2164: {'success': True, 'irr_percentage': 75.2, 'irr_decimal': 0.7519028301913311, 'calculation_date': '2024-03-01', 'portfolio_fund_id': 2164, 'valuation_amount': 120.0, 'cash_flows_count': 3, 'period_start': '2024-01-01', 'period_end': '2024-04-01', 'days_in_period': 91}
2025-11-25 21:20:11,047 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] IRR calculation returned: {'success': True, 'irr_percentage': 75.2, 'irr_decimal': 0.7519028301913311, 'calculation_date': '2024-03-01', 'portfolio_fund_id': 2164, 'valuation_amount': 120.0, 'cash_flows_count': 3, 'period_start': '2024-01-01', 'period_end': '2024-04-01', 'days_in_period': 91}
2025-11-25 21:20:11,048 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Calculated IRR percentage: 75.2%
2025-11-25 21:20:11,048 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Looking for fund valuation with fund_id=2164, date=2024-03-01      
2025-11-25 21:20:11,050 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Fund valuation ID: 9114
2025-11-25 21:20:11,051 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Checking for existing IRR record with fund_id=2164, date=2024-03-01
2025-11-25 21:20:11,055 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Found existing IRR record with ID: 9647
2025-11-25 21:20:11,056 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Updating existing IRR ID 9647 with value 75.2%
2025-11-25 21:20:11,059 - app.services.irr_cascade_service - INFO - üìä ‚úÖ Updated fund IRR for fund 2164 on 2024-03-01: 75.2%
2025-11-25 21:20:11,060 - app.utils.irr_cache - WARNING - ‚ö†Ô∏è [CACHE DEBUG] No cache entries found to invalidate for funds [2164]
2025-11-25 21:20:11,060 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] ‚úÖ Successfully calculated IRR for fund 2164
2025-11-25 21:20:11,061 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] Processing fund 2163 for date 2024-03-01
2025-11-25 21:20:11,061 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] ========== CALCULATING FUND IRR ==========
2025-11-25 21:20:11,062 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Fund ID: 2163, Date: 2024-03-01
2025-11-25 21:20:11,063 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Converted date to date_obj: 2024-03-01
2025-11-25 21:20:11,063 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Calling calculate_single_portfolio_fund_irr with bypass_cache=True 
2025-11-25 21:20:11,064 - app.api.routes.portfolio_funds - INFO - üîç IRR CALC ENTRY: calculate_single_portfolio_fund_irr called for fund 2163, date 2024-03-01  (BYPASSING CACHE)
2025-11-25 21:20:11,064 - app.api.routes.portfolio_funds - INFO - üîÑ Bypassing cache for fresh single fund calculation as requested
2025-11-25 21:20:11,069 - app.api.routes.portfolio_funds - INFO - IRR calculation date: 2024-03-01
2025-11-25 21:20:11,072 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Fund valuation: ¬£0.0
2025-11-25 21:20:11,072 - app.api.routes.portfolio_funds - WARNING - üí∞ DEBUG: ‚ö†Ô∏è  ZERO VALUATION DETECTED! Fund 2163 has ¬£0 valuation
2025-11-25 21:20:11,075 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Found 2 activities for fund 2163 up to 2024-03-01 (using end-of-day filter: 2024-03-01 23:59:59.999999)
2025-11-25 21:20:11,076 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: ‚ö†Ô∏è  Total valuation is zero - omitting final valuations from IRR calculation ffor fully exited funds
2025-11-25 21:20:11,077 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Aggregated cash flows: 2 flows from 2024-01-01 to 2024-03-01
2025-11-25 21:20:11,077 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Total valuation: ¬£0.0
2025-11-25 21:20:11,078 - app.api.routes.portfolio_funds - INFO - Calculating IRR using numpy_financial.irr...
2025-11-25 21:20:11,079 - app.api.routes.portfolio_funds - INFO - Raw monthly IRR calculation result: 0.04880884817015185
2025-11-25 21:20:11,080 - app.api.routes.portfolio_funds - INFO - Annualized IRR (monthly_irr * 12): 0.5857061780418222
2025-11-25 21:20:11,080 - app.api.routes.portfolio_funds - INFO - Days in period: 60
2025-11-25 21:20:11,080 - app.api.routes.portfolio_funds - INFO -
IRR Results:
2025-11-25 21:20:11,081 - app.api.routes.portfolio_funds - INFO - Monthly IRR: 4.8809%
2025-11-25 21:20:11,081 - app.api.routes.portfolio_funds - INFO - Annualized IRR: 58.5706%
2025-11-25 21:20:11,081 - app.api.routes.portfolio_funds - INFO - Months in period: 3
2025-11-25 21:20:11,082 - app.api.routes.portfolio_funds - INFO - Array size used: 3
2025-11-25 21:20:11,082 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: Final IRR calculation - Decimal: 0.5857061780418222, Percentage: 58.6%        
2025-11-25 21:20:11,082 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: IRR calculation completed: 58.6% for fund 2163 on 2024-03-01
2025-11-25 21:20:11,083 - app.api.routes.portfolio_funds - INFO - üí∞ DEBUG: ‚úÖ IRR calculation completed successfully for fund 2163: {'success': True, 'irr_percentage': 58.6, 'irr_decimal': 0.5857061780418222, 'calculation_date': '2024-03-01', 'portfolio_fund_id': 2163, 'valuation_amount': 0.0, 'cash_flows_count': 2, 'period_start': '2024-01-01', 'period_end': '2024-03-01', 'days_in_period': 60}
2025-11-25 21:20:11,083 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] IRR calculation returned: {'success': True, 'irr_percentage': 58.6, 'irr_decimal': 0.5857061780418222, 'calculation_date': '2024-03-01', 'portfolio_fund_id': 2163, 'valuation_amount': 0.0, 'cash_flows_count': 2, 'period_start': '2024-01-01', 'period_end': '2024-03-01', 'days_in_period': 60}
2025-11-25 21:20:11,083 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Calculated IRR percentage: 58.6%
2025-11-25 21:20:11,083 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Looking for fund valuation with fund_id=2163, date=2024-03-01      
2025-11-25 21:20:11,086 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Fund valuation ID: 9115
2025-11-25 21:20:11,086 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Checking for existing IRR record with fund_id=2163, date=2024-03-01
2025-11-25 21:20:11,088 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Found existing IRR record with ID: 9648
2025-11-25 21:20:11,090 - app.services.irr_cascade_service - INFO - üîç [FUND IRR CALC] Updating existing IRR ID 9648 with value 58.6%
2025-11-25 21:20:11,093 - app.services.irr_cascade_service - INFO - üìä ‚úÖ Updated fund IRR for fund 2163 on 2024-03-01: 58.6%
2025-11-25 21:20:11,094 - app.utils.irr_cache - WARNING - ‚ö†Ô∏è [CACHE DEBUG] No cache entries found to invalidate for funds [2163]
2025-11-25 21:20:11,095 - app.services.irr_cascade_service - INFO - üîç [BATCH IRR CALC] ‚úÖ Successfully calculated IRR for fund 2163
2025-11-25 21:20:11,096 - app.utils.irr_cache - WARNING - ‚ö†Ô∏è [CACHE DEBUG] No cache entries found to invalidate for funds [2164, 2163]
2025-11-25 21:20:11,096 - app.services.irr_cascade_service - INFO - üóëÔ∏è Invalidated 0 IRR cache entries for 2 recalculated funds
2025-11-25 21:20:11,097 - app.services.irr_cascade_service - INFO - üìä Recalculated 2 fund IRRs for portfolio 448 on 2024-03-01
2025-11-25 21:20:11,102 - app.services.irr_cascade_service - INFO - üìä Portfolio 448 completeness for 2024-03-01: 2/2 non-cash funds = True
2025-11-25 21:20:11,103 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG] ==================== CASCADE SERVICE WRITING IRR ====================
2025-11-25 21:20:11,104 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG] Portfolio ID: 448, Date: 2024-03-01
2025-11-25 21:20:11,104 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG] Call stack:
2025-11-25 21:20:11,107 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "<string>", line 1, in <module>
2025-11-25 21:20:11,107 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\multiprocessing\spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
2025-11-25 21:20:11,109 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\multiprocessing\spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
2025-11-25 21:20:11,109 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\multiprocessing\process.py", line 314, in _bootstrap
    self.run()
2025-11-25 21:20:11,109 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\multiprocessing\process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
2025-11-25 21:20:11,110 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\uvicorn\_subprocess.py", line 76, in subprocess_started
    target(sockets=sockets)
2025-11-25 21:20:11,110 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\uvicorn\server.py", line 61, in run
    return asyncio.run(self.serve(sockets=sockets))
2025-11-25 21:20:11,111 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\asyncio\runners.py", line 190, in run
    return runner.run(main)
2025-11-25 21:20:11,112 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\asyncio\runners.py", line 118, in run
    return self._loop.run_until_complete(task)
2025-11-25 21:20:11,112 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\asyncio\base_events.py", line 641, in run_until_complete
    self.run_forever()
2025-11-25 21:20:11,112 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\asyncio\base_events.py", line 608, in run_forever
    self._run_once()
2025-11-25 21:20:11,113 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\asyncio\base_events.py", line 1936, in _run_once
    handle._run()
2025-11-25 21:20:11,114 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\AppData\Local\Programs\Python\Python311\Lib\asyncio\events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
2025-11-25 21:20:11,114 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\uvicorn\protocols\http\httptools_impl.py", line 426, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
2025-11-25 21:20:11,114 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\uvicorn\middleware\proxy_headers.py", line 84, in __call__
    return await self.app(scope, receive, send)
2025-11-25 21:20:11,115 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\fastapi\applications.py", line 1106, in __call__
    await super().__call__(scope, receive, send)
2025-11-25 21:20:11,115 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\applications.py", line 122, in __call__
    await self.middleware_stack(scope, receive, send)
2025-11-25 21:20:11,115 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\middleware\errors.py", line 162, in __call__
    await self.app(scope, receive, _send)
2025-11-25 21:20:11,116 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\middleware\cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
2025-11-25 21:20:11,117 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\middleware\cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
2025-11-25 21:20:11,117 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 68, in __call__
    await self.app(scope, receive, sender)
2025-11-25 21:20:11,118 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\fastapi\middleware\asyncexitstack.py", line 17, in __call__
    await self.app(scope, receive, send)
2025-11-25 21:20:11,118 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\routing.py", line 718, in __call__
    await route.handle(scope, receive, send)
2025-11-25 21:20:11,118 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\routing.py", line 276, in handle
    await self.app(scope, receive, send)
2025-11-25 21:20:11,119 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\starlette\routing.py", line 66, in app
    response = await func(request)
2025-11-25 21:20:11,119 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\fastapi\routing.py", line 274, in app
    raw_response = await run_endpoint_function(
2025-11-25 21:20:11,120 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\fastapi\routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
2025-11-25 21:20:11,120 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\app\api\routes\holding_activity_logs.py", line 840, in delete_holding_activity_log
    irr_recalc_result = await recalculate_irr_after_activity_change(portfolio_fund_id, db, activity_date)
2025-11-25 21:20:11,120 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\app\api\routes\holding_activity_logs.py", line 153, in recalculate_irr_after_activity_change
    cascade_result = await irr_service.handle_activity_changes_batch(portfolio_id, [activity_date])
2025-11-25 21:20:11,121 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\app\services\irr_cascade_service.py", line 185, in handle_activity_changes_batch
    portfolio_recalc = await self._recalculate_portfolio_irr_for_date(portfolio_id, valuation_date)
2025-11-25 21:20:11,122 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG]   File "C:\Users\jacob\Documents\kingstons_portal\backend\app\services\irr_cascade_service.py", line 666, in _recalculate_portfolio_irr_for_date
    return await self._calculate_and_store_portfolio_irr(portfolio_id, date)
2025-11-25 21:20:11,122 - app.services.irr_cascade_service - INFO - üö® [IRR CASCADE OVERWRITE DEBUG] ============================================================================
2025-11-25 21:20:11,125 - app.utils.irr_cache - WARNING - ‚ö†Ô∏è [CACHE DEBUG] No cache entries found to invalidate for funds [2163, 2162, 2164]
2025-11-25 21:20:11,125 - app.services.irr_cascade_service - WARNING - ‚ö†Ô∏è Targeted cache invalidation found 0 entries, clearing entire cache for portfolioo 448
2025-11-25 21:20:11,126 - app.services.irr_cascade_service - INFO - üóëÔ∏è Pre-calculation: Cleared 0 total cache entries to ensure fresh calculation
2025-11-25 21:20:11,126 - app.api.routes.portfolio_funds - INFO - Calculating aggregated IRR for 3 portfolio funds  (BYPASSING CACHE)
2025-11-25 21:20:11,126 - app.api.routes.portfolio_funds - INFO - üîÑ Bypassing cache for fresh calculation as requested
2025-11-25 21:20:11,127 - app.api.routes.portfolio_funds - INFO - IRR calculation date: 2024-03-01
2025-11-25 21:20:11,127 - app.api.routes.portfolio_funds - INFO - üöÄ Batch fetching valuations for 3 funds (eliminates 3 individual requests)
2025-11-25 21:20:11,130 - app.api.routes.portfolio_funds - WARNING - No valuation found for fund 2162 as of 2024-03-01
2025-11-25 21:20:11,130 - app.api.routes.portfolio_funds - INFO - ‚úÖ Batch valuation optimization complete - Fund valuations: {2163: 0.0, 2164: 120.0, 2162: None}
2025-11-25 21:20:11,131 - app.api.routes.portfolio_funds - WARNING - üí∞ DEBUG: ‚ö†Ô∏è Excluding 1 funds without valuations from IRR calculation: [2162]       
2025-11-25 21:20:11,132 - app.api.routes.portfolio_funds - WARNING - üí∞ DEBUG: ‚úÖ Including 2 funds with valuations: [2163, 2164]
2025-11-25 21:20:11,136 - app.api.routes.portfolio_funds - INFO - üìä Processing 3 activities across 2 funds
2025-11-25 21:20:11,137 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:11,138 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:11,138 - app.api.routes.portfolio_funds - ERROR - üîç IRR CALCULATION DEBUG - Portfolio Funds: [2163, 2164]
2025-11-25 21:20:11,138 - app.api.routes.portfolio_funds - ERROR - üîç Calculation Date: 2024-03-01
2025-11-25 21:20:11,138 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:11,139 - app.api.routes.portfolio_funds - ERROR - 
2025-11-25 21:20:11,139 - app.api.routes.portfolio_funds - ERROR - üìã ALL TRANSACTIONS INCLUDED IN CALCULATION:
2025-11-25 21:20:11,140 - app.api.routes.portfolio_funds - ERROR -    Total Activities: 3
2025-11-25 21:20:11,142 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:11,142 - app.api.routes.portfolio_funds - ERROR -    üìÅ Fund ID 2163: 2 transactions
2025-11-25 21:20:11,143 - app.api.routes.portfolio_funds - ERROR -         1. 2024-01-01 | ¬£      100.00 | Investment           | NEGATIVE (investment)   
2025-11-25 21:20:11,143 - app.api.routes.portfolio_funds - ERROR -         2. 2024-03-01 | ¬£      110.00 | Withdrawal           | POSITIVE (withdrawal)   
2025-11-25 21:20:11,144 - app.api.routes.portfolio_funds - ERROR -    üìÅ Fund ID 2164: 1 transactions
2025-11-25 21:20:11,145 - app.api.routes.portfolio_funds - ERROR -         1. 2024-01-01 | ¬£      100.00 | Investment           | NEGATIVE (investment)   
2025-11-25 21:20:11,145 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:11,146 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:11,146 - app.api.routes.portfolio_funds - ERROR - üí∞ MONTHLY CASH FLOW TOTALS:
2025-11-25 21:20:11,147 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:11,148 - app.api.routes.portfolio_funds - ERROR -      1. 2024-01-01 (activities)                  | ¬£        -200.00 | OUTFLOW (negative)
2025-11-25 21:20:11,148 - app.api.routes.portfolio_funds - ERROR -      2. 2024-03-01 (activities)                  | ¬£         110.00 | INFLOW (positive)
2025-11-25 21:20:11,149 - app.api.routes.portfolio_funds - ERROR -      3. 2024-04-01 (FINAL VALUATION)             | ¬£         120.00 | INFLOW (positive)
2025-11-25 21:20:11,149 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:11,150 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:11,150 - app.api.routes.portfolio_funds - ERROR - üìä SUMMARY STATISTICS:
2025-11-25 21:20:11,151 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:11,151 - app.api.routes.portfolio_funds - ERROR -    Total Cash Flow Periods: 3
2025-11-25 21:20:11,152 - app.api.routes.portfolio_funds - ERROR -    Total Valuation: ¬£120.00
2025-11-25 21:20:11,152 - app.api.routes.portfolio_funds - ERROR -    Fund Valuations: {2163: 0.0, 2164: 120.0, 2162: None}
2025-11-25 21:20:11,153 - app.api.routes.portfolio_funds - ERROR -    Period: 2024-01-01 to 2024-04-01
2025-11-25 21:20:11,153 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:11,154 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:11,154 - app.api.routes.portfolio_funds - INFO - Calculating IRR using numpy_financial.irr...
2025-11-25 21:20:11,155 - app.api.routes.portfolio_funds - INFO - Raw monthly IRR calculation result: 0.05714909858175221
2025-11-25 21:20:11,156 - app.api.routes.portfolio_funds - INFO - Annualized IRR (monthly_irr * 12): 0.6857891829810265
2025-11-25 21:20:11,156 - app.api.routes.portfolio_funds - INFO - Days in period: 91
2025-11-25 21:20:11,157 - app.api.routes.portfolio_funds - INFO -
IRR Results:
2025-11-25 21:20:11,157 - app.api.routes.portfolio_funds - INFO - Monthly IRR: 5.7149%
2025-11-25 21:20:11,157 - app.api.routes.portfolio_funds - INFO - Annualized IRR: 68.5789%
2025-11-25 21:20:11,158 - app.api.routes.portfolio_funds - INFO - Months in period: 4
2025-11-25 21:20:11,158 - app.api.routes.portfolio_funds - INFO - Array size used: 4
2025-11-25 21:20:11,159 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:11,159 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:11,160 - app.api.routes.portfolio_funds - ERROR - ‚úÖ FINAL IRR CALCULATION RESULT:
2025-11-25 21:20:11,161 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:11,161 - app.api.routes.portfolio_funds - ERROR -    IRR (Decimal): 0.6857891829810265
2025-11-25 21:20:11,162 - app.api.routes.portfolio_funds - ERROR -    IRR (Percentage): 68.58%
2025-11-25 21:20:11,162 - app.api.routes.portfolio_funds - ERROR -    Days in Period: 91
2025-11-25 21:20:11,163 - app.api.routes.portfolio_funds - ERROR -    Cash Flow Periods: 3
2025-11-25 21:20:11,163 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:11,164 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:11,164 - app.api.routes.portfolio_funds - INFO - üìä IRR Calculation Complete: 68.6% over 91 days (3 cash flow periods)
2025-11-25 21:20:11,180 - app.services.irr_cascade_service - INFO - üìä Updated portfolio IRR for portfolio 448 on 2024-03-01: 68.6%
2025-11-25 21:20:11,181 - app.services.irr_cascade_service - INFO - üîÑ [IRR CASCADE] ‚úÖ Batch recalculation completed: {'success': True, 'portfolio_id': 448, 'dates_processed': 2, 'fund_irrs_recalculated': 4, 'portfolio_irrs_recalculated': 2, 'processed_dates': ['2024-02-01', '2024-03-01'], 'activity_dates': ['2024-01-01'], 'earliest_activity_date': '2024-01-01'}
2025-11-25 21:20:11,181 - app.api.routes.holding_activity_logs - INFO - ‚úÖ [ACTIVITY WRAPPER] Targeted IRR cascade completed successfully: {'success': True, 'portfolio_id': 448, 'dates_processed': 2, 'fund_irrs_recalculated': 4, 'portfolio_irrs_recalculated': 2, 'processed_dates': ['2024-02-01', '2024-03-01'], 'activity_dates': ['2024-01-01'], 'earliest_activity_date': '2024-01-01'}
2025-11-25 21:20:11,182 - app.api.routes.holding_activity_logs - INFO - Sophisticated IRR recalculation result: {'success': True, 'portfolio_fund_id': 2164, 'portfolio_id': 448, 'activity_start_date': '2024-01-01', 'recalculated_existing': 4, 'new_entries_created': 0, 'portfolio_irr_recalculated': 2, 'dates_processed': 2, 'cascade_service_used': True, 'method': 'targeted_activity_batch'}
2025-11-25 21:20:12,312 - app.api.routes.client_products - INFO - Fetching complete product details for product ID: 435
2025-11-25 21:20:12,320 - app.api.routes.client_products - INFO - Found product: Investment Bond (ID: 435)
INFO:     connection closed
2025-11-25 21:20:12,332 - app.api.routes.presence - WARNING - Failed to send message to user 3: received 1000 (OK) Component unmounting; then sent 1000 (OK) Component unmounting
2025-11-25 21:20:12,465 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] ==================== FETCHING LATEST IRR ====================
2025-11-25 21:20:12,465 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] Portfolio ID: 448
2025-11-25 21:20:12,468 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] View query result: <Record portfolio_id=448 irr_result=Decimal('68.6000') date=datetime.date(2024, 3, 1)>
2025-11-25 21:20:12,470 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] Raw table query result: <Record portfolio_id=448 irr_result=Decimal('68.6000') date=datetime.date(2024, 3, 1)>
INFO:     ('127.0.0.1', 53401) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 50854) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
2025-11-25 21:20:33,391 - app.api.routes.portfolio_funds - INFO - Updating portfolio fund 2163 with data: {'status': 'inactive'}
2025-11-25 21:20:33,401 - app.api.routes.portfolio_funds - INFO - Serialized fund data: {'id': 2163, 'portfolio_id': 448, 'available_funds_id': 16, 'target_weighting': None, 'amount_invested': 0.0, 'start_date': '2023-11-17', 'end_date': None, 'status': 'inactive', 'created_at': '2025-11-17T11:51:36.760506+00:00'}
2025-11-25 21:20:33,457 - app.api.routes.client_products - INFO - Fetching complete product details for product ID: 435
INFO:     connection closed
2025-11-25 21:20:33,477 - app.api.routes.client_products - INFO - Found product: Investment Bond (ID: 435)
2025-11-25 21:20:33,479 - app.api.routes.presence - WARNING - Failed to send message to user 3: received 1000 (OK) Component unmounting; then sent 1000 (OK) Component unmounting
2025-11-25 21:20:33,997 - app.api.routes.portfolio_funds - INFO - Calculating aggregated IRR for 1 portfolio funds
2025-11-25 21:20:33,998 - app.api.routes.portfolio_funds - INFO - No IRR date provided, finding latest valuation date
2025-11-25 21:20:34,001 - app.api.routes.portfolio_funds - INFO - Calculating aggregated IRR for 1 portfolio funds
2025-11-25 21:20:34,002 - app.api.routes.portfolio_funds - INFO - No IRR date provided, finding latest valuation date
2025-11-25 21:20:34,004 - app.api.routes.portfolio_funds - INFO - Using latest valuation date: 2024-03-01
2025-11-25 21:20:34,004 - app.api.routes.portfolio_funds - INFO - IRR calculation date: 2024-03-01
2025-11-25 21:20:34,004 - app.api.routes.portfolio_funds - INFO - üöÄ Batch fetching valuations for 1 funds (eliminates 1 individual requests)
2025-11-25 21:20:34,005 - app.api.routes.portfolio_funds - INFO - Using latest valuation date: 2024-03-01
2025-11-25 21:20:34,005 - app.api.routes.portfolio_funds - INFO - IRR calculation date: 2024-03-01
2025-11-25 21:20:34,005 - app.api.routes.portfolio_funds - INFO - üöÄ Batch fetching valuations for 1 funds (eliminates 1 individual requests)
2025-11-25 21:20:34,007 - app.api.routes.portfolio_funds - INFO - ‚úÖ Batch valuation optimization complete - Fund valuations: {2163: 0.0}
2025-11-25 21:20:34,014 - app.api.routes.portfolio_funds - INFO - ‚úÖ Batch valuation optimization complete - Fund valuations: {2163: 0.0}
2025-11-25 21:20:34,208 - app.api.routes.portfolio_funds - INFO - üìä Processing 2 activities across 1 funds
2025-11-25 21:20:34,209 - app.api.routes.portfolio_funds - ERROR - 
2025-11-25 21:20:34,211 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,211 - app.api.routes.portfolio_funds - ERROR - üîç IRR CALCULATION DEBUG - Portfolio Funds: [2163]
2025-11-25 21:20:34,211 - app.api.routes.portfolio_funds - ERROR - üîç Calculation Date: 2024-03-01
2025-11-25 21:20:34,212 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,212 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,212 - app.api.routes.portfolio_funds - ERROR - üìã ALL TRANSACTIONS INCLUDED IN CALCULATION:
2025-11-25 21:20:34,213 - app.api.routes.portfolio_funds - ERROR -    Total Activities: 2
2025-11-25 21:20:34,213 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,213 - app.api.routes.portfolio_funds - ERROR -    üìÅ Fund ID 2163: 2 transactions
2025-11-25 21:20:34,213 - app.api.routes.portfolio_funds - ERROR -         1. 2024-01-01 | ¬£      100.00 | Investment           | NEGATIVE (investment)   
2025-11-25 21:20:34,214 - app.api.routes.portfolio_funds - ERROR -         2. 2024-03-01 | ¬£      110.00 | Withdrawal           | POSITIVE (withdrawal)   
2025-11-25 21:20:34,214 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,215 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,215 - app.api.routes.portfolio_funds - ERROR - üí∞ MONTHLY CASH FLOW TOTALS:
2025-11-25 21:20:34,215 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,216 - app.api.routes.portfolio_funds - ERROR -      1. 2024-01-01 (activities)                  | ¬£        -100.00 | OUTFLOW (negative)
2025-11-25 21:20:34,216 - app.api.routes.portfolio_funds - ERROR -      2. 2024-03-01 (FINAL VALUATION)             | ¬£         110.00 | INFLOW (positive)
2025-11-25 21:20:34,217 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,217 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,217 - app.api.routes.portfolio_funds - ERROR - üìä SUMMARY STATISTICS:
2025-11-25 21:20:34,217 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,218 - app.api.routes.portfolio_funds - ERROR -    Total Cash Flow Periods: 2
2025-11-25 21:20:34,218 - app.api.routes.portfolio_funds - ERROR -    Total Valuation: ¬£0.00
2025-11-25 21:20:34,218 - app.api.routes.portfolio_funds - ERROR -    Fund Valuations: {2163: 0.0}
2025-11-25 21:20:34,218 - app.api.routes.portfolio_funds - ERROR -    Period: 2024-01-01 to 2024-03-01
2025-11-25 21:20:34,219 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,219 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,219 - app.api.routes.portfolio_funds - INFO - Calculating IRR using numpy_financial.irr...
2025-11-25 21:20:34,220 - app.api.routes.portfolio_funds - INFO - Raw monthly IRR calculation result: 0.04880884817015185
2025-11-25 21:20:34,220 - app.api.routes.portfolio_funds - INFO - Annualized IRR (monthly_irr * 12): 0.5857061780418222
2025-11-25 21:20:34,221 - app.api.routes.portfolio_funds - INFO - Days in period: 60
2025-11-25 21:20:34,221 - app.api.routes.portfolio_funds - INFO -
IRR Results:
2025-11-25 21:20:34,221 - app.api.routes.portfolio_funds - INFO - Monthly IRR: 4.8809%
2025-11-25 21:20:34,221 - app.api.routes.portfolio_funds - INFO - Annualized IRR: 58.5706%
2025-11-25 21:20:34,221 - app.api.routes.portfolio_funds - INFO - Months in period: 3
2025-11-25 21:20:34,222 - app.api.routes.portfolio_funds - INFO - Array size used: 3
2025-11-25 21:20:34,222 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,222 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,222 - app.api.routes.portfolio_funds - ERROR - ‚úÖ FINAL IRR CALCULATION RESULT:
2025-11-25 21:20:34,222 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,223 - app.api.routes.portfolio_funds - ERROR -    IRR (Decimal): 0.5857061780418222
2025-11-25 21:20:34,223 - app.api.routes.portfolio_funds - ERROR -    IRR (Percentage): 58.57%
2025-11-25 21:20:34,223 - app.api.routes.portfolio_funds - ERROR -    Days in Period: 60
2025-11-25 21:20:34,223 - app.api.routes.portfolio_funds - ERROR -    Cash Flow Periods: 2
2025-11-25 21:20:34,223 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,223 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,224 - app.api.routes.portfolio_funds - INFO - üìä IRR Calculation Complete: 58.6% over 60 days (2 cash flow periods)
2025-11-25 21:20:34,225 - app.api.routes.portfolio_funds - INFO - üìä Processing 2 activities across 1 funds
2025-11-25 21:20:34,225 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,225 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,226 - app.api.routes.portfolio_funds - ERROR - üîç IRR CALCULATION DEBUG - Portfolio Funds: [2163]
2025-11-25 21:20:34,226 - app.api.routes.portfolio_funds - ERROR - üîç Calculation Date: 2024-03-01
2025-11-25 21:20:34,226 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,227 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,227 - app.api.routes.portfolio_funds - ERROR - üìã ALL TRANSACTIONS INCLUDED IN CALCULATION:
2025-11-25 21:20:34,227 - app.api.routes.portfolio_funds - ERROR -    Total Activities: 2
2025-11-25 21:20:34,227 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,227 - app.api.routes.portfolio_funds - ERROR -    üìÅ Fund ID 2163: 2 transactions
2025-11-25 21:20:34,228 - app.api.routes.portfolio_funds - ERROR -         1. 2024-01-01 | ¬£      100.00 | Investment           | NEGATIVE (investment)   
2025-11-25 21:20:34,228 - app.api.routes.portfolio_funds - ERROR -         2. 2024-03-01 | ¬£      110.00 | Withdrawal           | POSITIVE (withdrawal)   
2025-11-25 21:20:34,228 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,229 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,229 - app.api.routes.portfolio_funds - ERROR - üí∞ MONTHLY CASH FLOW TOTALS:
2025-11-25 21:20:34,229 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,229 - app.api.routes.portfolio_funds - ERROR -      1. 2024-01-01 (activities)                  | ¬£        -100.00 | OUTFLOW (negative)
2025-11-25 21:20:34,230 - app.api.routes.portfolio_funds - ERROR -      2. 2024-03-01 (FINAL VALUATION)             | ¬£         110.00 | INFLOW (positive)
2025-11-25 21:20:34,230 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,230 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,230 - app.api.routes.portfolio_funds - ERROR - üìä SUMMARY STATISTICS:
2025-11-25 21:20:34,230 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,231 - app.api.routes.portfolio_funds - ERROR -    Total Cash Flow Periods: 2
2025-11-25 21:20:34,231 - app.api.routes.portfolio_funds - ERROR -    Total Valuation: ¬£0.00
2025-11-25 21:20:34,231 - app.api.routes.portfolio_funds - ERROR -    Fund Valuations: {2163: 0.0}
2025-11-25 21:20:34,231 - app.api.routes.portfolio_funds - ERROR -    Period: 2024-01-01 to 2024-03-01
2025-11-25 21:20:34,232 - app.api.routes.portfolio_funds - ERROR - ================================================================================
2025-11-25 21:20:34,232 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,232 - app.api.routes.portfolio_funds - INFO - Calculating IRR using numpy_financial.irr...
2025-11-25 21:20:34,233 - app.api.routes.portfolio_funds - INFO - Raw monthly IRR calculation result: 0.04880884817015185
2025-11-25 21:20:34,233 - app.api.routes.portfolio_funds - INFO - Annualized IRR (monthly_irr * 12): 0.5857061780418222
2025-11-25 21:20:34,234 - app.api.routes.portfolio_funds - INFO - Days in period: 60
2025-11-25 21:20:34,234 - app.api.routes.portfolio_funds - INFO -
IRR Results:
2025-11-25 21:20:34,234 - app.api.routes.portfolio_funds - INFO - Monthly IRR: 4.8809%
2025-11-25 21:20:34,234 - app.api.routes.portfolio_funds - INFO - Annualized IRR: 58.5706%
2025-11-25 21:20:34,234 - app.api.routes.portfolio_funds - INFO - Months in period: 3
2025-11-25 21:20:34,235 - app.api.routes.portfolio_funds - INFO - Array size used: 3
2025-11-25 21:20:34,235 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,235 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,235 - app.api.routes.portfolio_funds - ERROR - ‚úÖ FINAL IRR CALCULATION RESULT:
2025-11-25 21:20:34,236 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,236 - app.api.routes.portfolio_funds - ERROR -    IRR (Decimal): 0.5857061780418222
2025-11-25 21:20:34,236 - app.api.routes.portfolio_funds - ERROR -    IRR (Percentage): 58.57%
2025-11-25 21:20:34,236 - app.api.routes.portfolio_funds - ERROR -    Days in Period: 60
2025-11-25 21:20:34,236 - app.api.routes.portfolio_funds - ERROR -    Cash Flow Periods: 2
2025-11-25 21:20:34,237 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:20:34,237 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:20:34,237 - app.api.routes.portfolio_funds - INFO - üìä IRR Calculation Complete: 58.6% over 60 days (2 cash flow periods)
INFO:     ('127.0.0.1', 60292) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 60345) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
2025-11-25 21:20:44,789 - app.api.routes.portfolio_funds - INFO - Updating portfolio fund 2163 with data: {'status': 'active'}
2025-11-25 21:20:44,798 - app.api.routes.portfolio_funds - INFO - Serialized fund data: {'id': 2163, 'portfolio_id': 448, 'available_funds_id': 16, 'target_weighting': None, 'amount_invested': 0.0, 'start_date': '2023-11-17', 'end_date': None, 'status': 'active', 'created_at': '2025-11-17T11:51:36.760506+00:00'}
2025-11-25 21:20:45,989 - app.api.routes.client_products - INFO - Fetching complete product details for product ID: 435
2025-11-25 21:20:45,992 - app.api.routes.client_products - INFO - Found product: Investment Bond (ID: 435)
INFO:     connection closed
2025-11-25 21:20:46,018 - app.api.routes.presence - WARNING - Failed to send message to user 3: received 1000 (OK) Component unmounting; then sent 1000 (OK) Component unmounting
2025-11-25 21:20:46,098 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] ==================== FETCHING LATEST IRR ====================
2025-11-25 21:20:46,099 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] Portfolio ID: 448
2025-11-25 21:20:46,103 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] View query result: <Record portfolio_id=448 irr_result=Decimal('58.6000') date=datetime.date(2024, 3, 1)>
2025-11-25 21:20:46,107 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] Raw table query result: <Record portfolio_id=448 irr_result=Decimal('58.6000') date=datetime.date(2024, 3, 1)>
INFO:     ('127.0.0.1', 64170) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 49597) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
2025-11-25 21:20:50,726 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:20:50,730 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
INFO:     Shutting down
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     Waiting for application shutdown.
2025-11-25 21:25:40,313 - main - INFO - Shutting down application...
2025-11-25 21:25:40,313 - database - INFO - Closing PostgreSQL connection pool...
2025-11-25 21:25:40,354 - database - INFO - PostgreSQL connection pool closed successfully
2025-11-25 21:25:40,355 - main - INFO - Database connection pool closed successfully
2025-11-25 21:25:40,355 - main - INFO - Application shutdown completed successfully
INFO:     Application shutdown complete.
INFO:     Finished server process [11692]
INFO:     Stopping reloader process [17072]
(venv) PS C:\Users\jacob\Documents\kingstons_portal\backend> ^C
(venv) PS C:\Users\jacob\Documents\kingstons_portal\backend> uvicorn main:app --reload --port 8001
INFO:     Will watch for changes in these directories: ['C:\\Users\\jacob\\Documents\\kingstons_portal\\backend']
INFO:     Uvicorn running on http://127.0.0.1:8001 (Press CTRL+C to quit)
INFO:     Started reloader process [31768] using WatchFiles
2025-11-25 21:25:44,608 - main - INFO - Application startup initiated
2025-11-25 21:25:44,608 - main - INFO - Python version: 3.11.9 (tags/v3.11.9:de54cf5, Apr  2 2024, 10:12:12) [MSC v.1938 64 bit (AMD64)]
2025-11-25 21:25:44,608 - main - INFO - Current working directory: C:\Users\jacob\Documents\kingstons_portal\backend
2025-11-25 21:25:44,610 - main - INFO - Added to Python path: C:\Users\jacob\Documents\kingstons_portal\backend
2025-11-25 21:25:45,580 - main - INFO - All modules imported successfully
2025-11-25 21:25:45,738 - database - INFO - Environment variables loaded
2025-11-25 21:25:45,738 - database - INFO - Database URL present: True
C:\Users\jacob\Documents\kingstons_portal\backend\venv\Lib\site-packages\pydantic\_internal\_config.py:321: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Started server process [34376]
INFO:     Waiting for application startup.
2025-11-25 21:25:47,396 - main - INFO - Initializing database connection pool...
2025-11-25 21:25:47,396 - database - INFO - Creating PostgreSQL connection pool...
2025-11-25 21:25:48,105 - database - INFO - PostgreSQL connection pool created successfully (min: 5, max: 20)
2025-11-25 21:25:48,109 - database - INFO - Database connection test successful: 1
2025-11-25 21:25:48,132 - database - INFO - Database verification: 262 client products found
2025-11-25 21:25:48,134 - main - INFO - Database connection pool initialized successfully
2025-11-25 21:25:48,135 - main - INFO - Started periodic presence cleanup task
2025-11-25 21:25:48,135 - main - INFO - Application startup completed successfully
INFO:     Application startup complete.
INFO:     ('127.0.0.1', 52620) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 60555) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-444" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 61943) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-444" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 49677) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-444" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 57762) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-444" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 51426) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 60237) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 62005) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-444" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 52865) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 63751) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 62917) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 60269) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-444" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 57389) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 57539) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 62032) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 65339) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-444" [accepted]
INFO:     connection open
2025-11-25 21:25:52,060 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:25:52,067 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:25:52,070 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:25:52,077 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
2025-11-25 21:25:52,212 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:25:52,220 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:02,744 - app.api.routes.available_providers - INFO - Fetching available providers with skip=0, limit=100000
2025-11-25 21:26:02,784 - app.api.routes.available_providers - INFO - Query returned 22 providers
2025-11-25 21:26:03,037 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,048 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,058 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,061 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,131 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,134 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,135 - app.api.routes.client_products - INFO - Fetching complete product details for product ID: 435
2025-11-25 21:26:03,135 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,143 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,152 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,155 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,155 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,156 - app.api.routes.client_products - INFO - Found product: Investment Bond (ID: 435)
2025-11-25 21:26:03,156 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,171 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,177 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,179 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,180 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,183 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,193 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,202 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,208 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,405 - app.api.routes.client_products - INFO - Fetching complete product details for product ID: 435
2025-11-25 21:26:03,407 - app.api.routes.client_products - INFO - Found product: Investment Bond (ID: 435)
2025-11-25 21:26:03,435 - app.api.routes.available_providers - INFO - Fetching available providers with skip=0, limit=100000
2025-11-25 21:26:03,436 - app.api.routes.client_products - INFO - Fetching complete product details for product ID: 435
2025-11-25 21:26:03,446 - app.api.routes.available_providers - INFO - Query returned 22 providers
INFO:     ('127.0.0.1', 49755) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
2025-11-25 21:26:03,460 - app.api.routes.client_products - INFO - Found product: Investment Bond (ID: 435)
2025-11-25 21:26:03,531 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,540 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] ==================== FETCHING LATEST IRR ====================
2025-11-25 21:26:03,540 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] Portfolio ID: 448
2025-11-25 21:26:03,546 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,556 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] View query result: <Record portfolio_id=448 irr_result=Decimal('58.6000') date=datetime.date(2024, 3, 1)>
2025-11-25 21:26:03,560 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] Raw table query result: <Record portfolio_id=448 irr_result=Decimal('58.6000') date=datetime.date(2024, 3, 1)>
2025-11-25 21:26:03,562 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,565 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,603 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,604 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,605 - app.api.routes.client_products - INFO - Fetching complete product details for product ID: 444
2025-11-25 21:26:03,606 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,614 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,618 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,620 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,622 - app.api.routes.client_products - INFO - Found product: Investment Bond (ID: 444)
2025-11-25 21:26:03,628 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,629 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,631 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,636 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,639 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,640 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,655 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,658 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,660 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:03,662 - app.api.routes.auth - INFO - User authenticated via cookie token: 3
2025-11-25 21:26:03,664 - app.api.routes.client_products - INFO - Fetching complete product details for product ID: 435
2025-11-25 21:26:03,666 - app.api.routes.client_products - INFO - Found product: Investment Bond (ID: 435)
2025-11-25 21:26:03,824 - app.api.routes.client_products - INFO - Fetching complete product details for product ID: 444
2025-11-25 21:26:03,826 - app.api.routes.client_products - INFO - Found product: Investment Bond (ID: 444)
INFO:     ('127.0.0.1', 59594) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-444" [accepted]
INFO:     connection open
2025-11-25 21:26:04,285 - app.api.routes.client_products - INFO - Fetching complete product details for product ID: 444
INFO:     ('127.0.0.1', 50040) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
2025-11-25 21:26:04,291 - app.api.routes.client_products - INFO - Found product: Investment Bond (ID: 444)
2025-11-25 21:26:04,331 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] ==================== FETCHING LATEST IRR ====================
2025-11-25 21:26:04,332 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] Portfolio ID: 462
2025-11-25 21:26:04,336 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] View query result: <Record portfolio_id=462 irr_result=Decimal('40.2000') date=datetime.date(2025, 4, 1)>
2025-11-25 21:26:04,337 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] Raw table query result: <Record portfolio_id=462 irr_result=Decimal('40.2000') date=datetime.date(2025, 4, 1)>
2025-11-25 21:26:04,409 - app.api.routes.client_products - INFO - Fetching complete product details for product ID: 444
2025-11-25 21:26:04,410 - app.api.routes.client_products - INFO - Found product: Investment Bond (ID: 444)
INFO:     ('127.0.0.1', 60632) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-444" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 58169) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 52760) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 65060) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 61716) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-444" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 62056) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-444" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 58586) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-444" [accepted]
INFO:     connection open
2025-11-25 21:26:16,515 - app.api.routes.portfolio_funds - INFO - Updating portfolio fund 2163 with data: {'status': 'inactive'}
2025-11-25 21:26:16,525 - app.api.routes.portfolio_funds - INFO - Serialized fund data: {'id': 2163, 'portfolio_id': 448, 'available_funds_id': 16, 'target_weighting': None, 'amount_invested': 0.0, 'start_date': '2023-11-17', 'end_date': None, 'status': 'inactive', 'created_at': '2025-11-17T11:51:36.760506+00:00'}
2025-11-25 21:26:16,604 - app.api.routes.client_products - INFO - Fetching complete product details for product ID: 435
INFO:     connection closed
2025-11-25 21:26:16,612 - app.api.routes.client_products - INFO - Found product: Investment Bond (ID: 435)
2025-11-25 21:26:16,645 - app.api.routes.presence - WARNING - Failed to send message to user 3: received 1000 (OK) Component unmounting; then sent 1000 (OK) Component unmounting
2025-11-25 21:26:16,870 - app.api.routes.portfolio_funds - INFO - Calculating aggregated IRR for 1 portfolio funds
2025-11-25 21:26:16,870 - app.api.routes.portfolio_funds - INFO - No IRR date provided, finding latest valuation date
2025-11-25 21:26:16,877 - app.api.routes.portfolio_funds - INFO - Calculating aggregated IRR for 1 portfolio funds
2025-11-25 21:26:16,878 - app.api.routes.portfolio_funds - INFO - No IRR date provided, finding latest valuation date
2025-11-25 21:26:16,892 - app.api.routes.portfolio_funds - INFO - Using latest valuation date: 2024-03-01
2025-11-25 21:26:16,893 - app.api.routes.portfolio_funds - INFO - IRR calculation date: 2024-03-01
2025-11-25 21:26:16,893 - app.api.routes.portfolio_funds - INFO - üöÄ Batch fetching valuations for 1 funds (eliminates 1 individual requests)
2025-11-25 21:26:17,145 - app.api.routes.portfolio_funds - INFO - Using latest valuation date: 2024-03-01
2025-11-25 21:26:17,145 - app.api.routes.portfolio_funds - INFO - IRR calculation date: 2024-03-01
2025-11-25 21:26:17,145 - app.api.routes.portfolio_funds - INFO - üöÄ Batch fetching valuations for 1 funds (eliminates 1 individual requests)
2025-11-25 21:26:17,146 - app.api.routes.portfolio_funds - INFO - ‚úÖ Batch valuation optimization complete - Fund valuations: {2163: 0.0}
2025-11-25 21:26:17,151 - app.api.routes.portfolio_funds - INFO - ‚úÖ Batch valuation optimization complete - Fund valuations: {2163: 0.0}
2025-11-25 21:26:17,155 - app.api.routes.portfolio_funds - INFO - üìä Processing 2 activities across 1 funds
2025-11-25 21:26:17,155 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:26:17,155 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,156 - app.api.routes.portfolio_funds - ERROR - üîç IRR CALCULATION DEBUG - Portfolio Funds: [2163]
2025-11-25 21:26:17,156 - app.api.routes.portfolio_funds - ERROR - üîç Calculation Date: 2024-03-01
2025-11-25 21:26:17,156 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,157 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:26:17,157 - app.api.routes.portfolio_funds - ERROR - üìã ALL TRANSACTIONS INCLUDED IN CALCULATION:
2025-11-25 21:26:17,157 - app.api.routes.portfolio_funds - ERROR -    Total Activities: 2
2025-11-25 21:26:17,158 - app.api.routes.portfolio_funds - ERROR - 
2025-11-25 21:26:17,158 - app.api.routes.portfolio_funds - ERROR -    üìÅ Fund ID 2163: 2 transactions
2025-11-25 21:26:17,158 - app.api.routes.portfolio_funds - ERROR -         1. 2024-01-01 | ¬£      100.00 | Investment           | NEGATIVE (investment)   
2025-11-25 21:26:17,158 - app.api.routes.portfolio_funds - ERROR -         2. 2024-03-01 | ¬£      110.00 | Withdrawal           | POSITIVE (withdrawal)   
2025-11-25 21:26:17,159 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:26:17,159 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,159 - app.api.routes.portfolio_funds - ERROR - üí∞ MONTHLY CASH FLOW TOTALS:
2025-11-25 21:26:17,159 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,160 - app.api.routes.portfolio_funds - ERROR -      1. 2024-01-01 (activities)                  | ¬£        -100.00 | OUTFLOW (negative)
2025-11-25 21:26:17,160 - app.api.routes.portfolio_funds - ERROR -      2. 2024-03-01 (FINAL VALUATION)             | ¬£         110.00 | INFLOW (positive)
2025-11-25 21:26:17,160 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:26:17,161 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,161 - app.api.routes.portfolio_funds - ERROR - üìä SUMMARY STATISTICS:
2025-11-25 21:26:17,161 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,161 - app.api.routes.portfolio_funds - ERROR -    Total Cash Flow Periods: 2
2025-11-25 21:26:17,162 - app.api.routes.portfolio_funds - ERROR -    Total Valuation: ¬£0.00
2025-11-25 21:26:17,162 - app.api.routes.portfolio_funds - ERROR -    Fund Valuations: {2163: 0.0}
2025-11-25 21:26:17,162 - app.api.routes.portfolio_funds - ERROR -    Period: 2024-01-01 to 2024-03-01
2025-11-25 21:26:17,162 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,163 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:26:17,163 - app.api.routes.portfolio_funds - INFO - Calculating IRR using numpy_financial.irr...
2025-11-25 21:26:17,164 - app.api.routes.portfolio_funds - INFO - Raw monthly IRR calculation result: 0.04880884817015185
2025-11-25 21:26:17,164 - app.api.routes.portfolio_funds - INFO - Annualized IRR (monthly_irr * 12): 0.5857061780418222
2025-11-25 21:26:17,165 - app.api.routes.portfolio_funds - INFO - Days in period: 60
2025-11-25 21:26:17,165 - app.api.routes.portfolio_funds - INFO -
IRR Results:
2025-11-25 21:26:17,165 - app.api.routes.portfolio_funds - INFO - Monthly IRR: 4.8809%
2025-11-25 21:26:17,165 - app.api.routes.portfolio_funds - INFO - Annualized IRR: 58.5706%
2025-11-25 21:26:17,165 - app.api.routes.portfolio_funds - INFO - Months in period: 3
2025-11-25 21:26:17,165 - app.api.routes.portfolio_funds - INFO - Array size used: 3
2025-11-25 21:26:17,166 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:26:17,166 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,166 - app.api.routes.portfolio_funds - ERROR - ‚úÖ FINAL IRR CALCULATION RESULT:
2025-11-25 21:26:17,166 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,166 - app.api.routes.portfolio_funds - ERROR -    IRR (Decimal): 0.5857061780418222
2025-11-25 21:26:17,167 - app.api.routes.portfolio_funds - ERROR -    IRR (Percentage): 58.57%
2025-11-25 21:26:17,167 - app.api.routes.portfolio_funds - ERROR -    Days in Period: 60
2025-11-25 21:26:17,167 - app.api.routes.portfolio_funds - ERROR -    Cash Flow Periods: 2
2025-11-25 21:26:17,167 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,167 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:26:17,168 - app.api.routes.portfolio_funds - INFO - üìä IRR Calculation Complete: 58.6% over 60 days (2 cash flow periods)
2025-11-25 21:26:17,197 - app.api.routes.portfolio_funds - INFO - üìä Processing 2 activities across 1 funds
2025-11-25 21:26:17,198 - app.api.routes.portfolio_funds - ERROR - 
2025-11-25 21:26:17,198 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,198 - app.api.routes.portfolio_funds - ERROR - üîç IRR CALCULATION DEBUG - Portfolio Funds: [2163]
2025-11-25 21:26:17,199 - app.api.routes.portfolio_funds - ERROR - üîç Calculation Date: 2024-03-01
2025-11-25 21:26:17,199 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,199 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:26:17,199 - app.api.routes.portfolio_funds - ERROR - üìã ALL TRANSACTIONS INCLUDED IN CALCULATION:
2025-11-25 21:26:17,199 - app.api.routes.portfolio_funds - ERROR -    Total Activities: 2
2025-11-25 21:26:17,199 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:26:17,199 - app.api.routes.portfolio_funds - ERROR -    üìÅ Fund ID 2163: 2 transactions
2025-11-25 21:26:17,199 - app.api.routes.portfolio_funds - ERROR -         1. 2024-01-01 | ¬£      100.00 | Investment           | NEGATIVE (investment)   
2025-11-25 21:26:17,200 - app.api.routes.portfolio_funds - ERROR -         2. 2024-03-01 | ¬£      110.00 | Withdrawal           | POSITIVE (withdrawal)   
2025-11-25 21:26:17,200 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:26:17,200 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,200 - app.api.routes.portfolio_funds - ERROR - üí∞ MONTHLY CASH FLOW TOTALS:
2025-11-25 21:26:17,200 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,200 - app.api.routes.portfolio_funds - ERROR -      1. 2024-01-01 (activities)                  | ¬£        -100.00 | OUTFLOW (negative)
2025-11-25 21:26:17,201 - app.api.routes.portfolio_funds - ERROR -      2. 2024-03-01 (FINAL VALUATION)             | ¬£         110.00 | INFLOW (positive)
2025-11-25 21:26:17,201 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:26:17,201 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,201 - app.api.routes.portfolio_funds - ERROR - üìä SUMMARY STATISTICS:
2025-11-25 21:26:17,201 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,202 - app.api.routes.portfolio_funds - ERROR -    Total Cash Flow Periods: 2
2025-11-25 21:26:17,202 - app.api.routes.portfolio_funds - ERROR -    Total Valuation: ¬£0.00
2025-11-25 21:26:17,202 - app.api.routes.portfolio_funds - ERROR -    Fund Valuations: {2163: 0.0}
2025-11-25 21:26:17,202 - app.api.routes.portfolio_funds - ERROR -    Period: 2024-01-01 to 2024-03-01
2025-11-25 21:26:17,202 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,202 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:26:17,202 - app.api.routes.portfolio_funds - INFO - Calculating IRR using numpy_financial.irr...
2025-11-25 21:26:17,204 - app.api.routes.portfolio_funds - INFO - Raw monthly IRR calculation result: 0.04880884817015185
2025-11-25 21:26:17,204 - app.api.routes.portfolio_funds - INFO - Annualized IRR (monthly_irr * 12): 0.5857061780418222
2025-11-25 21:26:17,204 - app.api.routes.portfolio_funds - INFO - Days in period: 60
2025-11-25 21:26:17,205 - app.api.routes.portfolio_funds - INFO -
IRR Results:
2025-11-25 21:26:17,205 - app.api.routes.portfolio_funds - INFO - Monthly IRR: 4.8809%
2025-11-25 21:26:17,205 - app.api.routes.portfolio_funds - INFO - Annualized IRR: 58.5706%
2025-11-25 21:26:17,205 - app.api.routes.portfolio_funds - INFO - Months in period: 3
2025-11-25 21:26:17,206 - app.api.routes.portfolio_funds - INFO - Array size used: 3
2025-11-25 21:26:17,206 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:26:17,206 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,206 - app.api.routes.portfolio_funds - ERROR - ‚úÖ FINAL IRR CALCULATION RESULT:
2025-11-25 21:26:17,207 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,207 - app.api.routes.portfolio_funds - ERROR -    IRR (Decimal): 0.5857061780418222
2025-11-25 21:26:17,207 - app.api.routes.portfolio_funds - ERROR -    IRR (Percentage): 58.57%
2025-11-25 21:26:17,207 - app.api.routes.portfolio_funds - ERROR -    Days in Period: 60
2025-11-25 21:26:17,208 - app.api.routes.portfolio_funds - ERROR -    Cash Flow Periods: 2
2025-11-25 21:26:17,208 - app.api.routes.portfolio_funds - ERROR - ================================================================================       
2025-11-25 21:26:17,208 - app.api.routes.portfolio_funds - ERROR -
2025-11-25 21:26:17,208 - app.api.routes.portfolio_funds - INFO - üìä IRR Calculation Complete: 58.6% over 60 days (2 cash flow periods)
INFO:     ('127.0.0.1', 49736) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 60636) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
2025-11-25 21:26:22,112 - app.api.routes.portfolio_funds - INFO - Updating portfolio fund 2163 with data: {'status': 'active'}
2025-11-25 21:26:22,115 - app.api.routes.portfolio_funds - INFO - Serialized fund data: {'id': 2163, 'portfolio_id': 448, 'available_funds_id': 16, 'target_weighting': None, 'amount_invested': 0.0, 'start_date': '2023-11-17', 'end_date': None, 'status': 'active', 'created_at': '2025-11-17T11:51:36.760506+00:00'}
2025-11-25 21:26:23,233 - app.api.routes.client_products - INFO - Fetching complete product details for product ID: 435
2025-11-25 21:26:23,236 - app.api.routes.client_products - INFO - Found product: Investment Bond (ID: 435)
INFO:     connection closed
2025-11-25 21:26:23,276 - app.api.routes.presence - WARNING - Failed to send message to user 3: received 1000 (OK) Component unmounting; then sent 1000 (OK) Component unmounting
2025-11-25 21:26:23,346 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] ==================== FETCHING LATEST IRR ====================
2025-11-25 21:26:23,347 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] Portfolio ID: 448
2025-11-25 21:26:23,350 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] View query result: <Record portfolio_id=448 irr_result=Decimal('58.6000') date=datetime.date(2024, 3, 1)>
2025-11-25 21:26:23,354 - app.api.routes.portfolios - INFO - üîç [IRR FETCH DEBUG] Raw table query result: <Record portfolio_id=448 irr_result=Decimal('58.6000') date=datetime.date(2024, 3, 1)>
INFO:     ('127.0.0.1', 60460) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
INFO:     ('127.0.0.1', 52316) - "WebSocket /api/ws/presence/irr-calculation%3Aproduct-435" [accepted]
INFO:     connection open
2025-11-25 21:26:27,148 - app.api.routes.auth - INFO - Authentication attempt - Cookie Token: True, Header Token: False, Session: True
2025-11-25 21:26:27,152 - app.api.routes.auth - INFO - User authenticated via cookie token: 3