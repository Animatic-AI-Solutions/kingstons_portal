/**
 * Health & Vulnerabilities Feature Integration Tests (Cycle 14 - RED Phase)
 *
 * Comprehensive integration tests for the Health & Vulnerabilities feature.
 * Tests the full component integration WITHOUT mocking child components.
 * Tests real user flows through the entire feature.
 *
 * Test Coverage (30+ tests):
 * 1. Full User Journey - Health Tab (5 tests)
 * 2. Full User Journey - Vulnerabilities Tab (5 tests)
 * 3. Error Scenarios (3 tests)
 * 4. Accessibility - Full Component (3 tests)
 * 5. Keyboard Navigation End-to-End (5 tests)
 * 6. Data Persistence (3 tests)
 * 7. Edge Cases (3 tests)
 * 8. Special Relationships (2 tests)
 * 9. Smoking Sorting (1 test)
 *
 * @module tests/integration/HealthVulnerabilityIntegration
 */

import React from 'react';
import { render, screen, waitFor, within, act } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { axe, toHaveNoViolations } from 'jest-axe';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

// Import the main component we're testing
import HealthVulnerabilityTab from '@/components/phase2/health-vulnerabilities/HealthVulnerabilityTab';

// Import types for mock data
import type {
  HealthProductOwner,
  HealthSpecialRelationship,
  VulnerabilityProductOwner,
  VulnerabilitySpecialRelationship,
} from '@/types/healthVulnerability';
import type { ProductOwner } from '@/types/productOwner';
import type { SpecialRelationship } from '@/types/specialRelationship';

// Extend Jest matchers with jest-axe
expect.extend(toHaveNoViolations);

// =============================================================================
// Mock Setup - Mock hooks at the module level
// =============================================================================

// Mock useProductOwners hook
jest.mock('@/hooks/useProductOwners', () => ({
  useProductOwners: jest.fn(),
}));

// Mock useSpecialRelationships hook
jest.mock('@/hooks/useSpecialRelationships', () => ({
  useSpecialRelationships: jest.fn(),
}));

// Mock useHealthVulnerabilities hooks
jest.mock('@/hooks/useHealthVulnerabilities', () => ({
  useHealthProductOwners: jest.fn(),
  useHealthSpecialRelationships: jest.fn(),
  useVulnerabilitiesProductOwners: jest.fn(),
  useVulnerabilitiesSpecialRelationships: jest.fn(),
  useCreateHealthRecord: jest.fn(),
  useUpdateHealthRecord: jest.fn(),
  useDeleteHealthRecord: jest.fn(),
  useCreateVulnerability: jest.fn(),
  useUpdateVulnerability: jest.fn(),
  useDeleteVulnerability: jest.fn(),
}));

// Import mocked modules for type-safe access
import { useProductOwners } from '@/hooks/useProductOwners';
import { useSpecialRelationships } from '@/hooks/useSpecialRelationships';
import {
  useHealthProductOwners,
  useHealthSpecialRelationships,
  useVulnerabilitiesProductOwners,
  useVulnerabilitiesSpecialRelationships,
  useCreateHealthRecord,
  useUpdateHealthRecord,
  useDeleteHealthRecord,
  useCreateVulnerability,
  useUpdateVulnerability,
  useDeleteVulnerability,
} from '@/hooks/useHealthVulnerabilities';

// =============================================================================
// Mock Data
// =============================================================================

const mockProductOwners: ProductOwner[] = [
  {
    id: 1,
    firstname: 'John',
    surname: 'Smith',
    status: 'active',
    known_as: null,
    title: 'Mr',
    middle_names: null,
    relationship_status: 'Married',
    gender: 'Male',
    previous_names: null,
    dob: '1970-05-15',
    place_of_birth: 'London',
    email_1: 'john@example.com',
    email_2: null,
    phone_1: '07700900001',
    phone_2: null,
    moved_in_date: null,
    address_id: 1,
    address_line_1: '123 Main St',
    address_line_2: null,
    address_line_3: 'London',
    address_line_4: null,
    address_line_5: 'SW1A 1AA',
    three_words: null,
    share_data_with: null,
    employment_status: 'Retired',
    occupation: null,
    passport_expiry_date: null,
    ni_number: null,
    aml_result: null,
    aml_date: null,
    created_at: '2020-01-01T00:00:00Z',
  },
  {
    id: 2,
    firstname: 'Jane',
    surname: 'Doe',
    status: 'active',
    known_as: null,
    title: 'Mrs',
    middle_names: null,
    relationship_status: 'Married',
    gender: 'Female',
    previous_names: null,
    dob: '1972-08-20',
    place_of_birth: 'Manchester',
    email_1: 'jane@example.com',
    email_2: null,
    phone_1: '07700900002',
    phone_2: null,
    moved_in_date: null,
    address_id: 1,
    address_line_1: '123 Main St',
    address_line_2: null,
    address_line_3: 'London',
    address_line_4: null,
    address_line_5: 'SW1A 1AA',
    three_words: null,
    share_data_with: null,
    employment_status: 'Employed',
    occupation: null,
    passport_expiry_date: null,
    ni_number: null,
    aml_result: null,
    aml_date: null,
    created_at: '2020-01-01T00:00:00Z',
  },
];

const mockSpecialRelationships: SpecialRelationship[] = [
  {
    id: 10,
    name: 'Tom Smith',
    type: 'Personal',
    relationship: 'Child',
    status: 'Active',
    date_of_birth: '2000-03-10',
    dependency: true,
    email: 'tom@example.com',
    phone_number: '07700900010',
    address_id: null,
    notes: null,
    firm_name: null,
    product_owner_ids: [1, 2],
    created_at: '2020-02-01T00:00:00Z',
    updated_at: '2024-01-01T00:00:00Z',
  },
];

const mockHealthPO: HealthProductOwner[] = [
  {
    id: 1,
    product_owner_id: 1,
    condition: 'Smoking Status',
    name: 'Current Smoker',
    status: 'Active',
    date_of_diagnosis: '2024-01-01',
    medication: null,
    notes: '10 cigarettes per day',
    created_at: '2024-01-01T00:00:00Z',
    date_recorded: '2024-01-01',
  },
  {
    id: 2,
    product_owner_id: 1,
    condition: 'Diabetes',
    name: 'Type 2',
    status: 'Active',
    date_of_diagnosis: '2023-06-01',
    medication: 'Metformin',
    notes: 'Well controlled',
    created_at: '2023-06-01T00:00:00Z',
    date_recorded: '2023-06-01',
  },
  {
    id: 4,
    product_owner_id: 1,
    condition: 'Heart Condition',
    name: 'High Blood Pressure',
    status: 'Lapsed',
    date_of_diagnosis: '2020-01-01',
    medication: 'Lisinopril',
    notes: 'Resolved with treatment',
    created_at: '2020-01-01T00:00:00Z',
    date_recorded: '2020-01-01',
  },
];

const mockHealthSR: HealthSpecialRelationship[] = [
  {
    id: 3,
    special_relationship_id: 10,
    condition: 'Respiratory Condition',
    name: 'Asthma',
    status: 'Active',
    date_of_diagnosis: '2024-02-01',
    medication: 'Inhaler',
    notes: 'Mild',
    created_at: '2024-02-01T00:00:00Z',
    date_recorded: '2024-02-01',
  },
];

const mockVulnPO: VulnerabilityProductOwner[] = [
  {
    id: 1,
    product_owner_id: 1,
    description: 'Hearing impairment',
    diagnosed: true,
    status: 'Active',
    adjustments: 'Speak clearly',
    date_recorded: '2024-01-01',
    notes: 'Mild hearing loss',
    created_at: '2024-01-01T00:00:00Z',
  },
];

const mockVulnSR: VulnerabilitySpecialRelationship[] = [];

// =============================================================================
// Test Utilities
// =============================================================================

/**
 * Creates a wrapper with QueryClient for React Query context
 * Disables retry and sets appropriate cache settings for testing
 */
const createWrapper = () => {
  const queryClient = new QueryClient({
    defaultOptions: {
      queries: { retry: false, gcTime: 0, staleTime: 0 },
      mutations: { retry: false },
    },
  });
  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  );
};

/**
 * Setup default mock return values for all hooks
 */
const setupDefaultMocks = () => {
  const mockRefetchPO = jest.fn().mockResolvedValue({ data: mockProductOwners });
  const mockRefetchSR = jest.fn().mockResolvedValue({ data: mockSpecialRelationships });

  (useProductOwners as jest.Mock).mockReturnValue({
    data: mockProductOwners,
    isLoading: false,
    isError: false,
    error: null,
    refetch: mockRefetchPO,
  });

  (useSpecialRelationships as jest.Mock).mockReturnValue({
    data: mockSpecialRelationships,
    isLoading: false,
    isError: false,
    error: null,
    refetch: mockRefetchSR,
  });

  (useHealthProductOwners as jest.Mock).mockReturnValue({
    data: mockHealthPO,
    isLoading: false,
    isError: false,
    error: null,
  });

  (useHealthSpecialRelationships as jest.Mock).mockReturnValue({
    data: mockHealthSR,
    isLoading: false,
    isError: false,
    error: null,
  });

  (useVulnerabilitiesProductOwners as jest.Mock).mockReturnValue({
    data: mockVulnPO,
    isLoading: false,
    isError: false,
    error: null,
  });

  (useVulnerabilitiesSpecialRelationships as jest.Mock).mockReturnValue({
    data: mockVulnSR,
    isLoading: false,
    isError: false,
    error: null,
  });

  // Mock mutations
  (useCreateHealthRecord as jest.Mock).mockReturnValue({
    mutateAsync: jest.fn().mockResolvedValue({ id: 100 }),
    isPending: false,
  });

  (useUpdateHealthRecord as jest.Mock).mockReturnValue({
    mutateAsync: jest.fn().mockResolvedValue({ id: 1 }),
    isPending: false,
  });

  (useDeleteHealthRecord as jest.Mock).mockReturnValue({
    mutateAsync: jest.fn().mockResolvedValue(undefined),
    isPending: false,
  });

  (useCreateVulnerability as jest.Mock).mockReturnValue({
    mutateAsync: jest.fn().mockResolvedValue({ id: 100 }),
    isPending: false,
  });

  (useUpdateVulnerability as jest.Mock).mockReturnValue({
    mutateAsync: jest.fn().mockResolvedValue({ id: 1 }),
    isPending: false,
  });

  (useDeleteVulnerability as jest.Mock).mockReturnValue({
    mutateAsync: jest.fn().mockResolvedValue(undefined),
    isPending: false,
  });

  return { mockRefetchPO, mockRefetchSR };
};

// =============================================================================
// Test Suite
// =============================================================================

describe('HealthVulnerabilityTab Integration Tests', () => {
  beforeEach(() => {
    jest.clearAllMocks();
    setupDefaultMocks();
  });

  // ===========================================================================
  // 1. Full User Journey - Health Tab (5 tests)
  // ===========================================================================

  describe('Full User Journey - Health Tab', () => {
    it('should load and display health data with product owners and special relationships', async () => {
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      // Wait for data to load and verify product owners are displayed
      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
        expect(screen.getByText('Jane Doe')).toBeInTheDocument();
      });

      // Verify special relationship is displayed with SR indicator
      expect(screen.getByText('Tom Smith')).toBeInTheDocument();
      expect(screen.getByText('SR')).toBeInTheDocument();
    });

    it('should expand row and show health conditions table', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Click on John Smith row to expand
      await user.click(screen.getByText('John Smith'));

      // Should show health conditions - both should appear
      await waitFor(() => {
        expect(screen.getByText('Current Smoker')).toBeInTheDocument();
        expect(screen.getByText('Type 2')).toBeInTheDocument();
      });
    });

    it('should open add modal and create health record when form is submitted', async () => {
      const mockCreate = jest.fn().mockResolvedValue({ id: 100 });
      (useCreateHealthRecord as jest.Mock).mockReturnValue({
        mutateAsync: mockCreate,
        isPending: false,
      });

      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Open add modal
      const addButtons = screen.getAllByRole('button', { name: /add health or vulnerability/i });
      await user.click(addButtons[0]);

      await waitFor(() => {
        expect(screen.getByRole('dialog')).toBeInTheDocument();
      });

      // Verify modal is for health condition (on health tab by default)
      const modal = screen.getByRole('dialog');
      expect(within(modal).getByText(/add health condition/i)).toBeInTheDocument();

      // Fill out the form - select a condition using the select element by its id
      const conditionSelect = within(modal).getByRole('combobox', { name: /condition/i });
      await user.selectOptions(conditionSelect, 'Diabetes');

      // Submit the form
      const saveButton = within(modal).getByRole('button', { name: /save/i });
      await user.click(saveButton);

      // Verify mutation was called with correct data
      await waitFor(() => {
        expect(mockCreate).toHaveBeenCalledWith(
          expect.objectContaining({
            data: expect.objectContaining({
              condition: 'Diabetes',
            }),
            personType: 'product_owner',
          })
        );
      });
    });

    it('should open edit modal when health condition row is clicked', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Expand John Smith row
      await user.click(screen.getByText('John Smith'));

      await waitFor(() => {
        expect(screen.getByText('Type 2')).toBeInTheDocument();
      });

      // Click on the health condition row to edit
      await user.click(screen.getByText('Type 2'));

      // Edit modal should open
      await waitFor(() => {
        expect(screen.getByRole('dialog')).toBeInTheDocument();
        expect(screen.getByText(/edit health condition/i)).toBeInTheDocument();
      });
    });

    it('should delete health condition when delete button is clicked and confirmed', async () => {
      const mockDelete = jest.fn().mockResolvedValue(undefined);
      (useDeleteHealthRecord as jest.Mock).mockReturnValue({
        mutateAsync: mockDelete,
        isPending: false,
      });

      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Expand row and find delete button
      await user.click(screen.getByText('John Smith'));

      await waitFor(() => {
        expect(screen.getByText('Current Smoker')).toBeInTheDocument();
      });

      // Find and click delete button
      const deleteButtons = screen.getAllByRole('button', { name: /delete/i });
      if (deleteButtons.length > 0) {
        await user.click(deleteButtons[0]);

        // Wait for confirmation modal and confirm
        await waitFor(() => {
          const confirmButton = screen.getByRole('button', { name: /^delete$/i });
          expect(confirmButton).toBeInTheDocument();
        });

        const confirmButton = screen.getByRole('button', { name: /^delete$/i });
        await user.click(confirmButton);

        // Mutation should be called
        await waitFor(() => {
          expect(mockDelete).toHaveBeenCalled();
        });
      }
    });
  });

  // ===========================================================================
  // 2. Full User Journey - Vulnerabilities Tab (5 tests)
  // ===========================================================================

  describe('Full User Journey - Vulnerabilities Tab', () => {
    it('should switch to vulnerabilities tab and show data', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Click on Vulnerabilities tab
      const vulnTab = screen.getByRole('tab', { name: /vulnerabilities/i });
      await user.click(vulnTab);

      // Verify tab is now active
      await waitFor(() => {
        expect(vulnTab).toHaveAttribute('aria-selected', 'true');
      });

      // Verify person table is still visible
      expect(screen.getByText('John Smith')).toBeInTheDocument();
    });

    it('should expand row and show vulnerabilities for person', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Switch to vulnerabilities tab
      const vulnTab = screen.getByRole('tab', { name: /vulnerabilities/i });
      await user.click(vulnTab);

      await waitFor(() => {
        expect(vulnTab).toHaveAttribute('aria-selected', 'true');
      });

      // Expand John Smith row
      await user.click(screen.getByText('John Smith'));

      // Should show vulnerabilities
      await waitFor(() => {
        expect(screen.getByText('Hearing impairment')).toBeInTheDocument();
      });
    });

    it('should open add modal and create vulnerability when form is submitted', async () => {
      const mockCreate = jest.fn().mockResolvedValue({ id: 100 });
      (useCreateVulnerability as jest.Mock).mockReturnValue({
        mutateAsync: mockCreate,
        isPending: false,
      });

      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Switch to vulnerabilities tab
      const vulnTab = screen.getByRole('tab', { name: /vulnerabilities/i });
      await user.click(vulnTab);

      await waitFor(() => {
        expect(vulnTab).toHaveAttribute('aria-selected', 'true');
      });

      // Click add button
      const addButtons = screen.getAllByRole('button', { name: /add health or vulnerability/i });
      await user.click(addButtons[0]);

      // Modal should open with vulnerability form fields
      await waitFor(() => {
        expect(screen.getByRole('dialog')).toBeInTheDocument();
        expect(screen.getByText(/add vulnerability/i)).toBeInTheDocument();
      });

      // Fill form
      const descriptionInput = screen.getByLabelText(/description/i);
      await user.type(descriptionInput, 'Cognitive decline');

      // Submit the form
      const saveButton = screen.getByRole('button', { name: /save/i });
      await user.click(saveButton);

      // Verify mutation was called
      await waitFor(() => {
        expect(mockCreate).toHaveBeenCalledWith(
          expect.objectContaining({
            data: expect.objectContaining({
              description: 'Cognitive decline',
            }),
            personType: 'product_owner',
          })
        );
      });
    });

    it('should open edit vulnerability modal when vulnerability row is clicked', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      // Switch to vulnerabilities tab
      const vulnTab = screen.getByRole('tab', { name: /vulnerabilities/i });
      await user.click(vulnTab);

      await waitFor(() => {
        expect(vulnTab).toHaveAttribute('aria-selected', 'true');
      });

      // Expand John Smith
      await user.click(screen.getByText('John Smith'));

      await waitFor(() => {
        expect(screen.getByText('Hearing impairment')).toBeInTheDocument();
      });

      // Click on vulnerability to edit
      await user.click(screen.getByText('Hearing impairment'));

      await waitFor(() => {
        expect(screen.getByRole('dialog')).toBeInTheDocument();
        expect(screen.getByText(/edit vulnerability/i)).toBeInTheDocument();
      });
    });

    it('should delete vulnerability when delete button is clicked and confirmed', async () => {
      const mockDelete = jest.fn().mockResolvedValue(undefined);
      (useDeleteVulnerability as jest.Mock).mockReturnValue({
        mutateAsync: mockDelete,
        isPending: false,
      });

      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      // Switch to vulnerabilities tab
      const vulnTab = screen.getByRole('tab', { name: /vulnerabilities/i });
      await user.click(vulnTab);

      await waitFor(() => {
        expect(vulnTab).toHaveAttribute('aria-selected', 'true');
      });

      // Expand John Smith
      await user.click(screen.getByText('John Smith'));

      await waitFor(() => {
        expect(screen.getByText('Hearing impairment')).toBeInTheDocument();
      });

      // Find and click delete button
      const deleteButtons = screen.getAllByRole('button', { name: /delete/i });
      if (deleteButtons.length > 0) {
        await user.click(deleteButtons[0]);

        // Wait for confirmation modal and confirm
        await waitFor(() => {
          const confirmButton = screen.getByRole('button', { name: /^delete$/i });
          expect(confirmButton).toBeInTheDocument();
        });

        const confirmButton = screen.getByRole('button', { name: /^delete$/i });
        await user.click(confirmButton);

        // Mutation should be called
        await waitFor(() => {
          expect(mockDelete).toHaveBeenCalled();
        });
      }
    });
  });

  // ===========================================================================
  // 3. Error Scenarios (3 tests)
  // ===========================================================================

  describe('Error Scenarios', () => {
    it('should handle network errors gracefully and display error message', () => {
      (useProductOwners as jest.Mock).mockReturnValue({
        data: undefined,
        isLoading: false,
        isError: true,
        error: new Error('Network error: Failed to fetch'),
        refetch: jest.fn(),
      });

      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      // Should show error message
      expect(screen.getByText(/error/i)).toBeInTheDocument();
    });

    it('should handle API failures with retry button', async () => {
      const mockRefetch = jest.fn().mockResolvedValue({ data: mockProductOwners });
      (useProductOwners as jest.Mock).mockReturnValue({
        data: undefined,
        isLoading: false,
        isError: true,
        error: new Error('500 Internal Server Error'),
        refetch: mockRefetch,
      });

      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      // Find and click retry button
      const retryButton = screen.getByRole('button', { name: /retry/i });
      await user.click(retryButton);

      expect(mockRefetch).toHaveBeenCalled();
    });

    it('should handle validation errors in add modal', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Open add modal
      const addButtons = screen.getAllByRole('button', { name: /add health or vulnerability/i });
      await user.click(addButtons[0]);

      await waitFor(() => {
        expect(screen.getByRole('dialog')).toBeInTheDocument();
      });

      // Try to submit without filling required fields
      const saveButton = screen.getByRole('button', { name: /save/i });
      await user.click(saveButton);

      // Should show validation error
      await waitFor(() => {
        expect(screen.getByText(/condition is required/i)).toBeInTheDocument();
      });
    });
  });

  // ===========================================================================
  // 4. Accessibility - Full Component (3 tests)
  // ===========================================================================

  describe('Accessibility - Full Component', () => {
    it('should have no accessibility violations in default state', async () => {
      const { container } = render(<HealthVulnerabilityTab clientGroupId={1} />, {
        wrapper: createWrapper(),
      });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      const results = await axe(container);
      expect(results).toHaveNoViolations();
    });

    it('should have no accessibility violations with expanded row', async () => {
      const user = userEvent.setup();
      const { container } = render(<HealthVulnerabilityTab clientGroupId={1} />, {
        wrapper: createWrapper(),
      });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Expand a row
      await user.click(screen.getByText('John Smith'));

      await waitFor(() => {
        expect(screen.getByText('Current Smoker')).toBeInTheDocument();
      });

      const results = await axe(container);
      expect(results).toHaveNoViolations();
    });

    it('should have no accessibility violations with modal open', async () => {
      const user = userEvent.setup();
      const { container } = render(<HealthVulnerabilityTab clientGroupId={1} />, {
        wrapper: createWrapper(),
      });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Open add modal
      const addButtons = screen.getAllByRole('button', { name: /add health or vulnerability/i });
      await user.click(addButtons[0]);

      await waitFor(() => {
        expect(screen.getByRole('dialog')).toBeInTheDocument();
      });

      const results = await axe(container);
      expect(results).toHaveNoViolations();
    });
  });

  // ===========================================================================
  // 5. Keyboard Navigation End-to-End (5 tests)
  // ===========================================================================

  describe('Keyboard Navigation End-to-End', () => {
    it('should support full keyboard navigation through tabs with ArrowRight/ArrowLeft', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Focus on health tab
      healthTab.focus();
      expect(document.activeElement).toBe(healthTab);

      // Press ArrowRight to move to vulnerabilities tab
      await user.keyboard('{ArrowRight}');
      expect(document.activeElement).toBe(vulnTab);

      // Press ArrowLeft to move back to health tab
      await user.keyboard('{ArrowLeft}');
      expect(document.activeElement).toBe(healthTab);
    });

    it('should support keyboard navigation through expandable rows with Enter/Space', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Find the John Smith row and focus on it
      const johnRow = screen.getByText('John Smith').closest('tr');
      expect(johnRow).toBeInTheDocument();

      if (johnRow) {
        johnRow.focus();
        await user.keyboard('{Enter}');

        // Row should expand and show health conditions
        await waitFor(() => {
          expect(screen.getByText('Current Smoker')).toBeInTheDocument();
        });
      }
    });

    it('should trap focus in modal when open', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Open add modal
      const addButtons = screen.getAllByRole('button', { name: /add health or vulnerability/i });
      await user.click(addButtons[0]);

      await waitFor(() => {
        expect(screen.getByRole('dialog')).toBeInTheDocument();
      });

      // Modal dialog should be present
      const modal = screen.getByRole('dialog');
      expect(modal).toBeInTheDocument();

      // Get focusable elements within modal
      const cancelButton = screen.getByRole('button', { name: /cancel/i });
      const saveButton = screen.getByRole('button', { name: /save/i });

      // Both buttons should be in the modal
      expect(modal).toContainElement(cancelButton);
      expect(modal).toContainElement(saveButton);
    });

    it('should close modal on Escape key press', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Open add modal
      const addButtons = screen.getAllByRole('button', { name: /add health or vulnerability/i });
      await user.click(addButtons[0]);

      await waitFor(() => {
        expect(screen.getByRole('dialog')).toBeInTheDocument();
      });

      // Press Escape to close modal
      await user.keyboard('{Escape}');

      await waitFor(() => {
        expect(screen.queryByRole('dialog')).not.toBeInTheDocument();
      });
    });

    it('should support Home/End keys to navigate tabs', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Focus on health tab
      healthTab.focus();
      expect(document.activeElement).toBe(healthTab);

      // Press End to move to last tab (vulnerabilities)
      await user.keyboard('{End}');
      expect(document.activeElement).toBe(vulnTab);

      // Press Home to move to first tab (health)
      await user.keyboard('{Home}');
      expect(document.activeElement).toBe(healthTab);
    });
  });

  // ===========================================================================
  // 6. Data Persistence (3 tests)
  // ===========================================================================

  describe('Data Persistence', () => {
    it('should persist new health record after creation - mutation is called with correct parameters', async () => {
      const mockCreate = jest.fn().mockResolvedValue({ id: 100 });
      (useCreateHealthRecord as jest.Mock).mockReturnValue({
        mutateAsync: mockCreate,
        isPending: false,
      });

      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Open add modal
      const addButtons = screen.getAllByRole('button', { name: /add health or vulnerability/i });
      await user.click(addButtons[0]);

      await waitFor(() => {
        expect(screen.getByRole('dialog')).toBeInTheDocument();
      });

      // Verify modal is open with condition field
      const modal = screen.getByRole('dialog');
      expect(within(modal).getByLabelText(/condition/i)).toBeInTheDocument();

      // Fill form and submit
      const conditionSelect = within(modal).getByLabelText(/condition/i);
      await user.selectOptions(conditionSelect, 'Diabetes');

      const saveButton = within(modal).getByRole('button', { name: /save/i });
      await user.click(saveButton);

      // Mutation should have been called with the correct data
      await waitFor(() => {
        expect(mockCreate).toHaveBeenCalledWith(
          expect.objectContaining({
            data: expect.objectContaining({
              condition: 'Diabetes',
              product_owner_id: 1,
            }),
            personType: 'product_owner',
          })
        );
      });
    });

    it('should update health record after edit - mutation is called with correct data', async () => {
      const mockUpdate = jest.fn().mockResolvedValue({ id: 2 });
      (useUpdateHealthRecord as jest.Mock).mockReturnValue({
        mutateAsync: mockUpdate,
        isPending: false,
      });

      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Expand John Smith
      await user.click(screen.getByText('John Smith'));

      await waitFor(() => {
        expect(screen.getByText('Type 2')).toBeInTheDocument();
      });

      // Click on health condition to edit
      await user.click(screen.getByText('Type 2'));

      await waitFor(() => {
        expect(screen.getByRole('dialog')).toBeInTheDocument();
      });

      // Modify a field and save
      const saveButton = screen.getByRole('button', { name: /save/i });
      await user.click(saveButton);

      // Mutation should have been called
      await waitFor(() => {
        expect(mockUpdate).toHaveBeenCalled();
      });
    });

    it('should delete health record after confirmation - mutation is called', async () => {
      const mockDelete = jest.fn().mockResolvedValue(undefined);
      (useDeleteHealthRecord as jest.Mock).mockReturnValue({
        mutateAsync: mockDelete,
        isPending: false,
      });

      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Expand row
      await user.click(screen.getByText('John Smith'));

      await waitFor(() => {
        expect(screen.getByText('Current Smoker')).toBeInTheDocument();
      });

      // Find and click delete button
      const deleteButtons = screen.getAllByRole('button', { name: /delete/i });
      if (deleteButtons.length > 0) {
        await user.click(deleteButtons[0]);

        // Confirm deletion
        await waitFor(() => {
          expect(screen.getByRole('button', { name: /^delete$/i })).toBeInTheDocument();
        });

        const confirmButton = screen.getByRole('button', { name: /^delete$/i });
        await user.click(confirmButton);

        // Mutation should be called
        await waitFor(() => {
          expect(mockDelete).toHaveBeenCalled();
        });
      }
    });
  });

  // ===========================================================================
  // 7. Edge Cases (3 tests)
  // ===========================================================================

  describe('Edge Cases', () => {
    it('should handle slow network responses with loading states', async () => {
      // Start with loading state
      (useProductOwners as jest.Mock).mockReturnValue({
        data: undefined,
        isLoading: true,
        isError: false,
        error: null,
        refetch: jest.fn(),
      });

      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      // Should show loading skeleton
      expect(screen.getByRole('status')).toBeInTheDocument();
    });

    it('should handle empty responses gracefully', () => {
      (useProductOwners as jest.Mock).mockReturnValue({
        data: [],
        isLoading: false,
        isError: false,
        error: null,
        refetch: jest.fn(),
      });

      (useSpecialRelationships as jest.Mock).mockReturnValue({
        data: [],
        isLoading: false,
        isError: false,
        error: null,
        refetch: jest.fn(),
      });

      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      // Should show empty state message
      expect(screen.getByText(/no people found/i)).toBeInTheDocument();
    });

    it('should handle large datasets without performance issues', async () => {
      // Create large dataset
      const largeProductOwners: ProductOwner[] = Array.from({ length: 50 }, (_, i) => ({
        id: i + 1,
        firstname: `Person${i + 1}`,
        surname: `Surname${i + 1}`,
        status: 'active',
        known_as: null,
        title: 'Mr',
        middle_names: null,
        relationship_status: 'Single',
        gender: 'Male',
        previous_names: null,
        dob: '1970-01-01',
        place_of_birth: 'London',
        email_1: `person${i + 1}@example.com`,
        email_2: null,
        phone_1: '07700900001',
        phone_2: null,
        moved_in_date: null,
        address_id: 1,
        address_line_1: '123 Main St',
        address_line_2: null,
        address_line_3: 'London',
        address_line_4: null,
        address_line_5: 'SW1A 1AA',
        three_words: null,
        share_data_with: null,
        employment_status: 'Employed',
        occupation: null,
        passport_expiry_date: null,
        ni_number: null,
        aml_result: null,
        aml_date: null,
        created_at: '2020-01-01T00:00:00Z',
      }));

      (useProductOwners as jest.Mock).mockReturnValue({
        data: largeProductOwners,
        isLoading: false,
        isError: false,
        error: null,
        refetch: jest.fn(),
      });

      const startTime = performance.now();

      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('Person1 Surname1')).toBeInTheDocument();
      });

      const endTime = performance.now();
      const renderTime = endTime - startTime;

      // Render should complete in reasonable time (< 2000ms)
      expect(renderTime).toBeLessThan(2000);
    });
  });

  // ===========================================================================
  // 8. Special Relationships (2 tests)
  // ===========================================================================

  describe('Special Relationships', () => {
    it('should display SR tag for special relationships', async () => {
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('Tom Smith')).toBeInTheDocument();
      });

      // Verify SR badge is displayed
      expect(screen.getByText('SR')).toBeInTheDocument();

      // SR badge should be near Tom Smith's name
      const tomRow = screen.getByText('Tom Smith').closest('tr');
      expect(tomRow).toBeInTheDocument();
      if (tomRow) {
        expect(within(tomRow).getByText('SR')).toBeInTheDocument();
      }
    });

    it('should expand SR row and show conditions specific to that relationship', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('Tom Smith')).toBeInTheDocument();
      });

      // Expand Tom Smith (special relationship)
      await user.click(screen.getByText('Tom Smith'));

      // Should show health conditions for Tom Smith (from mockHealthSR)
      await waitFor(() => {
        expect(screen.getByText('Asthma')).toBeInTheDocument();
      });
    });
  });

  // ===========================================================================
  // 9. Smoking Sorting (1 test)
  // ===========================================================================

  describe('Smoking Sorting', () => {
    it('should display smoking conditions at top of expanded health table', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Expand John Smith row
      await user.click(screen.getByText('John Smith'));

      await waitFor(() => {
        expect(screen.getByText('Current Smoker')).toBeInTheDocument();
        expect(screen.getByText('Type 2')).toBeInTheDocument();
      });

      // Get all health condition rows and verify Smoking Status is first
      const rows = screen.getAllByRole('row');
      const conditionRows = rows.filter(row => {
        const text = row.textContent || '';
        return text.includes('Smoking Status') || text.includes('Diabetes') || text.includes('Heart Condition');
      });

      // Smoking Status should appear first in the list
      if (conditionRows.length > 0) {
        const firstConditionRow = conditionRows[0];
        expect(firstConditionRow.textContent).toContain('Smoking Status');
      }
    });
  });

  // ===========================================================================
  // Additional Integration Tests
  // ===========================================================================

  describe('Tab State Preservation', () => {
    it('should reset expanded state when switching tabs', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Expand John Smith on health tab
      await user.click(screen.getByText('John Smith'));

      await waitFor(() => {
        expect(screen.getByText('Current Smoker')).toBeInTheDocument();
      });

      // Switch to vulnerabilities tab
      const vulnTab = screen.getByRole('tab', { name: /vulnerabilities/i });
      await user.click(vulnTab);

      await waitFor(() => {
        expect(vulnTab).toHaveAttribute('aria-selected', 'true');
      });

      // Previous health conditions should no longer be visible
      expect(screen.queryByText('Current Smoker')).not.toBeInTheDocument();
    });
  });

  describe('Modal Context', () => {
    it('should pass correct person context to add modal title', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // Open add modal for John Smith
      const addButtons = screen.getAllByRole('button', { name: /add health or vulnerability/i });
      await user.click(addButtons[0]);

      await waitFor(() => {
        expect(screen.getByRole('dialog')).toBeInTheDocument();
      });

      // Modal title should include person's name in the header
      const modal = screen.getByRole('dialog');
      const modalTitle = within(modal).getByRole('heading');
      expect(modalTitle).toHaveTextContent(/john smith/i);
    });
  });

  describe('Active/Inactive Counts', () => {
    it('should display correct active and inactive counts for persons', async () => {
      render(<HealthVulnerabilityTab clientGroupId={1} />, { wrapper: createWrapper() });

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
      });

      // John Smith has 2 active (Smoking Status, Diabetes) and 1 lapsed (Heart Condition)
      const johnRow = screen.getByText('John Smith').closest('tr');
      expect(johnRow).toBeInTheDocument();

      // The row should contain count values
      if (johnRow) {
        const cells = within(johnRow).getAllByRole('cell');
        // Table has columns: Name, Relationship, Active, Inactive, Actions
        // Active count should be 2, Inactive count should be 1
        expect(cells.length).toBeGreaterThanOrEqual(4);
      }
    });
  });
});
