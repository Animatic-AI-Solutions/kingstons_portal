/**
 * HealthVulnerabilityTab Component Tests (RED Phase - TDD)
 *
 * Tests for the HealthVulnerabilityTab parent container component that provides
 * sub-tab navigation between Health and Vulnerabilities views.
 *
 * The component renders:
 * - A tablist with Health and Vulnerabilities tabs
 * - HealthSubTab when Health tab is active (default)
 * - VulnerabilitiesSubTab when Vulnerabilities tab is active
 *
 * Accessibility requirements:
 * - Proper ARIA roles (tablist, tab, tabpanel)
 * - Keyboard navigation (ArrowLeft, ArrowRight, Enter, Space)
 * - Focus management with tabindex
 * - aria-controls/aria-labelledby linking
 *
 * Following TDD RED-GREEN-BLUE methodology.
 * Expected Result: All tests FAIL (RED phase) until implementation complete.
 *
 * @module tests/components/phase2/health-vulnerabilities/HealthVulnerabilityTab
 */

import React from 'react';
import { render, screen, waitFor, within } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { axe, toHaveNoViolations } from 'jest-axe';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

// This import will fail in RED phase - component doesn't exist yet
import HealthVulnerabilityTab from '@/components/phase2/health-vulnerabilities/HealthVulnerabilityTab';

// Extend Jest matchers with jest-axe
expect.extend(toHaveNoViolations);

// =============================================================================
// Mock Setup
// =============================================================================

/**
 * Mock HealthSubTab component
 */
jest.mock('@/components/phase2/health-vulnerabilities/HealthSubTab', () => {
  return function MockHealthSubTab({ clientGroupId }: { clientGroupId: number }) {
    return <div data-testid="health-subtab">Health Sub Tab Content for {clientGroupId}</div>;
  };
});

/**
 * Mock VulnerabilitiesSubTab component
 */
jest.mock('@/components/phase2/health-vulnerabilities/VulnerabilitiesSubTab', () => {
  return function MockVulnerabilitiesSubTab({ clientGroupId }: { clientGroupId: number }) {
    return (
      <div data-testid="vulnerabilities-subtab">Vulnerabilities Sub Tab Content for {clientGroupId}</div>
    );
  };
});

// =============================================================================
// Test Utilities
// =============================================================================

/**
 * Creates a wrapper with QueryClient for React Query context
 */
const createWrapper = () => {
  const queryClient = new QueryClient({
    defaultOptions: {
      queries: { retry: false },
      mutations: { retry: false },
    },
  });
  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  );
};

/**
 * Default props for testing
 */
const defaultProps = {
  clientGroupId: 1,
};

// =============================================================================
// Test Suite
// =============================================================================

describe('HealthVulnerabilityTab Component', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  // ===========================================================================
  // 1. Tab Navigation (4 tests)
  // ===========================================================================

  describe('Tab Navigation', () => {
    it('should render Health and Vulnerabilities tabs', () => {
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      expect(screen.getByRole('tab', { name: /health/i })).toBeInTheDocument();
      expect(screen.getByRole('tab', { name: /vulnerabilities/i })).toBeInTheDocument();
    });

    it('should show Health tab content by default', () => {
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      expect(screen.getByTestId('health-subtab')).toBeInTheDocument();
      expect(screen.queryByTestId('vulnerabilities-subtab')).not.toBeInTheDocument();
    });

    it('should switch to Vulnerabilities tab on click', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });
      await user.click(vulnerabilitiesTab);

      await waitFor(() => {
        expect(screen.getByTestId('vulnerabilities-subtab')).toBeInTheDocument();
        expect(screen.queryByTestId('health-subtab')).not.toBeInTheDocument();
      });
    });

    it('should switch back to Health tab on click', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      // First, switch to Vulnerabilities
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });
      await user.click(vulnerabilitiesTab);

      await waitFor(() => {
        expect(screen.getByTestId('vulnerabilities-subtab')).toBeInTheDocument();
      });

      // Then switch back to Health
      const healthTab = screen.getByRole('tab', { name: /health/i });
      await user.click(healthTab);

      await waitFor(() => {
        expect(screen.getByTestId('health-subtab')).toBeInTheDocument();
        expect(screen.queryByTestId('vulnerabilities-subtab')).not.toBeInTheDocument();
      });
    });
  });

  // ===========================================================================
  // 2. Accessibility - ARIA Roles (3 tests)
  // ===========================================================================

  describe('Accessibility - ARIA Roles', () => {
    it('should have proper ARIA roles (tablist, tab, tabpanel)', () => {
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      expect(screen.getByRole('tablist')).toBeInTheDocument();
      expect(screen.getAllByRole('tab')).toHaveLength(2);
      expect(screen.getByRole('tabpanel')).toBeInTheDocument();
    });

    it('should have aria-controls linking tabs to panels', () => {
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Health tab should control health panel
      expect(healthTab).toHaveAttribute('aria-controls', 'health-panel');
      // Vulnerabilities tab should control vulnerabilities panel
      expect(vulnerabilitiesTab).toHaveAttribute('aria-controls', 'vulnerabilities-panel');
    });

    it('should have aria-labelledby on tabpanel', () => {
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const tabpanel = screen.getByRole('tabpanel');
      // When health tab is active, panel should be labelled by health-tab
      expect(tabpanel).toHaveAttribute('aria-labelledby', 'health-tab');
    });
  });

  // ===========================================================================
  // 3. Keyboard Navigation (6 tests)
  // ===========================================================================

  describe('Keyboard Navigation', () => {
    it('should support ArrowRight to move focus to next tab', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Focus the Health tab
      healthTab.focus();
      expect(document.activeElement).toBe(healthTab);

      // Press ArrowRight to move focus to Vulnerabilities tab
      await user.keyboard('{ArrowRight}');

      expect(document.activeElement).toBe(vulnerabilitiesTab);
    });

    it('should support ArrowLeft to move focus to previous tab', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Focus the Vulnerabilities tab
      vulnerabilitiesTab.focus();
      expect(document.activeElement).toBe(vulnerabilitiesTab);

      // Press ArrowLeft to move focus to Health tab
      await user.keyboard('{ArrowLeft}');

      expect(document.activeElement).toBe(healthTab);
    });

    it('should wrap ArrowRight from last tab to first tab', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Focus the Vulnerabilities tab (last tab)
      vulnerabilitiesTab.focus();
      expect(document.activeElement).toBe(vulnerabilitiesTab);

      // Press ArrowRight to wrap to Health tab (first tab)
      await user.keyboard('{ArrowRight}');

      expect(document.activeElement).toBe(healthTab);
    });

    it('should wrap ArrowLeft from first tab to last tab', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Focus the Health tab (first tab)
      healthTab.focus();
      expect(document.activeElement).toBe(healthTab);

      // Press ArrowLeft to wrap to Vulnerabilities tab (last tab)
      await user.keyboard('{ArrowLeft}');

      expect(document.activeElement).toBe(vulnerabilitiesTab);
    });

    it('should select focused tab with Enter key', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Focus the Vulnerabilities tab
      vulnerabilitiesTab.focus();

      // Press Enter to select it
      await user.keyboard('{Enter}');

      await waitFor(() => {
        expect(screen.getByTestId('vulnerabilities-subtab')).toBeInTheDocument();
        expect(vulnerabilitiesTab).toHaveAttribute('aria-selected', 'true');
      });
    });

    it('should select focused tab with Space key', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Focus the Vulnerabilities tab
      vulnerabilitiesTab.focus();

      // Press Space to select it
      await user.keyboard(' ');

      await waitFor(() => {
        expect(screen.getByTestId('vulnerabilities-subtab')).toBeInTheDocument();
        expect(vulnerabilitiesTab).toHaveAttribute('aria-selected', 'true');
      });
    });
  });

  // ===========================================================================
  // 4. Tab Styling (2 tests)
  // ===========================================================================

  describe('Tab Styling', () => {
    it('should have active styling class on active tab (e.g., bg-primary-700)', () => {
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });

      // Active tab should have active styling
      expect(healthTab).toHaveClass('bg-primary-700');
    });

    it('should not have active styling on inactive tab', () => {
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Inactive tab should not have active styling
      expect(vulnerabilitiesTab).not.toHaveClass('bg-primary-700');
    });
  });

  // ===========================================================================
  // 5. Tabindex Management (2 tests)
  // ===========================================================================

  describe('Tabindex Management', () => {
    it('should have tabindex="0" on active tab and tabindex="-1" on inactive tab', () => {
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Health is active by default
      expect(healthTab).toHaveAttribute('tabindex', '0');
      expect(vulnerabilitiesTab).toHaveAttribute('tabindex', '-1');
    });

    it('should update tabindex when switching tabs', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Switch to Vulnerabilities tab
      await user.click(vulnerabilitiesTab);

      await waitFor(() => {
        // Now Vulnerabilities should have tabindex="0"
        expect(vulnerabilitiesTab).toHaveAttribute('tabindex', '0');
        expect(healthTab).toHaveAttribute('tabindex', '-1');
      });
    });
  });

  // ===========================================================================
  // 6. Accessibility - No Violations (2 tests)
  // ===========================================================================

  describe('Accessibility - No Violations', () => {
    it('should have no jest-axe violations on initial render', async () => {
      const { container } = render(<HealthVulnerabilityTab {...defaultProps} />, {
        wrapper: createWrapper(),
      });

      const results = await axe(container);
      expect(results).toHaveNoViolations();
    });

    it('should have no jest-axe violations after tab switch', async () => {
      const user = userEvent.setup();
      const { container } = render(<HealthVulnerabilityTab {...defaultProps} />, {
        wrapper: createWrapper(),
      });

      // Switch to Vulnerabilities tab
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });
      await user.click(vulnerabilitiesTab);

      await waitFor(() => {
        expect(screen.getByTestId('vulnerabilities-subtab')).toBeInTheDocument();
      });

      const results = await axe(container);
      expect(results).toHaveNoViolations();
    });
  });

  // ===========================================================================
  // 7. Focus Management (1 test)
  // ===========================================================================

  describe('Focus Management', () => {
    it('should have proper focus ring styling on tabs (focus:ring-2)', () => {
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Both tabs should have focus ring class
      expect(healthTab).toHaveClass('focus:ring-2');
      expect(vulnerabilitiesTab).toHaveClass('focus:ring-2');
    });
  });

  // ===========================================================================
  // 8. Screen Reader Support (2 tests)
  // ===========================================================================

  describe('Screen Reader Support', () => {
    it('should have descriptive tablist aria-label', () => {
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const tablist = screen.getByRole('tablist');

      expect(tablist).toHaveAttribute('aria-label', expect.stringMatching(/health.*vulnerabilities/i));
    });

    it('should update aria-labelledby on tabpanel when switching tabs', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      // Initially labelled by health-tab
      expect(screen.getByRole('tabpanel')).toHaveAttribute('aria-labelledby', 'health-tab');

      // Switch to Vulnerabilities
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });
      await user.click(vulnerabilitiesTab);

      await waitFor(() => {
        expect(screen.getByRole('tabpanel')).toHaveAttribute('aria-labelledby', 'vulnerabilities-tab');
      });
    });
  });

  // ===========================================================================
  // 9. Edge Cases (5 tests)
  // ===========================================================================

  describe('Edge Cases', () => {
    it('should handle rapid tab switching gracefully', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Rapidly switch tabs
      for (let i = 0; i < 10; i++) {
        await user.click(i % 2 === 0 ? vulnerabilitiesTab : healthTab);
      }

      // Component should still be functional
      expect(screen.getByRole('tabpanel')).toBeInTheDocument();
      expect(screen.getByRole('tablist')).toBeInTheDocument();
    });

    it('should handle multiple Enter key presses on same tab', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });

      // Focus and press Enter multiple times
      healthTab.focus();
      await user.keyboard('{Enter}');
      await user.keyboard('{Enter}');
      await user.keyboard('{Enter}');

      // Should still show Health content
      expect(screen.getByTestId('health-subtab')).toBeInTheDocument();
    });

    it('should preserve functionality when switching between tabs multiple times', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Switch to Vulnerabilities
      await user.click(vulnerabilitiesTab);
      expect(screen.getByTestId('vulnerabilities-subtab')).toBeInTheDocument();

      // Switch back to Health
      await user.click(healthTab);
      expect(screen.getByTestId('health-subtab')).toBeInTheDocument();

      // Switch to Vulnerabilities again
      await user.click(vulnerabilitiesTab);
      expect(screen.getByTestId('vulnerabilities-subtab')).toBeInTheDocument();

      // All ARIA attributes should still be correct
      expect(vulnerabilitiesTab).toHaveAttribute('aria-selected', 'true');
      expect(healthTab).toHaveAttribute('aria-selected', 'false');
    });

    it('should handle different clientGroupId props (rerender)', () => {
      const { rerender } = render(<HealthVulnerabilityTab clientGroupId={1} />, {
        wrapper: createWrapper(),
      });

      // Initial render with clientGroupId=1
      expect(screen.getByTestId('health-subtab')).toHaveTextContent('Health Sub Tab Content for 1');

      // Rerender with different clientGroupId
      rerender(
        <QueryClientProvider
          client={
            new QueryClient({
              defaultOptions: { queries: { retry: false }, mutations: { retry: false } },
            })
          }
        >
          <HealthVulnerabilityTab clientGroupId={42} />
        </QueryClientProvider>
      );

      expect(screen.getByTestId('health-subtab')).toHaveTextContent('Health Sub Tab Content for 42');
    });

    it('should handle zero as clientGroupId', () => {
      render(<HealthVulnerabilityTab clientGroupId={0} />, { wrapper: createWrapper() });

      // Should render with clientGroupId=0
      expect(screen.getByTestId('health-subtab')).toHaveTextContent('Health Sub Tab Content for 0');
    });
  });

  // ===========================================================================
  // 10. Props Passing (2 tests)
  // ===========================================================================

  describe('Props Passing', () => {
    it('should pass clientGroupId to HealthSubTab', () => {
      render(<HealthVulnerabilityTab clientGroupId={123} />, { wrapper: createWrapper() });

      // HealthSubTab should receive the clientGroupId
      expect(screen.getByTestId('health-subtab')).toHaveTextContent('Health Sub Tab Content for 123');
    });

    it('should pass clientGroupId to VulnerabilitiesSubTab', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab clientGroupId={456} />, { wrapper: createWrapper() });

      // Switch to Vulnerabilities tab
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });
      await user.click(vulnerabilitiesTab);

      await waitFor(() => {
        // VulnerabilitiesSubTab should receive the clientGroupId
        expect(screen.getByTestId('vulnerabilities-subtab')).toHaveTextContent(
          'Vulnerabilities Sub Tab Content for 456'
        );
      });
    });
  });

  // ===========================================================================
  // 11. aria-selected State (2 tests)
  // ===========================================================================

  describe('aria-selected State', () => {
    it('should have aria-selected="true" on active tab and "false" on inactive', () => {
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Health is active by default
      expect(healthTab).toHaveAttribute('aria-selected', 'true');
      expect(vulnerabilitiesTab).toHaveAttribute('aria-selected', 'false');
    });

    it('should update aria-selected when switching tabs', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      // Switch to Vulnerabilities
      await user.click(vulnerabilitiesTab);

      await waitFor(() => {
        expect(vulnerabilitiesTab).toHaveAttribute('aria-selected', 'true');
        expect(healthTab).toHaveAttribute('aria-selected', 'false');
      });
    });
  });

  // ===========================================================================
  // 12. Tab ID Attributes (2 tests)
  // ===========================================================================

  describe('Tab ID Attributes', () => {
    it('should have correct id on tabs matching aria-labelledby', () => {
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      expect(healthTab).toHaveAttribute('id', 'health-tab');
      expect(vulnerabilitiesTab).toHaveAttribute('id', 'vulnerabilities-tab');
    });

    it('should have correct id on tabpanel matching aria-controls', () => {
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const tabpanel = screen.getByRole('tabpanel');

      // When health is active, panel id should be health-panel
      expect(tabpanel).toHaveAttribute('id', 'health-panel');
    });
  });

  // ===========================================================================
  // 13. Panel ID Updates (1 test)
  // ===========================================================================

  describe('Panel ID Updates', () => {
    it('should update tabpanel id when switching tabs', async () => {
      const user = userEvent.setup();
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      // Initially health-panel
      expect(screen.getByRole('tabpanel')).toHaveAttribute('id', 'health-panel');

      // Switch to Vulnerabilities
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });
      await user.click(vulnerabilitiesTab);

      await waitFor(() => {
        expect(screen.getByRole('tabpanel')).toHaveAttribute('id', 'vulnerabilities-panel');
      });
    });
  });

  // ===========================================================================
  // 14. Data-tab Attribute for Keyboard Navigation (1 test)
  // ===========================================================================

  describe('Data-tab Attribute', () => {
    it('should have data-tab attribute on tabs for keyboard navigation', () => {
      render(<HealthVulnerabilityTab {...defaultProps} />, { wrapper: createWrapper() });

      const healthTab = screen.getByRole('tab', { name: /health/i });
      const vulnerabilitiesTab = screen.getByRole('tab', { name: /vulnerabilities/i });

      expect(healthTab).toHaveAttribute('data-tab', 'health');
      expect(vulnerabilitiesTab).toHaveAttribute('data-tab', 'vulnerabilities');
    });
  });
});
