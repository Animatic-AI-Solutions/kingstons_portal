/**
 * Health and Vulnerability Types
 *
 * Type definitions for health conditions and vulnerabilities in the Phase 2
 * Health & Vulnerabilities Tab implementation.
 *
 * Health conditions track medical conditions, diagnoses, and medications
 * for product owners and their special relationships.
 *
 * Vulnerabilities track factors that may affect a person's ability to
 * make financial decisions or require special accommodations.
 *
 * Both support the FCA's vulnerability guidance for treating customers fairly.
 *
 * @module types/healthVulnerability
 */

// =============================================================================
// Shared Types
// =============================================================================

/**
 * Valid status values for health conditions and vulnerabilities
 */
export type HealthVulnerabilityStatus = 'Active' | 'Lapsed';

/**
 * Person type for health/vulnerability records
 */
export type PersonType = 'product_owner' | 'special_relationship';

// =============================================================================
// Health Types
// =============================================================================

/**
 * Base health condition fields shared between create/update/response
 */
interface HealthConditionBase {
  /**
   * Type of health condition
   * Required, 1-255 characters
   * Examples: "Diabetes", "Heart Disease", "Asthma"
   */
  condition: string;

  /**
   * Descriptive name for the condition
   * Optional, provides more detail
   * Example: "Type 2 Diabetes" for condition "Diabetes"
   */
  name?: string | null;

  /**
   * Date when condition was diagnosed (ISO 8601 format: YYYY-MM-DD)
   * Optional, cannot be in the future
   */
  date_of_diagnosis?: string | null;

  /**
   * Current status of the condition
   * Defaults to "Active"
   */
  status: HealthVulnerabilityStatus;

  /**
   * Current medications for this condition
   * Optional, free-form text
   */
  medication?: string | null;

  /**
   * Additional notes about the condition
   * Optional, free-form text
   */
  notes?: string | null;
}

/**
 * Health condition record for a Product Owner
 * Maps to `health_product_owners` database table
 */
export interface HealthProductOwner extends HealthConditionBase {
  /** Unique identifier (auto-generated) */
  id: number;

  /** Foreign key to product_owners table */
  product_owner_id: number;

  /** Timestamp when record was created (ISO 8601 format) */
  created_at: string;

  /** Timestamp when condition was recorded (may differ from created_at) */
  date_recorded?: string | null;
}

/**
 * Health condition record for a Special Relationship
 * Maps to `health_special_relationships` database table
 */
export interface HealthSpecialRelationship extends HealthConditionBase {
  /** Unique identifier (auto-generated) */
  id: number;

  /** Foreign key to special_relationships table */
  special_relationship_id: number;

  /** Timestamp when record was created (ISO 8601 format) */
  created_at: string;

  /** Timestamp when condition was recorded (may differ from created_at) */
  date_recorded?: string | null;
}

/**
 * Payload for creating a health condition for a Product Owner
 * Used with POST /api/health/product-owners
 */
export interface HealthProductOwnerCreate {
  /** ID of the product owner (must exist) */
  product_owner_id: number;

  /** Type of health condition (required, 1-255 chars) */
  condition: string;

  /** Descriptive name (optional) */
  name?: string | null;

  /** Date of diagnosis in YYYY-MM-DD format (optional, cannot be future) */
  date_of_diagnosis?: string | null;

  /** Status (defaults to "Active") */
  status?: HealthVulnerabilityStatus;

  /** Current medications (optional) */
  medication?: string | null;

  /** Additional notes (optional) */
  notes?: string | null;
}

/**
 * Payload for creating a health condition for a Special Relationship
 * Used with POST /api/health/special-relationships
 */
export interface HealthSpecialRelationshipCreate {
  /** ID of the special relationship (must exist) */
  special_relationship_id: number;

  /** Type of health condition (required, 1-255 chars) */
  condition: string;

  /** Descriptive name (optional) */
  name?: string | null;

  /** Date of diagnosis in YYYY-MM-DD format (optional, cannot be future) */
  date_of_diagnosis?: string | null;

  /** Status (defaults to "Active") */
  status?: HealthVulnerabilityStatus;

  /** Current medications (optional) */
  medication?: string | null;

  /** Additional notes (optional) */
  notes?: string | null;
}

/**
 * Payload for updating a health condition
 * All fields are optional - only provided fields will be updated
 * Used with PUT /api/health/product-owners/{id} or PUT /api/health/special-relationships/{id}
 */
export interface HealthConditionUpdate {
  /** Type of health condition */
  condition?: string;

  /** Descriptive name */
  name?: string | null;

  /** Date of diagnosis in YYYY-MM-DD format */
  date_of_diagnosis?: string | null;

  /** Status */
  status?: HealthVulnerabilityStatus;

  /** Current medications */
  medication?: string | null;

  /** Additional notes */
  notes?: string | null;
}

// =============================================================================
// Vulnerability Types
// =============================================================================

/**
 * Base vulnerability fields shared between create/update/response
 */
interface VulnerabilityBase {
  /**
   * Description of the vulnerability
   * Required, 1-500 characters
   * Examples: "Cognitive decline", "Hearing impairment", "Recent bereavement"
   */
  description: string;

  /**
   * Adjustments made to accommodate the vulnerability
   * Optional, max 1000 characters
   * Examples: "Speak slowly and clearly", "Involve family in discussions"
   */
  adjustments?: string | null;

  /**
   * Whether the vulnerability has been officially diagnosed
   * Defaults to false
   */
  diagnosed: boolean;

  /**
   * Current status of the vulnerability
   * Defaults to "Active"
   */
  status: HealthVulnerabilityStatus;

  /**
   * Additional notes about the vulnerability
   * Optional, max 2000 characters
   */
  notes?: string | null;
}

/**
 * Vulnerability record for a Product Owner
 * Maps to `vulnerabilities_product_owners` database table
 */
export interface VulnerabilityProductOwner extends VulnerabilityBase {
  /** Unique identifier (auto-generated) */
  id: number;

  /** Foreign key to product_owners table */
  product_owner_id: number;

  /** Timestamp when record was created (ISO 8601 format) */
  created_at: string;

  /** Timestamp when vulnerability was recorded (may differ from created_at) */
  date_recorded?: string | null;
}

/**
 * Vulnerability record for a Special Relationship
 * Maps to `vulnerabilities_special_relationships` database table
 */
export interface VulnerabilitySpecialRelationship extends VulnerabilityBase {
  /** Unique identifier (auto-generated) */
  id: number;

  /** Foreign key to special_relationships table */
  special_relationship_id: number;

  /** Timestamp when record was created (ISO 8601 format) */
  created_at: string;

  /** Timestamp when vulnerability was recorded (may differ from created_at) */
  date_recorded?: string | null;
}

/**
 * Payload for creating a vulnerability for a Product Owner
 * Used with POST /api/vulnerabilities/product-owners
 */
export interface VulnerabilityProductOwnerCreate {
  /** ID of the product owner (must exist) */
  product_owner_id: number;

  /** Description of the vulnerability (required, 1-500 chars) */
  description: string;

  /** Adjustments to accommodate (optional, max 1000 chars) */
  adjustments?: string | null;

  /** Whether officially diagnosed (defaults to false) */
  diagnosed?: boolean;

  /** Status (defaults to "Active") */
  status?: HealthVulnerabilityStatus;

  /** Additional notes (optional, max 2000 chars) */
  notes?: string | null;
}

/**
 * Payload for creating a vulnerability for a Special Relationship
 * Used with POST /api/vulnerabilities/special-relationships
 */
export interface VulnerabilitySpecialRelationshipCreate {
  /** ID of the special relationship (must exist) */
  special_relationship_id: number;

  /** Description of the vulnerability (required, 1-500 chars) */
  description: string;

  /** Adjustments to accommodate (optional, max 1000 chars) */
  adjustments?: string | null;

  /** Whether officially diagnosed (defaults to false) */
  diagnosed?: boolean;

  /** Status (defaults to "Active") */
  status?: HealthVulnerabilityStatus;

  /** Additional notes (optional, max 2000 chars) */
  notes?: string | null;
}

/**
 * Payload for updating a vulnerability
 * All fields are optional - only provided fields will be updated
 * Used with PUT /api/vulnerabilities/product-owners/{id} or PUT /api/vulnerabilities/special-relationships/{id}
 */
export interface VulnerabilityUpdate {
  /** Description of the vulnerability */
  description?: string;

  /** Adjustments to accommodate */
  adjustments?: string | null;

  /** Whether officially diagnosed */
  diagnosed?: boolean;

  /** Status */
  status?: HealthVulnerabilityStatus;

  /** Additional notes */
  notes?: string | null;
}

// =============================================================================
// Combined/Unified Types for UI Components
// =============================================================================

/**
 * Unified health condition type that works for both product owners and special relationships
 * Used by UI components that display health conditions for any person type
 */
export type HealthCondition = HealthProductOwner | HealthSpecialRelationship;

/**
 * Unified vulnerability type that works for both product owners and special relationships
 * Used by UI components that display vulnerabilities for any person type
 */
export type Vulnerability = VulnerabilityProductOwner | VulnerabilitySpecialRelationship;

/**
 * Person reference for health/vulnerability records
 * Used to identify which person a record belongs to
 */
export interface PersonReference {
  /** Type of person */
  type: PersonType;

  /** ID of the person */
  id: number;

  /** Display name for the person */
  name: string;
}

/**
 * Health condition with person context
 * Used for displaying health conditions in a combined list
 */
export interface HealthConditionWithPerson extends HealthConditionBase {
  id: number;
  created_at: string;
  date_recorded?: string | null;
  person: PersonReference;
}

/**
 * Vulnerability with person context
 * Used for displaying vulnerabilities in a combined list
 */
export interface VulnerabilityWithPerson extends VulnerabilityBase {
  id: number;
  created_at: string;
  date_recorded?: string | null;
  person: PersonReference;
}

/**
 * Person data with health/vulnerability counts for display in PersonTable
 * Used to show product owners and special relationships with their record counts
 */
export interface PersonWithCounts {
  /** Unique identifier */
  id: number;
  /** Display name of the person */
  name: string;
  /** Relationship type (e.g., "Primary Owner", "Joint Owner", "Child", "Spouse") */
  relationship: string;
  /** Type of person */
  personType: PersonType;
  /** Current status */
  status: string;
  /** Count of active health conditions + vulnerabilities */
  activeCount: number;
  /** Count of inactive/resolved health conditions + vulnerabilities */
  inactiveCount: number;
}

// =============================================================================
// API Response Types
// =============================================================================

/**
 * Query parameters for fetching health conditions
 */
export interface HealthQueryParams {
  /** Filter by product owner ID */
  product_owner_id?: number;

  /** Filter by special relationship ID */
  special_relationship_id?: number;

  /** Filter by client group ID (returns all records for all people in the group) */
  client_group_id?: number;

  /** Number of records to skip (pagination) */
  skip?: number;

  /** Maximum records to return (pagination, default 100, max 1000) */
  limit?: number;
}

/**
 * Query parameters for fetching vulnerabilities
 */
export interface VulnerabilityQueryParams {
  /** Filter by product owner ID */
  product_owner_id?: number;

  /** Filter by special relationship ID */
  special_relationship_id?: number;

  /** Filter by client group ID (returns all records for all people in the group) */
  client_group_id?: number;

  /** Number of records to skip (pagination) */
  skip?: number;

  /** Maximum records to return (pagination, default 100, max 1000) */
  limit?: number;
}

/**
 * Paginated response metadata
 * Extracted from X-Total-Count header
 */
export interface PaginationMeta {
  /** Total count of records matching the query */
  total: number;

  /** Number of records skipped */
  skip: number;

  /** Maximum records per page */
  limit: number;

  /** Whether there are more records available */
  hasMore: boolean;
}

// =============================================================================
// Form/Modal Types
// =============================================================================

/**
 * Mode for health/vulnerability modals
 */
export type ModalMode = 'add' | 'edit' | 'view';

/**
 * Record type being managed
 */
export type RecordType = 'health' | 'vulnerability';

/**
 * Props for Add/Edit modal components
 */
export interface HealthVulnerabilityModalProps {
  /** Whether the modal is open */
  isOpen: boolean;

  /** Callback to close the modal */
  onClose: () => void;

  /** Callback when a record is saved */
  onSave: () => void;

  /** Type of record being managed */
  recordType: RecordType;

  /** Mode of the modal */
  mode: ModalMode;

  /** Person the record belongs to */
  person: PersonReference;

  /** Existing record for edit/view mode */
  existingRecord?: HealthCondition | Vulnerability;
}

// =============================================================================
// Validation Constants
// =============================================================================

/**
 * Maximum length constraints for health condition fields
 */
export const HEALTH_FIELD_LIMITS = {
  condition: 255,
  name: 255,
  medication: 500,
  notes: 2000,
} as const;

/**
 * Maximum length constraints for vulnerability fields
 */
export const VULNERABILITY_FIELD_LIMITS = {
  description: 500,
  adjustments: 1000,
  notes: 2000,
} as const;

/**
 * Valid status options for dropdowns
 */
export const STATUS_OPTIONS = ['Active', 'Lapsed'] as const;

// =============================================================================
// Type Guards
// =============================================================================

/**
 * Type guard to check if a health condition belongs to a product owner
 *
 * @param health - The health condition to check
 * @returns True if the health condition belongs to a product owner
 *
 * @example
 * ```ts
 * const health: HealthCondition = getHealthRecord();
 * if (isHealthProductOwner(health)) {
 *   console.log(health.product_owner_id); // TypeScript knows this exists
 * }
 * ```
 */
export function isHealthProductOwner(health: HealthCondition): health is HealthProductOwner {
  return 'product_owner_id' in health;
}

/**
 * Type guard to check if a health condition belongs to a special relationship
 *
 * @param health - The health condition to check
 * @returns True if the health condition belongs to a special relationship
 *
 * @example
 * ```ts
 * const health: HealthCondition = getHealthRecord();
 * if (isHealthSpecialRelationship(health)) {
 *   console.log(health.special_relationship_id); // TypeScript knows this exists
 * }
 * ```
 */
export function isHealthSpecialRelationship(health: HealthCondition): health is HealthSpecialRelationship {
  return 'special_relationship_id' in health;
}

/**
 * Type guard to check if a vulnerability belongs to a product owner
 *
 * @param vuln - The vulnerability to check
 * @returns True if the vulnerability belongs to a product owner
 *
 * @example
 * ```ts
 * const vuln: Vulnerability = getVulnerabilityRecord();
 * if (isVulnerabilityProductOwner(vuln)) {
 *   console.log(vuln.product_owner_id); // TypeScript knows this exists
 * }
 * ```
 */
export function isVulnerabilityProductOwner(vuln: Vulnerability): vuln is VulnerabilityProductOwner {
  return 'product_owner_id' in vuln;
}

/**
 * Type guard to check if a vulnerability belongs to a special relationship
 *
 * @param vuln - The vulnerability to check
 * @returns True if the vulnerability belongs to a special relationship
 *
 * @example
 * ```ts
 * const vuln: Vulnerability = getVulnerabilityRecord();
 * if (isVulnerabilitySpecialRelationship(vuln)) {
 *   console.log(vuln.special_relationship_id); // TypeScript knows this exists
 * }
 * ```
 */
export function isVulnerabilitySpecialRelationship(vuln: Vulnerability): vuln is VulnerabilitySpecialRelationship {
  return 'special_relationship_id' in vuln;
}

// =============================================================================
// Date Utilities
// =============================================================================

/**
 * Parses an ISO date string to a Date object.
 * Returns null if the string is null/undefined or invalid.
 *
 * @param dateString - The ISO date string to parse (YYYY-MM-DD or ISO 8601)
 * @returns A Date object or null if the string is invalid
 *
 * @example
 * ```ts
 * const date = parseHealthDate('2025-01-15');
 * console.log(date); // Date object for Jan 15, 2025
 *
 * const nullDate = parseHealthDate(null);
 * console.log(nullDate); // null
 * ```
 */
export function parseHealthDate(dateString: string | null | undefined): Date | null {
  if (!dateString) return null;
  const date = new Date(dateString);
  return isNaN(date.getTime()) ? null : date;
}

/**
 * Formats a Date object to ISO date string (YYYY-MM-DD).
 * Returns null if the date is null/undefined.
 *
 * @param date - The Date object to format
 * @returns An ISO date string (YYYY-MM-DD) or null
 *
 * @example
 * ```ts
 * const dateStr = formatHealthDate(new Date('2025-01-15'));
 * console.log(dateStr); // '2025-01-15'
 *
 * const nullStr = formatHealthDate(null);
 * console.log(nullStr); // null
 * ```
 */
export function formatHealthDate(date: Date | null | undefined): string | null {
  if (!date) return null;
  return date.toISOString().split('T')[0];
}

// =============================================================================
// Smoking Condition Utilities
// =============================================================================

/**
 * Checks if a health condition is the smoking status condition
 * The condition type "Smoking Status" indicates this should be sorted to top
 * @param condition - The health condition to check
 * @returns true if the condition is the smoking status condition
 */
export function isSmokingCondition(condition: HealthCondition): boolean {
  return condition.condition === 'Smoking Status';
}
