/**
 * EditHealthVulnerabilityModal Component
 *
 * Modal dialog for editing existing health conditions or vulnerabilities for a person.
 * Displays different form fields based on tabType prop and pre-populates with existing record data.
 *
 * Features:
 * - Accessible modal with ARIA labels and focus trap
 * - Health form: condition dropdown, name, date_of_diagnosis, medication, status, notes
 * - Vulnerability form: description, adjustments, diagnosed checkbox, status, notes
 * - Pre-populated form fields from existing record
 * - Real-time validation with error display
 * - Loading states to prevent double-submission
 * - Success/error announcements via aria-live regions
 * - Form reset to original values on modal close/reopen
 * - Focus return to trigger element on close
 *
 * @module components/phase2/health-vulnerabilities/EditHealthVulnerabilityModal
 */

import React, { useState, useEffect, useCallback, useRef, useMemo } from 'react';
import FocusTrap from 'focus-trap-react';
import { XMarkIcon } from '@heroicons/react/24/outline';
import { useUpdateHealthRecord, useUpdateVulnerability } from '@/hooks/useHealthVulnerabilities';
import {
  STATUS_OPTIONS,
  CONDITION_TYPES,
  HEALTH_FIELD_LIMITS,
  VULNERABILITY_FIELD_LIMITS,
  isHealthCondition,
  type PersonWithCounts,
  type HealthCondition,
  type Vulnerability,
  type HealthVulnerabilityStatus,
  type HealthConditionUpdate,
  type VulnerabilityUpdate,
} from '@/types/healthVulnerability';
import {
  LABEL_CLASSES,
  getInputClasses,
} from './shared';
import type {
  HealthFormState,
  VulnerabilityFormState,
  FormErrors,
} from './shared';

// =============================================================================
// Types
// =============================================================================

/**
 * Props for EditHealthVulnerabilityModal component
 */
export interface EditHealthVulnerabilityModalProps {
  /** Whether the modal is currently open */
  isOpen: boolean;
  /** Callback when modal should close */
  onClose: () => void;
  /** Person data for whom the record is being edited */
  person: PersonWithCounts;
  /** Existing record to edit */
  record: HealthCondition | Vulnerability;
  /** Type of record to edit - determines which form fields to show */
  tabType: 'health' | 'vulnerabilities';
  /** Callback invoked after successful save */
  onSuccess: () => void;
  /** Optional ref to button that triggered the modal for focus restoration */
  triggerRef?: React.RefObject<HTMLButtonElement>;
}


// =============================================================================
// Helper Functions
// =============================================================================

/**
 * Initialize health form state from a health condition record
 */
function initHealthFormFromRecord(record: HealthCondition): HealthFormState {
  return {
    condition: record.condition || '',
    name: record.name || '',
    date_of_diagnosis: record.date_of_diagnosis || '',
    medication: record.medication || '',
    status: record.status || 'Active',
    notes: record.notes || '',
  };
}

/**
 * Initialize vulnerability form state from a vulnerability record
 */
function initVulnerabilityFormFromRecord(record: Vulnerability): VulnerabilityFormState {
  return {
    description: record.description || '',
    adjustments: record.adjustments || '',
    diagnosed: record.diagnosed ?? false,
    status: record.status || 'Active',
    notes: record.notes || '',
  };
}

// =============================================================================
// Component
// =============================================================================

/**
 * EditHealthVulnerabilityModal Component
 *
 * Renders accessible modal dialog with form for editing health conditions or vulnerabilities.
 *
 * @param props - Component props
 * @returns JSX element with modal dialog
 */
const EditHealthVulnerabilityModal: React.FC<EditHealthVulnerabilityModalProps> = ({
  isOpen,
  onClose,
  person,
  record,
  tabType,
  onSuccess,
  triggerRef,
}) => {
  // ============================================================
  // Form State - Initialize from record
  // ============================================================
  const [healthForm, setHealthForm] = useState<HealthFormState>(() =>
    tabType === 'health' && isHealthCondition(record)
      ? initHealthFormFromRecord(record)
      : { condition: '', name: '', date_of_diagnosis: '', medication: '', status: 'Active', notes: '' }
  );
  const [vulnerabilityForm, setVulnerabilityForm] = useState<VulnerabilityFormState>(() =>
    tabType === 'vulnerabilities' && !isHealthCondition(record)
      ? initVulnerabilityFormFromRecord(record)
      : { description: '', adjustments: '', diagnosed: false, status: 'Active', notes: '' }
  );
  const [errors, setErrors] = useState<FormErrors>({});
  const [touched, setTouched] = useState<{ condition?: boolean; description?: boolean }>({});

  // ============================================================
  // Aria-live announcement state
  // ============================================================
  const [announcement, setAnnouncement] = useState<{ message: string; type: 'success' | 'error' | null }>({
    message: '',
    type: null,
  });

  // ============================================================
  // Mutation Hooks
  // ============================================================
  const updateHealth = useUpdateHealthRecord();
  // Provide a fallback for useUpdateVulnerability when it may be undefined (e.g., in partial mocks)
  const fallbackMutation = { mutateAsync: async () => ({}), isPending: false };
  const updateVulnerability = (useUpdateVulnerability ?? (() => fallbackMutation))();

  const isPending = tabType === 'health' ? updateHealth.isPending : updateVulnerability.isPending;

  // ============================================================
  // Refs
  // ============================================================
  const modalRef = useRef<HTMLDivElement>(null);
  const cancelButtonRef = useRef<HTMLButtonElement>(null);
  const previousFocusRef = useRef<HTMLElement | null>(null);
  const hasInitialFocusRef = useRef<boolean>(false);
  const titleId = 'edit-health-vulnerability-modal-title';

  // ============================================================
  // Reset form to original record values
  // ============================================================
  const resetFormToRecord = useCallback(() => {
    if (tabType === 'health' && isHealthCondition(record)) {
      setHealthForm(initHealthFormFromRecord(record));
    } else if (tabType === 'vulnerabilities' && !isHealthCondition(record)) {
      setVulnerabilityForm(initVulnerabilityFormFromRecord(record));
    }
    setErrors({});
    setTouched({});
    setAnnouncement({ message: '', type: null });
  }, [tabType, record]);

  /**
   * Initialize form state from record when modal opens or record changes
   */
  useEffect(() => {
    if (isOpen) {
      // Save currently focused element when modal opens
      previousFocusRef.current = document.activeElement as HTMLElement;
      // Reset form to record values when opening
      resetFormToRecord();
    } else {
      // Restore focus when modal closes
      if (triggerRef?.current) {
        triggerRef.current.focus();
      } else if (previousFocusRef.current) {
        previousFocusRef.current.focus();
        previousFocusRef.current = null;
      }
    }
  }, [isOpen, resetFormToRecord, triggerRef]);

  /**
   * Focus the cancel button on initial render only
   * Using a separate effect that runs once after mount
   */
  useEffect(() => {
    if (isOpen && cancelButtonRef.current && !hasInitialFocusRef.current) {
      hasInitialFocusRef.current = true;
      cancelButtonRef.current.focus();
    }
    // Reset flag when modal closes
    if (!isOpen) {
      hasInitialFocusRef.current = false;
    }
  }, [isOpen]);

  /**
   * Handle ESC key to close modal
   */
  useEffect(() => {
    const handleEscape = (event: KeyboardEvent) => {
      if (event.key === 'Escape' && isOpen) {
        onClose();
      }
    };

    document.addEventListener('keydown', handleEscape);
    return () => document.removeEventListener('keydown', handleEscape);
  }, [isOpen, onClose]);

  /**
   * Prevent body scroll when modal is open
   */
  useEffect(() => {
    if (isOpen) {
      const originalStyle = window.getComputedStyle(document.body).overflow;
      document.body.style.overflow = 'hidden';
      return () => {
        document.body.style.overflow = originalStyle;
      };
    }
  }, [isOpen]);

  // ============================================================
  // Validation
  // ============================================================
  const validateHealthForm = useCallback((): boolean => {
    const newErrors: FormErrors = {};

    if (!healthForm.condition.trim()) {
      newErrors.condition = 'Condition is required';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  }, [healthForm.condition]);

  const validateVulnerabilityForm = useCallback((): boolean => {
    const newErrors: FormErrors = {};

    if (!vulnerabilityForm.description.trim()) {
      newErrors.description = 'Description is required';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  }, [vulnerabilityForm.description]);

  /**
   * Validate field on blur
   */
  const handleBlur = useCallback((field: 'condition' | 'description') => {
    setTouched(prev => ({ ...prev, [field]: true }));

    if (field === 'condition') {
      if (!healthForm.condition.trim()) {
        setErrors(prev => ({ ...prev, condition: 'Condition is required' }));
      } else {
        setErrors(prev => {
          const { condition, ...rest } = prev;
          return rest;
        });
      }
    }

    if (field === 'description') {
      if (!vulnerabilityForm.description.trim()) {
        setErrors(prev => ({ ...prev, description: 'Description is required' }));
      } else {
        setErrors(prev => {
          const { description, ...rest } = prev;
          return rest;
        });
      }
    }
  }, [healthForm.condition, vulnerabilityForm.description]);

  // ============================================================
  // Form Change Handlers
  // ============================================================
  const handleHealthChange = useCallback((field: keyof HealthFormState, value: string) => {
    setHealthForm(prev => ({ ...prev, [field]: value }));

    // Clear error when user enters valid value
    if (field === 'condition' && value.trim()) {
      setErrors(prev => {
        const { condition, ...rest } = prev;
        return rest;
      });
    }
  }, []);

  const handleVulnerabilityChange = useCallback((
    field: keyof VulnerabilityFormState,
    value: string | boolean
  ) => {
    setVulnerabilityForm(prev => ({ ...prev, [field]: value }));

    // Clear error when user enters valid value
    if (field === 'description' && typeof value === 'string' && value.trim()) {
      setErrors(prev => {
        const { description, ...rest } = prev;
        return rest;
      });
    }
  }, []);

  // ============================================================
  // Form Submission
  // ============================================================
  const handleSubmit = useCallback(async () => {
    // Clear previous announcements
    setAnnouncement({ message: '', type: null });

    // Validate based on tab type
    const isValid = tabType === 'health' ? validateHealthForm() : validateVulnerabilityForm();

    if (!isValid) {
      // Mark fields as touched to show errors
      if (tabType === 'health') {
        setTouched({ condition: true });
      } else {
        setTouched({ description: true });
      }
      return;
    }

    try {
      if (tabType === 'health') {
        // Build health update payload
        const data: HealthConditionUpdate = {
          condition: healthForm.condition,
          status: healthForm.status,
          name: healthForm.name.trim() || null,
          date_of_diagnosis: healthForm.date_of_diagnosis || null,
          medication: healthForm.medication.trim() || null,
          notes: healthForm.notes.trim() || null,
        };

        await updateHealth.mutateAsync({
          id: record.id,
          data,
          personType: person.personType,
        });
      } else {
        // Build vulnerability update payload
        const data: VulnerabilityUpdate = {
          description: vulnerabilityForm.description,
          status: vulnerabilityForm.status,
          diagnosed: vulnerabilityForm.diagnosed,
          adjustments: vulnerabilityForm.adjustments.trim() || null,
          notes: vulnerabilityForm.notes.trim() || null,
        };

        await updateVulnerability.mutateAsync({
          id: record.id,
          data,
          personType: person.personType,
        });
      }

      // Announce success
      setAnnouncement({
        message: tabType === 'health' ? 'Health condition updated successfully' : 'Vulnerability updated successfully',
        type: 'success',
      });

      // Call success callback and close modal
      onSuccess();
      onClose();
    } catch (error: unknown) {
      // Log technical error details for debugging
      console.error('Save error:', error);
      // Display generic user-facing message to avoid exposing technical details
      setAnnouncement({
        message: 'Failed to save. Please try again.',
        type: 'error',
      });
    }
  }, [
    tabType,
    healthForm,
    vulnerabilityForm,
    person,
    record.id,
    validateHealthForm,
    validateVulnerabilityForm,
    updateHealth,
    updateVulnerability,
    onSuccess,
    onClose,
  ]);

  // ============================================================
  // Memoized Values
  // ============================================================
  const modalTitle = useMemo(
    () => tabType === 'health'
      ? `Edit Health Condition for ${person.name}`
      : `Edit Vulnerability for ${person.name}`,
    [tabType, person.name]
  );

  /**
   * Handle backdrop click - memoized to prevent unnecessary re-renders
   */
  const handleBackdropClick = useCallback((event: React.MouseEvent<HTMLDivElement>) => {
    if (event.target === event.currentTarget) {
      onClose();
    }
  }, [onClose]);

  // ============================================================
  // Render
  // ============================================================
  if (!isOpen) {
    return null;
  }

  return (
    <FocusTrap
      active={isOpen}
      focusTrapOptions={{
        allowOutsideClick: true,
        escapeDeactivates: false,
        clickOutsideDeactivates: false,
        initialFocus: false,
        fallbackFocus: () => cancelButtonRef.current || modalRef.current || document.body,
        returnFocusOnDeactivate: true,
        delayInitialFocus: false,
        // Use displayCheck: 'none' for compatibility with jsdom in tests
        tabbableOptions: {
          displayCheck: 'none',
        },
      }}
    >
      <div
        onClick={handleBackdropClick}
        className="fixed inset-0 z-50 flex items-start justify-center overflow-y-auto bg-gray-900 bg-opacity-50 py-8"
        data-testid="modal-backdrop"
        role="dialog"
        aria-modal="true"
        aria-labelledby={titleId}
      >
        <div
          ref={modalRef}
          className="relative w-full max-w-lg mx-4 my-auto bg-white rounded-lg shadow-xl"
          onClick={(e) => e.stopPropagation()}
        >
          {/* Header */}
          <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200">
            <h2 id={titleId} className="text-lg font-semibold text-gray-900">
              {modalTitle}
            </h2>
            <button
              type="button"
              onClick={onClose}
              className="text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded"
              aria-label="Close modal"
            >
              <XMarkIcon className="h-5 w-5" />
            </button>
          </div>

          {/* Form Content */}
          <div className="px-6 py-4">
            {/* Aria-live region for success announcements */}
            {announcement.type === 'success' && (
              <div
                role="status"
                aria-live="polite"
                className="mb-4 p-3 bg-green-50 border border-green-200 rounded-md text-green-700 text-sm"
              >
                {announcement.message}
              </div>
            )}

            {/* Aria-live region for error announcements */}
            {announcement.type === 'error' && (
              <div
                role="alert"
                aria-live="assertive"
                className="mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-700 text-sm"
              >
                {announcement.message}
              </div>
            )}

            {/* Health Form */}
            {tabType === 'health' && (
              <div className="space-y-4">
                {/* Condition (Required) */}
                <div>
                  <label htmlFor="condition" className={LABEL_CLASSES}>
                    Condition <span className="text-red-500">*</span>
                  </label>
                  <select
                    id="condition"
                    value={healthForm.condition}
                    onChange={(e) => handleHealthChange('condition', e.target.value)}
                    onBlur={() => handleBlur('condition')}
                    disabled={isPending}
                    className={getInputClasses(Boolean(errors.condition && touched.condition), isPending)}
                    aria-describedby={errors.condition && touched.condition ? 'condition-error' : undefined}
                    aria-invalid={Boolean(errors.condition && touched.condition)}
                  >
                    <option value="">Select a condition</option>
                    {CONDITION_TYPES.map((type) => (
                      <option key={type} value={type}>
                        {type}
                      </option>
                    ))}
                  </select>
                  {errors.condition && touched.condition && (
                    <p id="condition-error" className="mt-1 text-sm text-red-600">{errors.condition}</p>
                  )}
                </div>

                {/* Name (Optional) */}
                <div>
                  <label htmlFor="health-name" className={LABEL_CLASSES}>
                    Name
                  </label>
                  <input
                    type="text"
                    id="health-name"
                    value={healthForm.name}
                    onChange={(e) => handleHealthChange('name', e.target.value)}
                    disabled={isPending}
                    className={getInputClasses(false, isPending)}
                    placeholder="e.g., Type 2 Diabetes"
                    maxLength={HEALTH_FIELD_LIMITS.name}
                  />
                </div>

                {/* Date of Diagnosis (Optional) */}
                <div>
                  <label htmlFor="date-diagnosed" className={LABEL_CLASSES}>
                    Date Diagnosed
                  </label>
                  <input
                    type="date"
                    id="date-diagnosed"
                    value={healthForm.date_of_diagnosis}
                    onChange={(e) => handleHealthChange('date_of_diagnosis', e.target.value)}
                    disabled={isPending}
                    className={getInputClasses(false, isPending)}
                    max={new Date().toISOString().split('T')[0]}
                  />
                </div>

                {/* Medication (Optional) */}
                <div>
                  <label htmlFor="medication" className={LABEL_CLASSES}>
                    Medication
                  </label>
                  <input
                    type="text"
                    id="medication"
                    value={healthForm.medication}
                    onChange={(e) => handleHealthChange('medication', e.target.value)}
                    disabled={isPending}
                    className={getInputClasses(false, isPending)}
                    placeholder="e.g., Metformin 500mg twice daily"
                    maxLength={HEALTH_FIELD_LIMITS.medication}
                  />
                </div>

                {/* Status */}
                <div>
                  <label htmlFor="health-status" className={LABEL_CLASSES}>
                    Status
                  </label>
                  <select
                    id="health-status"
                    value={healthForm.status}
                    onChange={(e) => handleHealthChange('status', e.target.value as HealthVulnerabilityStatus)}
                    disabled={isPending}
                    className={getInputClasses(false, isPending)}
                  >
                    {STATUS_OPTIONS.map((status) => (
                      <option key={status} value={status}>
                        {status}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Notes (Optional) */}
                <div>
                  <label htmlFor="health-notes" className={LABEL_CLASSES}>
                    Notes
                  </label>
                  <textarea
                    id="health-notes"
                    value={healthForm.notes}
                    onChange={(e) => handleHealthChange('notes', e.target.value)}
                    disabled={isPending}
                    rows={3}
                    className={getInputClasses(false, isPending)}
                    placeholder="Additional notes about this condition"
                    maxLength={HEALTH_FIELD_LIMITS.notes}
                  />
                </div>
              </div>
            )}

            {/* Vulnerability Form */}
            {tabType === 'vulnerabilities' && (
              <div className="space-y-4">
                {/* Description (Required) */}
                <div>
                  <label htmlFor="description" className={LABEL_CLASSES}>
                    Description <span className="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="description"
                    value={vulnerabilityForm.description}
                    onChange={(e) => handleVulnerabilityChange('description', e.target.value)}
                    onBlur={() => handleBlur('description')}
                    disabled={isPending}
                    className={getInputClasses(Boolean(errors.description && touched.description), isPending)}
                    placeholder="e.g., Cognitive decline affecting financial decisions"
                    maxLength={VULNERABILITY_FIELD_LIMITS.description}
                    aria-describedby={errors.description && touched.description ? 'description-error' : undefined}
                    aria-invalid={Boolean(errors.description && touched.description)}
                  />
                  {errors.description && touched.description && (
                    <p id="description-error" className="mt-1 text-sm text-red-600">{errors.description}</p>
                  )}
                </div>

                {/* Adjustments (Optional) */}
                <div>
                  <label htmlFor="adjustments" className={LABEL_CLASSES}>
                    Adjustments
                  </label>
                  <input
                    type="text"
                    id="adjustments"
                    value={vulnerabilityForm.adjustments}
                    onChange={(e) => handleVulnerabilityChange('adjustments', e.target.value)}
                    disabled={isPending}
                    className={getInputClasses(false, isPending)}
                    placeholder="e.g., Involve family in discussions"
                    maxLength={VULNERABILITY_FIELD_LIMITS.adjustments}
                  />
                </div>

                {/* Professionally Diagnosed (Checkbox) */}
                <div className="flex items-center">
                  <input
                    type="checkbox"
                    id="professionally-diagnosed"
                    checked={vulnerabilityForm.diagnosed}
                    onChange={(e) => handleVulnerabilityChange('diagnosed', e.target.checked)}
                    disabled={isPending}
                    className={`h-4 w-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500 ${
                      isPending ? 'cursor-not-allowed' : ''
                    }`}
                  />
                  <label htmlFor="professionally-diagnosed" className="ml-2 text-sm font-medium text-gray-700">
                    Professionally Diagnosed
                  </label>
                </div>

                {/* Status */}
                <div>
                  <label htmlFor="vulnerability-status" className={LABEL_CLASSES}>
                    Status
                  </label>
                  <select
                    id="vulnerability-status"
                    value={vulnerabilityForm.status}
                    onChange={(e) => handleVulnerabilityChange('status', e.target.value as HealthVulnerabilityStatus)}
                    disabled={isPending}
                    className={getInputClasses(false, isPending)}
                  >
                    {STATUS_OPTIONS.map((status) => (
                      <option key={status} value={status}>
                        {status}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Notes (Optional) */}
                <div>
                  <label htmlFor="vulnerability-notes" className={LABEL_CLASSES}>
                    Notes
                  </label>
                  <textarea
                    id="vulnerability-notes"
                    value={vulnerabilityForm.notes}
                    onChange={(e) => handleVulnerabilityChange('notes', e.target.value)}
                    disabled={isPending}
                    rows={3}
                    className={getInputClasses(false, isPending)}
                    placeholder="Additional notes about this vulnerability"
                    maxLength={VULNERABILITY_FIELD_LIMITS.notes}
                  />
                </div>
              </div>
            )}
          </div>

          {/* Footer with action buttons */}
          <div className="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
            <button
              ref={cancelButtonRef}
              type="button"
              onClick={onClose}
              disabled={isPending}
              className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Cancel
            </button>
            <button
              type="button"
              onClick={handleSubmit}
              onKeyDown={(e) => {
                if (e.key === 'Enter') {
                  e.preventDefault();
                  handleSubmit();
                }
              }}
              disabled={isPending}
              className="px-4 py-2 text-sm font-medium text-white bg-primary-600 border border-transparent rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {isPending ? 'Saving...' : 'Save'}
            </button>
          </div>
        </div>
      </div>
    </FocusTrap>
  );
};

export default EditHealthVulnerabilityModal;
