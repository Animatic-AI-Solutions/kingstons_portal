-- =========================================================
-- Drop Existing Objects (Updated List)
-- =========================================================
-- Drop Views first to remove dependencies
DROP VIEW IF EXISTS public.portfolio_fund_providers CASCADE; -- View depends on removed product_funds
DROP VIEW IF EXISTS public.latest_irr_values CASCADE;
DROP VIEW IF EXISTS public.latest_fund_valuations CASCADE;
DROP VIEW IF EXISTS public.client_fum_summary CASCADE; -- Old view to be replaced
DROP VIEW IF EXISTS public.client_group_fum_summary CASCADE; -- New view based on client_groups
DROP VIEW IF EXISTS public.product_value_irr_summary CASCADE;
DROP VIEW IF EXISTS public.product_owner_details CASCADE; -- New view for product owners

-- Drop Tables (Order matters for FKs, CASCADE helps)
DROP TABLE IF EXISTS public.holding_activity_log CASCADE;
DROP TABLE IF EXISTS public.irr_values CASCADE;
DROP TABLE IF EXISTS public.fund_valuations CASCADE;
DROP TABLE IF EXISTS public.product_holdings CASCADE; -- New name
DROP TABLE IF EXISTS public.product_owner_products CASCADE; -- New junction table
DROP TABLE IF EXISTS public.client_group_product_owners CASCADE; -- New junction table
DROP TABLE IF EXISTS public.portfolio_funds CASCADE;
DROP TABLE IF EXISTS public.available_portfolio_funds CASCADE;
DROP TABLE IF EXISTS public.client_products CASCADE; -- New name
DROP TABLE IF EXISTS public.product_funds CASCADE; -- Removed table
DROP TABLE IF EXISTS public.available_funds CASCADE;
DROP TABLE IF EXISTS public.portfolios CASCADE;
DROP TABLE IF EXISTS public.available_portfolios CASCADE;
DROP TABLE IF EXISTS public.available_products CASCADE; -- Removed table
DROP TABLE IF EXISTS public.session CASCADE; -- Corrected name if 'sessions' was typo
DROP TABLE IF EXISTS public.authentication CASCADE;
DROP TABLE IF EXISTS public.available_providers CASCADE;
DROP TABLE IF EXISTS public.product_owners CASCADE; -- New table
DROP TABLE IF EXISTS public.client_groups CASCADE; -- Renamed from clients
DROP TABLE IF EXISTS public.clients CASCADE; -- Old table name, kept for backward compatibility
DROP TABLE IF EXISTS public.profiles CASCADE;
DROP TABLE IF EXISTS public.fund_performance_history CASCADE; -- Removed table

-- =========================================================
-- Level 1 Tables (Generally no FK dependencies)
-- =========================================================

CREATE TABLE public.profiles (
    id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at timestamp WITH time zone NOT NULL DEFAULT now(),
    first_name text NULL,
    last_name text NULL,
    email text NULL,
    profile_picture_url text NULL DEFAULT '/images/Companylogo2.png'::text,
    preferred_client_view text NULL DEFAULT 'list'::text,
    preferred_landing_page text NULL DEFAULT '/'::text,
    CONSTRAINT profiles_pkey PRIMARY KEY (id) -- Renamed constraint for consistency
) TABLESPACE pg_default;

CREATE TABLE public.available_providers (
    id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    name text NULL,
    status text NOT NULL DEFAULT 'active'::text,
    created_at timestamp WITH time zone NOT NULL DEFAULT now(),
    theme_color text NULL,
    CONSTRAINT available_providers_pkey PRIMARY KEY (id)
) TABLESPACE pg_default;

-- Replaced with client_groups
CREATE TABLE public.client_groups (
  id bigint generated by default as identity not null,
  advisor text null,
  status text null default 'active'::text,
  created_at timestamp with time zone not null default now(),
  name text null,
  type text null default 'Family'::text,
  constraint clients_pkey primary key (id)
) TABLESPACE pg_default;

-- New product_owners table
CREATE TABLE public.product_owners (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  status text null default 'active'::text,
  name text null,
  constraint product_owners_pkey primary key (id)
) TABLESPACE pg_default;

CREATE TABLE public.available_funds (
    id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    fund_name text NULL,
    isin_number text NULL,
    risk_factor smallint NULL,
    fund_cost numeric(6, 2) NULL,
    status text NULL DEFAULT 'active'::text,
    created_at timestamp WITH time zone NOT NULL DEFAULT now(),
    CONSTRAINT available_funds_pkey PRIMARY KEY (id),
    CONSTRAINT available_funds_isin_number_key UNIQUE (isin_number)
) TABLESPACE pg_default;

-- Portfolio templates (Removed link to available_products)
CREATE TABLE public.available_portfolios (
    id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at timestamp WITH time zone NOT NULL DEFAULT now(),
    name text NULL,
    CONSTRAINT available_portfolios_pkey PRIMARY KEY (id)
) TABLESPACE pg_default;

-- =========================================================
-- Level 2 Tables (Depend on Level 1)
-- =========================================================

CREATE TABLE public.authentication (
    auth_id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at timestamp WITH time zone NOT NULL DEFAULT now(),
    password_hash text NULL,
    last_login timestamp WITH time zone NULL,
    updated_at timestamp WITH time zone NULL,
    profiles_id bigint NULL,
    CONSTRAINT authentication_pkey PRIMARY KEY (auth_id),
    CONSTRAINT authentication_profiles_id_fkey FOREIGN KEY (profiles_id) REFERENCES public.profiles (id)
) TABLESPACE pg_default;

CREATE TABLE public.session (
    session_id text NOT NULL,
    profiles_id bigint NULL,
    created_at timestamp WITH time zone NOT NULL DEFAULT now(),
    expires_at timestamp WITH time zone NULL,
    last_activity timestamp WITH time zone NULL,
    CONSTRAINT session_pkey PRIMARY KEY (session_id),
    CONSTRAINT session_profiles_id_fkey FOREIGN KEY (profiles_id) REFERENCES public.profiles (id)
) TABLESPACE pg_default;

-- Junction table between client_groups and product_owners
CREATE TABLE public.client_group_product_owners (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  product_owner_id bigint null,
  client_group_id bigint null,
  constraint client_group_product_owners_pkey primary key (id),
  constraint client_group_product_owners_client_group_id_fkey foreign KEY (client_group_id) references client_groups (id),
  constraint client_group_product_owners_product_owner_id_fkey foreign KEY (product_owner_id) references product_owners (id)
) TABLESPACE pg_default;

-- Portfolio instances (Added link back to template)
CREATE TABLE public.portfolios (
    id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    portfolio_name text NULL,
    status text NULL DEFAULT 'active'::text,
    start_date date NULL,
    end_date date NULL,
    created_at timestamp WITH time zone NOT NULL DEFAULT now(),
    original_template_id bigint NULL, -- Added FK
    CONSTRAINT portfolios_pkey PRIMARY KEY (id),
    CONSTRAINT portfolios_original_template_id_fkey FOREIGN KEY (original_template_id) REFERENCES public.available_portfolios (id) -- Constraint for added FK
) TABLESPACE pg_default;

-- Funds associated with portfolio templates
CREATE TABLE public.available_portfolio_funds (
    id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at timestamp WITH time zone NOT NULL DEFAULT now(),
    portfolio_id bigint NULL, -- FK to available_portfolios
    fund_id bigint NULL, -- FK to available_funds
    target_weighting numeric(5, 2) NULL, -- Note: This table still uses target_weighting, contrast with portfolio_funds below
    CONSTRAINT available_portfolio_funds_pkey PRIMARY KEY (id),
    CONSTRAINT available_portfolio_funds_fund_id_fkey FOREIGN KEY (fund_id) REFERENCES public.available_funds (id),
    CONSTRAINT available_portfolio_funds_portfolio_id_fkey FOREIGN KEY (portfolio_id) REFERENCES public.available_portfolios (id)
) TABLESPACE pg_default;

-- =========================================================
-- Level 3 Tables (Depend on Levels 1 & 2)
-- =========================================================

-- Replaced client_accounts, now client relationship managed through product_owners
-- Note: foreign key updated from clients to client_groups
create table public.client_products (
  id bigint generated by default as identity not null,
  client_id bigint not null,
  product_name text null,
  status text not null default 'active'::text,
  start_date date not null,
  end_date date null,
  weighting numeric(5, 2) null,
  created_at timestamp with time zone not null default now(),
  plan_number text null,
  provider_id bigint null,
  product_type text null,
  portfolio_id bigint null,
  constraint client_products_pkey primary key (id),
  constraint client_products_client_id_fkey foreign KEY (client_id) references client_groups (id),
  constraint client_products_portfolio_id_fkey foreign KEY (portfolio_id) references portfolios (id),
  constraint client_products_provider_id_fkey foreign KEY (provider_id) references available_providers (id)
) TABLESPACE pg_default;

-- Junction table between product_owners and products
CREATE TABLE public.product_owner_products (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  product_owner_id bigint null,
  product_id bigint null,
  constraint product_owner_products_pkey primary key (id),
  constraint product_owner_products_product_id_fkey foreign KEY (product_id) references client_products (id),
  constraint product_owner_products_product_owner_id_fkey foreign KEY (product_owner_id) references product_owners (id)
) TABLESPACE pg_default;

create index IF not exists idx_client_products_client_id on public.client_products using btree (client_id) TABLESPACE pg_default;

create index IF not exists idx_client_products_status on public.client_products using btree (status) TABLESPACE pg_default;

create index IF not exists idx_client_products_start_date on public.client_products using btree (start_date) TABLESPACE pg_default;

create index IF not exists idx_client_products_provider_id on public.client_products using btree (provider_id) TABLESPACE pg_default
where
  (provider_id is not null);

-- *** NEW definition for portfolio_funds as requested ***
-- Funds within specific portfolio instances (weighting column renamed from target_weighting)
create table public.portfolio_funds (
  id bigint generated by default as identity not null,
  portfolio_id bigint not null,
  available_funds_id bigint not null,
  weighting numeric(5, 2) null,
  start_date date not null,
  end_date date null,
  created_at timestamp with time zone not null default now(),
  amount_invested numeric(16, 2) null,
  status text null default 'active'::text,
  constraint portfolio_funds_pkey primary key (id),
  constraint portfolio_funds_available_funds_id_fkey foreign KEY (available_funds_id) references available_funds (id),
  constraint portfolio_funds_portfolio_id_fkey foreign KEY (portfolio_id) references portfolios (id)
) TABLESPACE pg_default;

create index IF not exists idx_portfolio_funds_portfolio_id on public.portfolio_funds using btree (portfolio_id) TABLESPACE pg_default;

create index IF not exists idx_portfolio_funds_available_funds on public.portfolio_funds using btree (available_funds_id) TABLESPACE pg_default;

create index IF not exists idx_portfolio_funds_amount_invested on public.portfolio_funds using btree (amount_invested) TABLESPACE pg_default;

create index IF not exists idx_portfolio_funds_status on public.portfolio_funds using btree (end_date) TABLESPACE pg_default;

create index IF not exists idx_portfolio_funds_dates_status on public.portfolio_funds using btree (start_date, end_date) TABLESPACE pg_default;
-- *** END NEW definition for portfolio_funds ***

-- =========================================================
-- Level 4 Tables (Depend on Level 3)
-- =========================================================

-- Valuations of specific funds within portfolio instances
CREATE TABLE public.fund_valuations (
    id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    portfolio_fund_id bigint NOT NULL, -- FK to portfolio_funds
    valuation_date timestamp WITHOUT time zone NOT NULL,
    value numeric(16, 2) NOT NULL,
    created_at timestamp WITH time zone NOT NULL DEFAULT now(),
    CONSTRAINT fund_valuations_pkey PRIMARY KEY (id),
    CONSTRAINT fund_valuations_portfolio_fund_id_fkey FOREIGN KEY (portfolio_fund_id) REFERENCES public.portfolio_funds (id)
) TABLESPACE pg_default;

-- =========================================================
-- Level 5 Tables (Depend on Level 4)
-- =========================================================


-- Activity log, references product_holdings now
create table public.holding_activity_log (
  id bigint generated by default as identity not null,
  product_id bigint not null,
  portfolio_fund_id bigint not null,
  activity_timestamp date not null,
  activity_type text not null,
  amount numeric(16, 2) null,
  created_at timestamp with time zone not null default now(),
  related_fund bigint null,
  constraint holding_activity_log_pkey primary key (id),
  constraint holding_activity_log_portfolio_fund_id_fkey foreign KEY (portfolio_fund_id) references portfolio_funds (id),
  constraint holding_activity_log_related_fund_fkey foreign KEY (related_fund) references portfolio_funds (id)
) TABLESPACE pg_default;

create index IF not exists idx_holding_activity_log_type_date on public.holding_activity_log using btree (activity_type, activity_timestamp) TABLESPACE pg_default;

create index IF not exists idx_holding_activity_log_product_holding on public.holding_activity_log using btree (product_id) TABLESPACE pg_default;

CREATE TABLE public.irr_values (
    id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    irr_result numeric(7, 2) NULL,
    created_at timestamp WITH time zone NOT NULL DEFAULT now(),
    date timestamp WITHOUT time zone NULL,
    fund_id bigint NULL, -- FK to portfolio_funds
    fund_valuation_id bigint NULL, -- FK to fund_valuations
    CONSTRAINT irr_values_pkey PRIMARY KEY (id),
    CONSTRAINT irr_values_fund_id_fkey FOREIGN KEY (fund_id) REFERENCES public.portfolio_funds (id),
    CONSTRAINT irr_values_fund_valuation_id_fkey FOREIGN KEY (fund_valuation_id) REFERENCES public.fund_valuations (id)

) TABLESPACE pg_default;

-- =========================================================
-- Indexes (Updated List)
-- =========================================================


-- Indexes for client_products
CREATE INDEX IF NOT EXISTS idx_client_products_client_id ON public.client_products USING btree (client_id) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_client_products_status ON public.client_products USING btree (status) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_client_products_start_date ON public.client_products USING btree (start_date) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_client_products_provider_id ON public.client_products USING btree (provider_id) TABLESPACE pg_default WHERE (provider_id IS NOT NULL);

-- Indexes for client_groups
CREATE INDEX IF NOT EXISTS idx_client_groups_status ON public.client_groups USING btree (status) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_client_groups_advisor ON public.client_groups USING btree (advisor) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_client_groups_name ON public.client_groups USING btree (name) TABLESPACE pg_default;

-- Indexes for product_owners
CREATE INDEX IF NOT EXISTS idx_product_owners_status ON public.product_owners USING btree (status) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_product_owners_name ON public.product_owners USING btree (name) TABLESPACE pg_default;

-- Indexes for junction tables
CREATE INDEX IF NOT EXISTS idx_client_group_product_owners_client_group_id ON public.client_group_product_owners USING btree (client_group_id) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_client_group_product_owners_product_owner_id ON public.client_group_product_owners USING btree (product_owner_id) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_product_owner_products_product_owner_id ON public.product_owner_products USING btree (product_owner_id) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_product_owner_products_product_id ON public.product_owner_products USING btree (product_id) TABLESPACE pg_default;

-- Indexes for product_holdings
CREATE INDEX IF NOT EXISTS idx_product_holdings_client_product_id ON public.product_holdings USING btree (client_product_id) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_product_holdings_portfolio_id ON public.product_holdings USING btree (portfolio_id) TABLESPACE pg_default WHERE (portfolio_id IS NOT NULL);
CREATE INDEX IF NOT EXISTS idx_product_holdings_status_dates ON public.product_holdings USING btree (status, start_date, end_date) TABLESPACE pg_default;

-- Indexes for holding_activity_log
CREATE INDEX IF NOT EXISTS idx_holding_activity_log_type_date ON public.holding_activity_log USING btree (activity_type, activity_timestamp) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_holding_activity_log_product_holding ON public.holding_activity_log USING btree (product_id) TABLESPACE pg_default;

-- Indexes for portfolios
CREATE INDEX IF NOT EXISTS idx_portfolios_start_date ON public.portfolios USING btree (start_date) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_portfolios_original_template_id ON public.portfolios USING btree (original_template_id) TABLESPACE pg_default WHERE (original_template_id IS NOT NULL);

-- *** NEW Indexes for portfolio_funds as requested ***
CREATE INDEX IF NOT EXISTS idx_portfolio_funds_available_funds ON public.portfolio_funds USING btree (available_funds_id) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_portfolio_funds_amount_invested ON public.portfolio_funds USING btree (amount_invested) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_portfolio_funds_status ON public.portfolio_funds USING btree (end_date) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_portfolio_funds_dates_status ON public.portfolio_funds USING btree (start_date, end_date) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_portfolio_funds_portfolio_id ON public.portfolio_funds (portfolio_id);
-- *** END NEW Indexes for portfolio_funds ***

-- Indexes for fund_valuations
CREATE UNIQUE INDEX IF NOT EXISTS idx_fund_valuations_unique ON public.fund_valuations (portfolio_fund_id, valuation_date) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_fund_valuations_date ON public.fund_valuations USING btree (valuation_date DESC) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_fund_valuations_portfolio_fund_date ON public.fund_valuations USING btree (portfolio_fund_id, valuation_date DESC) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_fund_valuations_value ON public.fund_valuations USING btree (value) TABLESPACE pg_default;
-- Removed potentially redundant index: idx_fund_valuations_fund_date

-- Indexes for irr_values
CREATE INDEX IF NOT EXISTS idx_irr_values_date ON public.irr_values USING btree (fund_id, date DESC) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_irr_values_fund_date_value ON public.irr_values USING btree (fund_id, date DESC, irr_result) TABLESPACE pg_default; -- Corrected column name
CREATE INDEX IF NOT EXISTS idx_irr_values_fund_valuation_id ON public.irr_values USING btree (fund_valuation_id) TABLESPACE pg_default;

-- Indexes for available_funds
CREATE INDEX IF NOT EXISTS idx_available_funds_status ON public.available_funds USING btree (status) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_available_funds_reporting ON public.available_funds USING btree (id, fund_name, status) TABLESPACE pg_default;

-- Indexes for available_portfolio_funds
CREATE INDEX IF NOT EXISTS idx_available_portfolio_funds_portfolio_id ON public.available_portfolio_funds USING btree (portfolio_id) TABLESPACE pg_default WHERE (portfolio_id IS NOT NULL);


-- Text Search Indexes (Optional - requires pg_trgm extension enabled by superuser)
-- CREATE EXTENSION IF NOT EXISTS pg_trgm;
-- CREATE INDEX IF NOT EXISTS idx_client_groups_name_trigram ON public.client_groups USING gin (name gin_trgm_ops);
-- CREATE INDEX IF NOT EXISTS idx_product_owners_name_trigram ON public.product_owners USING gin (name gin_trgm_ops);
-- CREATE INDEX IF NOT EXISTS idx_available_funds_name_trigram ON public.available_funds USING gin (fund_name gin_trgm_ops);


-- =========================================================
-- Views (Updated List)
-- =========================================================

-- View for latest IRR values (Corrected column reference)
CREATE OR REPLACE VIEW public.latest_irr_values AS
SELECT DISTINCT ON (irr_values.fund_id)
    irr_values.fund_id,
    irr_values.irr_result AS irr_value,
    irr_values.date AS irr_date,
    irr_values.fund_valuation_id
FROM
    public.irr_values
ORDER BY
    irr_values.fund_id,
    irr_values.date DESC;

-- View for latest fund valuations
CREATE VIEW public.latest_fund_valuations AS
SELECT DISTINCT
    ON (fund_valuations.portfolio_fund_id) fund_valuations.id,
    fund_valuations.portfolio_fund_id,
    fund_valuations.valuation_date,
    fund_valuations.value
FROM
    public.fund_valuations
ORDER BY
    fund_valuations.portfolio_fund_id,
    fund_valuations.valuation_date DESC;

CREATE OR REPLACE VIEW public.product_value_irr_summary AS
SELECT
    cp.id AS client_product_id,
    -- Total value: sum of latest valuations for each fund
    SUM(lfv.value) AS total_value,
    -- Weighted IRR: sum(value_at_irr * irr) / sum(value_at_irr)
    CASE
        WHEN SUM(fv_at_irr.value) > 0 THEN
            SUM(fv_at_irr.value * COALESCE(liv.irr_value, 0)) / SUM(fv_at_irr.value)
        ELSE NULL
    END AS irr_weighted
FROM
    client_products cp
    -- Link to all funds in the product's portfolio
    LEFT JOIN portfolio_funds pf ON pf.portfolio_id = cp.portfolio_id
    -- Get the latest valuation for each fund
    LEFT JOIN latest_fund_valuations lfv ON lfv.portfolio_fund_id = pf.id
    -- Get the latest IRR for each fund
    LEFT JOIN latest_irr_values liv ON liv.fund_id = pf.id
    -- Get the fund_valuation record associated with the IRR (value at the IRR date)
    LEFT JOIN fund_valuations fv_at_irr ON fv_at_irr.id = liv.fund_valuation_id
GROUP BY
    cp.id;

-- Updated view to use client_groups instead of clients
CREATE OR REPLACE VIEW public.client_group_fum_summary AS
SELECT
    cg.id AS client_group_id,
    COALESCE(SUM(pvis.total_value), 0) AS fum
FROM
    client_groups cg
    LEFT JOIN client_products cp ON cp.client_id = cg.id
    LEFT JOIN product_value_irr_summary pvis ON cp.id = pvis.client_product_id
GROUP BY
    cg.id;

-- View to get product owners with their products
CREATE OR REPLACE VIEW public.product_owner_details AS
SELECT
    po.id AS product_owner_id,
    po.name AS product_owner_name,
    po.status AS product_owner_status,
    cp.id AS product_id,
    cp.product_name,
    cp.product_type,
    cp.start_date,
    cp.end_date,
    cp.status AS product_status,
    pvis.total_value,
    pvis.irr_weighted
FROM
    product_owners po
    LEFT JOIN product_owner_products pop ON pop.product_owner_id = po.id
    LEFT JOIN client_products cp ON cp.id = pop.product_id
    LEFT JOIN product_value_irr_summary pvis ON cp.id = pvis.client_product_id;

-- =========================================================
-- End of Script
-- =========================================================